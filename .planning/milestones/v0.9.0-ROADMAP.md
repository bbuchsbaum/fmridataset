# Milestone v0.9.0: CRAN-Ready

**Status:** SHIPPED 2026-01-22
**Phases:** 1-5
**Total Plans:** 15

## Overview

Transform fmridataset from feature-complete to CRAN-ready by fixing R CMD check issues, resolving tech debt in H5 backend, deciding on Zarr viability, and achieving high test coverage. Five focused phases moved from quick compliance wins through infrastructure fixes to comprehensive testing, culminating in final CRAN validation.

## Phases

### Phase 1: CRAN Quick Wins

**Goal**: R CMD check runs cleanly except for final validation requirements
**Depends on**: Nothing (first phase)
**Plans**: 3 plans

Plans:
- [x] 01-01-PLAN.md - Add missing test and vignette dependencies to DESCRIPTION
- [x] 01-02-PLAN.md - Fix golden_data architecture and sampling_frame cross-reference
- [x] 01-03-PLAN.md - Update .Rbuildignore for non-standard files

**Details:**
- Added 8 missing dependencies to DESCRIPTION Suggests (DelayedArray, devtools, iterators, microbenchmark, pryr, rhdf5, withr)
- Fixed undefined global `generate_all_golden_data` by deleting orphaned file
- Fixed Rd cross-reference using `fmrihrf::sampling_frame()` syntax
- Updated .Rbuildignore with proper regex patterns

### Phase 2: Tech Debt

**Goal**: H5 backend has proper resource management and storage_backend fix is committed
**Depends on**: Phase 1
**Plans**: 2 plans

Plans:
- [x] 02-01-PLAN.md - Add on.exit() resource protection to H5 backend functions
- [x] 02-02-PLAN.md - Commit storage_backend.R getS3method fix

**Details:**
- Added on.exit() cleanup handlers to 6 locations in h5_backend.R
- Fixed utils::getS3method() usage in storage_backend.R
- Ensured H5 handles are closed even when errors occur

### Phase 3: Zarr Decision

**Goal**: Zarr backend viability determined with go/no-go decision
**Depends on**: Phase 2
**Plans**: 2 plans

Plans:
- [x] 03-01-PLAN.md - Investigate Zarr packages (CRAN zarr vs Rarr) with testing and benchmarks
- [x] 03-02-PLAN.md - Document decision and implement chosen path (migrate to CRAN zarr)

**Details:**
- Evaluated both CRAN zarr and Bioconductor Rarr packages
- Decision: Migrate to CRAN zarr (pure CRAN dependency, working API)
- Zarr v3-only limitation documented
- Backend marked EXPERIMENTAL (zarr package is v0.1.1)
- Simplified to single-array stores (removed data_key/mask_key parameters)

### Phase 4: Test Coverage

**Goal**: Package achieves high overall test coverage with all critical backends covered
**Depends on**: Phase 3
**Plans**: 5 plans

Plans:
- [x] 04-01-PLAN.md - Create test helpers and zarr_backend tests
- [x] 04-02-PLAN.md - Create h5_backend tests
- [x] 04-03-PLAN.md - Create as_delayed_array and dataset_methods tests
- [x] 04-04-PLAN.md - Run coverage analysis and document results
- [x] 04-05-PLAN.md - Gap closure: as_delarr.R coverage (67.3% -> 80%+)

**Details:**
- zarr_backend.R: 5% -> 94.6% coverage
- h5_backend.R: 30.1% (S4 mocking limitation documented)
- as_delayed_array_dataset.R: 100% coverage
- as_delarr.R: 67.3% -> 81.5% coverage
- Overall: 73.3% (1991 tests passing)
- COVERAGE-REPORT.md documents all gaps and rationale

### Phase 5: Final Validation

**Goal**: Package passes R CMD check --as-cran with 0 errors and documented warnings/notes
**Depends on**: Phase 4
**Plans**: 3 plans

Plans:
- [x] 05-01-PLAN.md - Fix DESCRIPTION dependencies (remove Remotes, add blosc/DelayedArray/DelayedMatrixStats)
- [x] 05-02-PLAN.md - Fix test files (add blosc skip, remove rhdf5 references)
- [x] 05-03-PLAN.md - Run final R CMD check and create cran-comments.md

**Details:**
- Removed Remotes field for CRAN compliance
- Added blosc, DelayedArray, DelayedMatrixStats to Suggests
- Replaced rhdf5 (Bioconductor) with hdf5r (CRAN) in tests
- R CMD check: 0 errors, 1 warning (non-CRAN deps), 1 note (new submission)
- Created cran-comments.md for CRAN reviewers

---

## Milestone Summary

**Key Decisions:**

| Decision | Rationale | Outcome |
|----------|-----------|---------|
| Migrate to CRAN zarr | Pure CRAN dependency, working API | Zarr v3-only, marked EXPERIMENTAL |
| Accept 73% coverage | S4 mocking impossible for h5_backend | Documented limitation |
| No Bioconductor deps | Simplifies CRAN submission | rhdf5 -> hdf5r, Rarr -> zarr |
| Auto-open backends | Validation needs dims before open | Follows nifti pattern |

**Issues Resolved:**

- R CMD check compliance (0 errors)
- H5 backend resource leaks
- Undefined global function reference
- Missing test/vignette dependencies
- Zarr backend broken API

**Issues Deferred:**

- Actual CRAN submission (waiting for upstream deps)
- Cloud path testing for Zarr (S3/GCS/Azure)
- h5_backend test fixtures (would need real H5 files)

**Technical Debt Incurred:**

- h5_backend coverage at 30.1% (S4 limitation)
- as_delayed_array.R coverage at 49% (S4 dispatch branches)
- TODO in zarr_backend.R:268 - "Optimize for sparse access patterns"

---

*Archived: 2026-01-22 as part of v0.9.0 milestone completion*
*For current project status, see .planning/ROADMAP.md*
