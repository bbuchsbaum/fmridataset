---
phase: 03-zarr-decision
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - .planning/phases/03-zarr-decision/03-DECISION.md
  - R/zarr_backend.R
  - DESCRIPTION
  - tests/testthat/test_zarr_backend.R
  - tests/testthat/test_zarr_dataset_constructor.R
autonomous: true

must_haves:
  truths:
    - "Go/no-go decision is documented with rationale"
    - "Implementation matches the decision outcome"
    - "Package still passes R CMD check after changes"
  artifacts:
    - path: ".planning/phases/03-zarr-decision/03-DECISION.md"
      provides: "Final decision documentation"
      contains: "## Decision"
  key_links:
    - from: "03-DECISION.md"
      to: "03-INVESTIGATION.md"
      via: "References investigation findings"
---

<objective>
Implement the go/no-go decision from Plan 01's checkpoint.

Purpose: Execute the decision made after investigation. This plan handles any of the three outcomes: keep-rarr, migrate-zarr, or remove-zarr.

Output: 03-DECISION.md documenting the final decision, plus implementation changes matching the chosen path.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-zarr-decision/03-CONTEXT.md
@.planning/phases/03-zarr-decision/03-01-SUMMARY.md
@R/zarr_backend.R
@DESCRIPTION
</context>

<tasks>

<task type="auto">
  <name>Task 1: Document decision and implement changes</name>
  <files>
    .planning/phases/03-zarr-decision/03-DECISION.md
    R/zarr_backend.R
    DESCRIPTION
    tests/testthat/test_zarr_backend.R
    tests/testthat/test_zarr_dataset_constructor.R
  </files>
  <action>
Read the decision from 03-01-SUMMARY.md and implement the chosen path.

**Create 03-DECISION.md:**

```markdown
# Phase 3: Zarr Decision

**Decision:** [keep-rarr | migrate-zarr | remove-zarr]
**Date:** [today]
**Based on:** 03-INVESTIGATION.md findings

## Rationale

[Why this decision was made, referencing investigation results]

## Implementation

[What changes were made]

## Impact

[Effect on package users]
```

**If decision is "keep-rarr":**
1. No changes to R/zarr_backend.R (already works)
2. Verify Rarr is in DESCRIPTION Suggests (already is, line 53)
3. Add brief comment to zarr_backend.R header noting Rarr is the supported backend
4. Ensure tests skip properly when Rarr not installed (already do)

**If decision is "migrate-zarr":**
1. Rewrite zarr_backend.R to use CRAN zarr package API:
   - Replace Rarr::read_zarr_array() with zarr::open_zarr() / z[["/path"]]
   - Replace Rarr::zarr_overview() with zarr metadata access
   - Update error message to reference CRAN zarr package
2. Update DESCRIPTION: Replace "Rarr" with "zarr" in Suggests
3. Update tests to use zarr API mocks instead of Rarr

**If decision is "remove-zarr":**
1. Delete R/zarr_backend.R
2. Delete tests/testthat/test_zarr_backend.R
3. Delete tests/testthat/test_zarr_dataset_constructor.R
4. Remove Rarr from DESCRIPTION Suggests
5. Remove fmri_zarr_dataset from exports (check R/dataset_constructors.R)
6. Update any documentation referencing Zarr

After implementation, run R CMD check to verify package still builds cleanly.
  </action>
  <verify>
- 03-DECISION.md exists with decision documented
- If keep-rarr: zarr_backend.R unchanged, Rarr in Suggests
- If migrate-zarr: zarr_backend.R uses zarr package, zarr in Suggests
- If remove-zarr: zarr_backend.R deleted, Rarr removed from Suggests
- R CMD check passes (run: R CMD check --no-manual .)
  </verify>
  <done>
Decision implemented and documented. Package passes R CMD check with chosen Zarr approach.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update roadmap and state</name>
  <files>
    .planning/ROADMAP.md
    .planning/STATE.md
  </files>
  <action>
Update project state to reflect Phase 3 completion.

**Update ROADMAP.md:**
1. Mark Phase 3 checkbox as complete: `- [x] **Phase 3: Zarr Decision**`
2. Update Plans: TBD -> actual plan count
3. Update Progress table: Phase 3 status to "Complete", add completion date

**Update STATE.md:**
1. Update Current Position:
   - Phase: 4 of 5 (Test Coverage)
   - Plan: 0 of TBD
   - Status: Ready to plan
   - Last activity: [today] - Phase 3 complete
2. Update Progress bar: [██████░░░░] 60%
3. Add decision to Accumulated Context > Decisions:
   - "Zarr decision: [keep-rarr|migrate-zarr|remove-zarr] - [brief rationale]"
4. Update Blockers/Concerns: Remove "Zarr backend viability unknown"
  </action>
  <verify>
- ROADMAP.md shows Phase 3 complete
- STATE.md shows Phase 4 as current
- Decision recorded in STATE.md Decisions section
  </verify>
  <done>
Project state updated to reflect Phase 3 completion. Ready for Phase 4 planning.
  </done>
</task>

</tasks>

<verification>
After tasks complete:
- [ ] 03-DECISION.md documents final decision
- [ ] Implementation matches decision (files added/modified/removed accordingly)
- [ ] R CMD check passes
- [ ] ROADMAP.md shows Phase 3 complete
- [ ] STATE.md updated for Phase 4
</verification>

<success_criteria>
- Go/no-go decision is documented with clear rationale
- Implementation correctly reflects the chosen path
- Package remains functional (R CMD check clean)
- Project tracking updated for next phase
</success_criteria>

<output>
After completion, create `.planning/phases/03-zarr-decision/03-02-SUMMARY.md`
</output>
