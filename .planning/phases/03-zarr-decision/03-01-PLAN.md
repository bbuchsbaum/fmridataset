---
phase: 03-zarr-decision
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/03-zarr-decision/03-INVESTIGATION.md
autonomous: false

must_haves:
  truths:
    - "CRAN zarr package core operations are tested and documented"
    - "Rarr package core operations are tested and documented"
    - "Performance comparison between zarr, Rarr, and HDF5 is documented"
    - "Go/no-go decision criteria are evaluated against test results"
  artifacts:
    - path: ".planning/phases/03-zarr-decision/03-INVESTIGATION.md"
      provides: "Comprehensive investigation results"
      contains: "## Test Results"
  key_links:
    - from: "Investigation tests"
      to: "Decision criteria (03-CONTEXT.md)"
      via: "Direct evaluation against user-stated criteria"
---

<objective>
Investigate Zarr backend viability by testing both CRAN zarr package and current Rarr implementation.

Purpose: User wants to evaluate the newer CRAN zarr package as preferred option. Research indicates it's not production-ready, but user decision criteria require actual testing to confirm. This plan validates the research findings with hands-on testing.

Output: 03-INVESTIGATION.md with test results, performance comparison, and decision criteria evaluation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-zarr-decision/03-CONTEXT.md
@.planning/phases/03-zarr-decision/03-RESEARCH.md
@R/zarr_backend.R
@tests/testthat/test_zarr_backend.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Test CRAN zarr package core operations</name>
  <files>.planning/phases/03-zarr-decision/03-INVESTIGATION.md</files>
  <action>
Install and test the CRAN zarr package (install.packages("zarr")) to validate research findings.

Create test script that evaluates:

1. **Basic operations:**
   - Create 4D array (small: 8x8x4x20) with float64 data
   - Write to Zarr store using as_zarr()
   - Read back and verify data integrity
   - Subset reads (1-based indexing)

2. **Data types:**
   - float32, float64, int32
   - Verify no precision loss

3. **Compression:**
   - Test with gzip, blosc if available
   - Verify decompression correctness

4. **Edge cases:**
   - Empty slices
   - Single voxel reads
   - Full array reads

5. **Error conditions:**
   - Non-existent stores
   - Invalid indices
   - Corrupted data (if testable)

Document each test with:
- Test name
- Code snippet
- Result: PASS/FAIL/ERROR
- Notes (any warnings, unexpected behavior)

If ANY core operation fails or shows data integrity issues, document as blocking issue.

Begin 03-INVESTIGATION.md with header:
```markdown
# Phase 3: Zarr Decision - Investigation

**Date:** [today]
**Investigator:** Claude
**Status:** In Progress

## CRAN zarr Package Tests

### Package Info
- Version: [from packageVersion("zarr")]
- CRAN status: [from CRAN check results page]

### Test Results

[results table]
```
  </action>
  <verify>
- 03-INVESTIGATION.md exists with "CRAN zarr Package Tests" section
- Test results table shows PASS/FAIL for each test category
- Any FAIL results have detailed notes explaining the failure
  </verify>
  <done>
CRAN zarr package core operations tested with documented results showing whether it meets production-readiness criteria.
  </done>
</task>

<task type="auto">
  <name>Task 2: Test Rarr package and compare with HDF5</name>
  <files>.planning/phases/03-zarr-decision/03-INVESTIGATION.md</files>
  <action>
Test the current Rarr implementation (already in use by zarr_backend.R) and benchmark against HDF5.

1. **Rarr core operations** (same tests as Task 1):
   - Create 4D array, write, read back
   - Data types, compression, edge cases
   - Document: PASS/FAIL for each

2. **Performance benchmark:**
   Use small fMRI-like data: 64x64x30 brain, 100 timepoints (float64)

   Measure for zarr (via Rarr), HDF5 (via hdf5r):
   - Write time (full array)
   - Read time (full array)
   - Read time (single timepoint)
   - Read time (ROI: 10x10x10 region, all timepoints)
   - File size on disk

   Use bench::mark() or microbenchmark for reliable timing.

3. **Cloud path test (optional, if Rarr installed):**
   Try reading from public S3 Zarr store if one exists.
   Document: works/doesn't work/not tested

Add to 03-INVESTIGATION.md:

```markdown
## Rarr Package Tests

### Package Info
- Version: [from packageVersion("Rarr")]
- Bioconductor status: [current release]

### Test Results

[results table]

## Performance Comparison

| Operation | zarr (CRAN) | Rarr | HDF5 (hdf5r) | Notes |
|-----------|-------------|------|--------------|-------|
| Write 64x64x30x100 | [time] | [time] | [time] | |
| Read full array | [time] | [time] | [time] | |
| Read single timepoint | [time] | [time] | [time] | |
| Read ROI | [time] | [time] | [time] | |
| File size | [size] | [size] | [size] | |

## Cloud Path Test (Rarr)

[results or "Not tested"]
```
  </action>
  <verify>
- 03-INVESTIGATION.md has "Rarr Package Tests" section
- Performance comparison table is populated
- Both Rarr and HDF5 columns have timing data
  </verify>
  <done>
Rarr and HDF5 tested with performance comparison documented. Data available for go/no-go decision.
  </done>
</task>

<task type="checkpoint:decision" gate="blocking">
  <decision>Go/No-Go on Zarr backend for CRAN submission</decision>
  <context>
Based on investigation results in 03-INVESTIGATION.md, decide:

1. **Keep Zarr with Rarr (GO):** Current implementation stays, Rarr remains in Suggests
2. **Migrate to CRAN zarr (GO with migration):** Rewrite zarr_backend.R to use CRAN zarr package
3. **Remove Zarr entirely (NO-GO):** Delete zarr_backend.R, remove from DESCRIPTION, clean up tests

Decision criteria (from 03-CONTEXT.md):
- Core read/write operations must work reliably
- No workarounds needed for basic functionality
- If zarr package has bugs in core operations, that's a no-go
- Local Zarr file support is sufficient (cloud paths nice-to-have)
  </context>
  <options>
    <option id="keep-rarr">
      <name>Keep Zarr with Rarr (GO)</name>
      <pros>Already implemented, production-ready, works locally, cloud-native option for users who need it</pros>
      <cons>Bioconductor dependency (not pure CRAN), slightly slower than HDF5 for local storage</cons>
    </option>
    <option id="migrate-zarr">
      <name>Migrate to CRAN zarr (GO with migration)</name>
      <pros>Pure CRAN dependency, native Zarr v3 support</pros>
      <cons>Not production-ready (explicit warning), requires full rewrite of zarr_backend.R</cons>
    </option>
    <option id="remove-zarr">
      <name>Remove Zarr entirely (NO-GO)</name>
      <pros>Simplifies package, HDF5 handles local storage well, reduces dependencies</pros>
      <cons>Loses cloud-native storage option, existing Zarr users affected</cons>
    </option>
  </options>
  <resume-signal>Select: keep-rarr, migrate-zarr, or remove-zarr</resume-signal>
</task>

</tasks>

<verification>
After tasks complete:
- [ ] 03-INVESTIGATION.md exists with complete test results
- [ ] CRAN zarr and Rarr packages both tested
- [ ] Performance comparison documented
- [ ] Decision checkpoint reached with investigation data
</verification>

<success_criteria>
- Investigation document provides clear evidence for go/no-go decision
- All test categories documented with PASS/FAIL results
- Performance data available for comparison
- User can make informed decision based on documented findings
</success_criteria>

<output>
After completion, create `.planning/phases/03-zarr-decision/03-01-SUMMARY.md`
</output>
