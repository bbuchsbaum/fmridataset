---
phase: 02-tech-debt
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - R/h5_backend.R
autonomous: true

must_haves:
  truths:
    - "H5 file handles are closed even when errors occur in backend_get_dims"
    - "H5 file handles are closed even when errors occur in backend_get_mask"
    - "H5 file handles are closed even when errors occur in backend_get_data"
  artifacts:
    - path: "R/h5_backend.R"
      provides: "H5 backend with proper resource management"
      contains: "on.exit(close"
  key_links:
    - from: "R/h5_backend.R"
      to: "fmristore::H5NeuroVec"
      via: "on.exit cleanup registration"
      pattern: "on\\.exit\\(close\\("
---

<objective>
Add on.exit() resource protection to all H5 backend functions that create temporary file handles.

Purpose: Ensure H5 file handles are properly closed even when errors occur during data extraction, preventing resource leaks that can cause file locking issues.
Output: Updated h5_backend.R with proper on.exit() cleanup in backend_get_dims, backend_get_mask, and backend_get_data.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-tech-debt/02-RESEARCH.md

@R/h5_backend.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add on.exit() protection to backend_get_dims</name>
  <files>R/h5_backend.R</files>
  <action>
In backend_get_dims.h5_backend, add on.exit() cleanup immediately after each H5NeuroVec creation:

1. Line 216 (first_h5 creation): Add `on.exit(close(first_h5), add = TRUE, after = FALSE)` immediately after creation, BEFORE the dim() call. Remove the explicit close() on line 218 (on.exit handles it).

2. Lines 223-226 (sapply loop): Inside the anonymous function, add `on.exit(close(h5_obj), add = TRUE, after = FALSE)` immediately after h5_obj creation. Remove the explicit close() on line 225.

Pattern to apply:
```r
# BEFORE
first_h5 <- fmristore::H5NeuroVec(backend$source[1], dataset_name = backend$data_dataset)
d <- dim(first_h5)
close(first_h5)

# AFTER
first_h5 <- fmristore::H5NeuroVec(backend$source[1], dataset_name = backend$data_dataset)
on.exit(close(first_h5), add = TRUE, after = FALSE)
d <- dim(first_h5)
```

This ensures handles are closed even if dim() or other operations fail.
  </action>
  <verify>
Grep for on.exit in h5_backend.R shows new cleanup handlers:
`grep -n "on.exit" R/h5_backend.R`

Should show on.exit calls in backend_get_dims function (around lines 216-230).
  </verify>
  <done>backend_get_dims.h5_backend has on.exit() protection for all H5 handle creations, explicit close() calls removed</done>
</task>

<task type="auto">
  <name>Task 2: Add on.exit() protection to backend_get_mask and backend_get_data</name>
  <files>R/h5_backend.R</files>
  <action>
1. In backend_get_mask.h5_backend:

   a. Line 274 (h5_mask creation): Add `on.exit(close(h5_mask), add = TRUE, after = FALSE)` immediately after creation. Remove explicit close() on line 276.

   b. Lines 280-282 (first_h5 for space info): Add `on.exit(close(first_h5), add = TRUE, after = FALSE)` immediately after creation. Remove explicit close() on line 282.

2. In backend_get_data.h5_backend:

   Lines 345-346 (lapply creating H5NeuroVec objects): Inside the anonymous function in lapply, add on.exit() protection. However, since the handles need to be returned and used later, this case is different.

   Looking at the code flow:
   - Lines 345-346 create objects that are returned from lapply and used later
   - Lines 381-384 close them after use

   The issue is if series() fails on line 371 or 375, cleanup at 381-384 won't execute.

   Solution: Wrap the usage section (lines 368-384) to ensure cleanup. Add a local cleanup handler before using h5_objects:

   ```r
   # After line 361 (after h5_objects is assigned), add:
   # Only register cleanup if we loaded on-demand (not preloaded)
   if (is.null(backend$h5_objects)) {
     on.exit({
       lapply(h5_objects, function(obj) {
         tryCatch(close(obj), error = function(e) invisible(NULL))
       })
     }, add = TRUE, after = FALSE)
   }
   ```

   Then remove the explicit cleanup block at lines 381-385 since on.exit handles it.
  </action>
  <verify>
1. Grep for on.exit in h5_backend.R:
   `grep -n "on.exit" R/h5_backend.R`

   Should show on.exit calls in backend_get_mask (around lines 274, 280) and backend_get_data (around line 363).

2. R CMD check still passes:
   `R CMD check --no-manual .`
  </verify>
  <done>backend_get_mask and backend_get_data have on.exit() protection for all H5 handles, explicit close() calls consolidated</done>
</task>

<task type="auto">
  <name>Task 3: Verify resource management and run tests</name>
  <files>R/h5_backend.R</files>
  <action>
1. Verify the changes by running existing h5_backend tests:
   `Rscript -e "testthat::test_file('tests/testthat/test_h5_backend.R')"`

2. Run a quick R CMD check to ensure no regressions:
   `R CMD check --no-manual --no-vignettes .`

3. Verify on.exit pattern is consistent: each H5 object creation should have on.exit immediately after (except for backend_get_metadata which already has it on line 409).

Checklist for h5_backend.R on.exit coverage:
- [ ] backend_get_dims: first_h5 creation (line ~216)
- [ ] backend_get_dims: sapply h5_obj creation (line ~223)
- [ ] backend_get_mask: h5_mask creation (line ~274)
- [ ] backend_get_mask: first_h5 creation (line ~280)
- [ ] backend_get_data: h5_objects cleanup (line ~363)
- [x] backend_get_metadata: first_h5 creation (line 409) - already done
  </action>
  <verify>
1. Tests pass: `Rscript -e "testthat::test_file('tests/testthat/test_h5_backend.R')"`
2. R CMD check produces no new errors or warnings
3. `grep -c "on.exit" R/h5_backend.R` returns 6 or more (5 new + 1 existing)
  </verify>
  <done>All H5 backend functions have verified on.exit() protection, tests pass, no regressions</done>
</task>

</tasks>

<verification>
1. `grep -n "on.exit" R/h5_backend.R` shows on.exit calls in:
   - backend_get_dims (2 occurrences)
   - backend_get_mask (2 occurrences)
   - backend_get_data (1 occurrence)
   - backend_get_metadata (1 occurrence - existing)

2. R CMD check --no-manual passes without new warnings

3. H5 backend tests pass
</verification>

<success_criteria>
- backend_get_dims uses on.exit() for all H5 handle creations
- backend_get_mask uses on.exit() for all H5 handle creations
- backend_get_data uses on.exit() for cleanup of on-demand loaded handles
- No explicit close() calls remain without on.exit() protection
- All existing tests pass
- Requirements DEBT-01 and DEBT-02 are satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/02-tech-debt/02-01-SUMMARY.md`
</output>
