---
phase: 06-user-vignettes
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - vignettes/h5-backend-usage.Rmd
autonomous: true

must_haves:
  truths:
    - "User can render h5-backend-usage.Rmd without errors"
    - "HDF5 concepts are demonstrated with simulated examples"
    - "Performance characteristics are clearly explained"
  artifacts:
    - path: "vignettes/h5-backend-usage.Rmd"
      provides: "HDF5 backend usage guide with executable demonstrations"
      contains: "eval = TRUE"
  key_links:
    - from: "vignettes/h5-backend-usage.Rmd"
      to: "R/h5_backend.R"
      via: "h5_backend concepts"
      pattern: "h5_backend|fmri_h5_dataset"
---

<objective>
Fix h5-backend-usage.Rmd to have executable examples demonstrating HDF5 concepts.

Purpose: Enable users to understand HDF5 storage benefits through working simulations.
Output: A vignette that renders without errors and demonstrates H5 backend patterns.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-user-vignettes/06-CONTEXT.md
@vignettes/h5-backend-usage.Rmd
@R/h5_backend.R
@R/dataset_constructors.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enable executable examples with simulated H5</name>
  <files>vignettes/h5-backend-usage.Rmd</files>
  <action>
    Current state: Global `eval = FALSE` at line 20. Since H5 requires fmristore (optional dependency), examples simulate H5 behavior.

    1. Change global knitr setup to `eval = TRUE`

    2. Review each code chunk and determine execution strategy:
       - `h5-example` (line 40): Should execute - creates synthetic data and simulates H5 stats
       - `h5-performance` (line 200): Should execute - demonstrates performance characteristics
       - `nifti-to-h5` (line 319): Keep eval=FALSE or make purely illustrative (no real files)
       - `compression-optimization` (line 389): Should execute - prints compression guide
       - `h5-creation` (line 473): Should execute - shows example code patterns (cat-based)
       - `h5-advanced-features` (line 567): Should execute - demonstrates features (cat-based)
       - `multi-subject-h5` (line 659): Should execute - shows organization patterns
       - `cloud-h5` (line 770): Should execute - shows cloud patterns
       - `h5-quality` (line 870): Should execute - shows QA patterns
       - `storage-planning` (line 1035): Should execute - guidelines function
       - `h5-optimization` (line 1110): Should execute - optimization patterns
       - `h5-diagnostics` (line 1255): Keep eval=FALSE (requires real files)
       - `h5-performance-troubleshooting` (line 1310): Keep eval=FALSE (requires real dataset)

    3. Ensure simulated examples don't require fmristore or hdf5r:
       - Use matrix_dataset as stand-in for H5 dataset behavior
       - Simulate compression stats with arithmetic
       - Show code patterns using cat() for documentation

    4. Add set.seed() where random data is generated

    5. Fix any undefined helper function calls
  </action>
  <verify>
    R -q -e "suppressPackageStartupMessages(devtools::load_all()); rmarkdown::render('vignettes/h5-backend-usage.Rmd', output_format='html_document', quiet=TRUE); cat('SUCCESS\n')"
  </verify>
  <done>Vignette renders without errors, H5 concepts demonstrated through simulation</done>
</task>

<task type="auto">
  <name>Task 2: Verify accuracy and improve clarity</name>
  <files>vignettes/h5-backend-usage.Rmd</files>
  <action>
    1. Verify simulated H5 dataset interface matches real h5_backend:
       - Check that simulated methods (get_TR, n_runs, etc.) work
       - Ensure performance claims are realistic

    2. Review content for clarity:
       - Compression ratios (2-4x typical for fMRI) are accurate
       - Chunk size recommendations are sensible
       - Cloud/HPC advice is current

    3. Ensure examples show value of H5 without requiring it:
       - Compare simulated H5 vs matrix backend
       - Show storage efficiency calculations
       - Demonstrate lazy loading concept

    4. Check "Integration with Other Vignettes" section:
       - Should reference fmridataset-intro.html as prerequisite
       - Should reference architecture-overview.html for context
       - Should reference study-level-analysis.html for scaling

    5. Remove/update any mock output blocks that don't match execution
  </action>
  <verify>
    R -q -e "suppressPackageStartupMessages(devtools::load_all()); rmarkdown::render('vignettes/h5-backend-usage.Rmd', output_format='html_document', quiet=TRUE); cat('SUCCESS\n')"
  </verify>
  <done>Content accurate, examples clear, navigation to other vignettes works</done>
</task>

</tasks>

<verification>
1. R -q -e "suppressPackageStartupMessages(devtools::load_all()); rmarkdown::render('vignettes/h5-backend-usage.Rmd', quiet=TRUE)" exits 0
2. H5 concepts explained through working simulations
3. No errors from missing optional dependencies (hdf5r, fmristore)
</verification>

<success_criteria>
- h5-backend-usage.Rmd renders without errors
- H5 benefits demonstrated without requiring H5 dependencies
- Performance characteristics clearly explained
- Teaching approach follows concept-first pattern
</success_criteria>

<output>
After completion, create `.planning/phases/06-user-vignettes/06-03-SUMMARY.md`
</output>
