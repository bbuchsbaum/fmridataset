---
phase: 06-user-vignettes
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - vignettes/study-level-analysis.Rmd
autonomous: true

must_haves:
  truths:
    - "User can render study-level-analysis.Rmd without errors"
    - "Multi-subject workflow is demonstrated with working code"
    - "Memory-efficient patterns are shown"
  artifacts:
    - path: "vignettes/study-level-analysis.Rmd"
      provides: "Study-level analysis guide with executable examples"
      contains: "eval = TRUE"
  key_links:
    - from: "vignettes/study-level-analysis.Rmd"
      to: "R/study_backend.R"
      via: "fmri_study_dataset() calls"
      pattern: "fmri_study_dataset"
    - from: "vignettes/study-level-analysis.Rmd"
      to: "R/all_generic.R"
      via: "subject_ids() and other methods"
      pattern: "subject_ids|get_data_matrix"
---

<objective>
Fix study-level-analysis.Rmd to have executable examples for multi-subject analysis.

Purpose: Enable users to scale from single-subject to multi-subject analysis.
Output: A vignette that renders without errors and demonstrates study-level patterns.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-user-vignettes/06-CONTEXT.md
@vignettes/study-level-analysis.Rmd
@R/study_backend.R
@R/dataset_constructors.R
@R/all_generic.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enable executable examples</name>
  <files>vignettes/study-level-analysis.Rmd</files>
  <action>
    Current state: Global `eval = FALSE` at line 20. All examples are non-executable.

    1. Change global knitr setup to `eval = TRUE`

    2. Review each code chunk and fix for execution:
       - `study-example` (line 40): Should execute - creates subject datasets and study
       - `study-interface` (line 119): Should execute - demonstrates unified interface
       - `study-creation-objects` (line 182): Should execute - shows object-based creation
       - `study-creation-files` (line 225): Keep eval=FALSE (requires real files)
       - `subject-by-subject` (line 259): Should execute - memory-efficient processing
       - `cross-subject-chunks` (line 309): Should execute - chunked processing
       - `fmri-series-study` (line 358): Should execute - flexible selection
       - `heterogeneous-studies` (line 394): Should execute - different structures
       - `memory-optimization` (line 447): Should execute - memory monitoring
       - `parallel-processing` (line 491): Keep eval=FALSE (parallel setup)
       - `quality-control` (line 551): Should execute - QC assessment
       - `consistency-validation` (line 614): Should execute - validation
       - `memory-strategies` (line 703): Should execute - prints strategies
       - `study-design` (line 736): Should execute - prints guidelines
       - `error-handling` (line 769): Should execute - robust analysis pattern
       - `memory-troubleshooting` (line 860): Should execute - diagnostic function
       - `inconsistency-troubleshooting` (line 905): Should execute - handler function

    3. Fix any issues with study dataset creation:
       - Ensure fmri_study_dataset() signature is correct
       - Verify subject_ids() method exists and works
       - Check get_data_matrix(study_dataset, subject_id = ...) pattern

    4. Add set.seed() calls for reproducibility

    5. Ensure memory monitoring examples work without pryr (use tryCatch or conditional)
  </action>
  <verify>
    R -q -e "suppressPackageStartupMessages(devtools::load_all()); rmarkdown::render('vignettes/study-level-analysis.Rmd', output_format='html_document', quiet=TRUE); cat('SUCCESS\n')"
  </verify>
  <done>Vignette renders without errors, study-level patterns demonstrated</done>
</task>

<task type="auto">
  <name>Task 2: Verify API accuracy and improve clarity</name>
  <files>vignettes/study-level-analysis.Rmd</files>
  <action>
    1. Verify study dataset API calls:
       - fmri_study_dataset(datasets = list(...), subject_ids = c(...))
       - subject_ids(study_dataset) returns character vector
       - get_data_matrix(study_dataset, subject_id = "sub-001") works
       - n_runs(study_dataset), get_TR(study_dataset) work at study level
       - data_chunks(study_dataset, nchunks = N) works

    2. Verify fmri_series() usage if present:
       - Check selector parameter usage
       - Check subject_ids parameter
       - Check timepoints parameter

    3. Ensure explanations are clear:
       - Lazy evaluation concept is explained
       - Memory efficiency patterns are practical
       - Quality control recommendations are actionable

    4. Check "Integration with Other Vignettes" section:
       - Should reference fmridataset-intro.html as prerequisite
       - Should reference architecture-overview.html for context
       - Should reference h5-backend-usage.html for storage

    5. Fix/remove mock output blocks that don't match actual output

    6. Handle optional packages gracefully:
       - pryr for memory monitoring
       - parallel for parallel processing
       - dplyr for tibble operations
  </action>
  <verify>
    R -q -e "suppressPackageStartupMessages(devtools::load_all()); rmarkdown::render('vignettes/study-level-analysis.Rmd', output_format='html_document', quiet=TRUE); cat('SUCCESS\n')"
  </verify>
  <done>API calls accurate, explanations clear, optional dependencies handled</done>
</task>

</tasks>

<verification>
1. R -q -e "suppressPackageStartupMessages(devtools::load_all()); rmarkdown::render('vignettes/study-level-analysis.Rmd', quiet=TRUE)" exits 0
2. Study-level patterns demonstrated with working code
3. No errors from missing optional packages
</verification>

<success_criteria>
- study-level-analysis.Rmd renders without errors
- Multi-subject workflow clearly demonstrated
- Memory-efficient patterns shown with working code
- API usage matches current package version
</success_criteria>

<output>
After completion, create `.planning/phases/06-user-vignettes/06-04-SUMMARY.md`
</output>
