---
phase: 05-final-validation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/testthat/test_zarr_backend.R
  - tests/testthat/test_zarr_dataset_constructor.R
  - tests/testthat/helper-backends.R
  - tests/test_optional_packages.R
  - tests/testthat/test_backend_integration.R
  - tests/testthat/test_api_safety.R
autonomous: true

must_haves:
  truths:
    - "All zarr tests skip gracefully when blosc is not installed"
    - "No rhdf5 references exist in test files"
    - "Tests pass with _R_CHECK_FORCE_SUGGESTS_=false"
  artifacts:
    - path: "tests/testthat/test_zarr_backend.R"
      provides: "Zarr backend tests with blosc skip"
      contains: "skip_if_not_installed.*blosc"
    - path: "tests/testthat/test_zarr_dataset_constructor.R"
      provides: "Zarr dataset constructor tests with blosc skip"
      contains: "skip_if_not_installed.*blosc"
    - path: "tests/test_optional_packages.R"
      provides: "Optional package listing with hdf5r not rhdf5"
  key_links:
    - from: "tests/testthat/test_zarr_backend.R"
      to: "zarr::as_zarr"
      via: "skip_if_not_installed blosc"
      pattern: "skip_if_not_installed.*blosc.*zarr::as_zarr"
---

<objective>
Fix test files to resolve R CMD check errors and warnings about unstated dependencies.

Purpose: Tests fail because zarr::as_zarr() requires blosc package but tests don't skip when blosc is unavailable. Also, tests reference rhdf5 which should be hdf5r per user requirement.

Output: Test files that pass R CMD check --as-cran with proper dependency handling.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-final-validation/05-RESEARCH.md

@tests/testthat/test_zarr_backend.R
@tests/testthat/test_zarr_dataset_constructor.R
@tests/testthat/helper-backends.R
@tests/test_optional_packages.R
@tests/testthat/test_backend_integration.R
@tests/testthat/test_api_safety.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add blosc skip to zarr test files</name>
  <files>
    tests/testthat/test_zarr_backend.R
    tests/testthat/test_zarr_dataset_constructor.R
    tests/testthat/helper-backends.R
  </files>
  <action>
  For each test file that uses zarr::as_zarr(), add `skip_if_not_installed("blosc")` immediately AFTER the `skip_if_not_installed("zarr")` line.

  In test_zarr_backend.R:
  - Find all test_that blocks that have `skip_if_not_installed("zarr")` AND use `zarr::as_zarr()`
  - Add `skip_if_not_installed("blosc")` on the next line after the zarr skip
  - Tests at approximately lines: 44, 79, 106, 124, 136, 165, 192, 223, 268, 299, 330, 354

  In test_zarr_dataset_constructor.R:
  - Same pattern: add blosc skip after zarr skip for tests using zarr::as_zarr()
  - Tests at approximately lines: 2, 36, 59, 81, 107

  In helper-backends.R:
  - The create_test_zarr() function at line 10 already has zarr skip
  - Add `skip_if_not_installed("blosc")` after line 10

  NOTE: Some tests may only need zarr for validation (not as_zarr). Those that don't call zarr::as_zarr() don't need blosc skip. Focus on tests that actually CREATE zarr stores with as_zarr().
  </action>
  <verify>
  Run: `grep -c "skip_if_not_installed.*blosc" tests/testthat/test_zarr_backend.R` should show count > 0
  Run: `grep -c "skip_if_not_installed.*blosc" tests/testthat/test_zarr_dataset_constructor.R` should show count > 0
  Run: `grep -c "skip_if_not_installed.*blosc" tests/testthat/helper-backends.R` should show count = 1
  </verify>
  <done>
  - All test_that blocks using zarr::as_zarr() have skip_if_not_installed("blosc")
  - helper-backends.R create_test_zarr() has blosc skip
  - Zarr tests will skip gracefully when blosc is not available
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove rhdf5 references from tests</name>
  <files>
    tests/test_optional_packages.R
    tests/testthat/test_backend_integration.R
    tests/testthat/test_api_safety.R
  </files>
  <action>
  Replace all rhdf5 references with hdf5r. The user specified that hdf5r is the correct HDF5 library for this package, not rhdf5 (Bioconductor).

  In tests/test_optional_packages.R:
  - Line 20-21: Change `Rarr = "Zarr array support (Bioconductor)"` to `zarr = "Zarr array support (CRAN)"`
  - Line 21: Change `rhdf5 = "HDF5 support (Bioconductor)"` to remove entirely (hdf5r already in list)
  - Line 49: Update bioc_pkgs to not include rhdf5: `bioc_pkgs <- intersect(missing, c("Rarr"))` -> remove rhdf5 reference entirely since we're using CRAN zarr
  - Line 81 onwards: Change `"Rarr"` checks to `"zarr"` (CRAN package)
  - Line 98: Update condition to check for hdf5r, not rhdf5
  - Line 113: Update message about missing HDF5

  In tests/testthat/test_backend_integration.R:
  - Line 38-42: Change `has_rhdf5 <- requireNamespace("rhdf5", quietly = TRUE)` to check hdf5r only
  - Lines 53-56, 63-66: Remove rhdf5 code paths, keep only hdf5r code

  In tests/testthat/test_api_safety.R:
  - Search for any rhdf5 references and replace with hdf5r (if any exist)

  IMPORTANT: The goal is to completely eliminate rhdf5 from the codebase. Use hdf5r exclusively for HDF5 support.
  </action>
  <verify>
  Run: `grep -r "rhdf5" tests/` should return empty (no rhdf5 references in tests)
  Run: `grep -c "hdf5r" tests/test_optional_packages.R` should return count > 0
  </verify>
  <done>
  - No rhdf5 references exist in any test files
  - HDF5 functionality uses hdf5r exclusively
  - test_optional_packages.R checks for hdf5r and zarr (not rhdf5 and Rarr)
  </done>
</task>

</tasks>

<verification>
- `grep -r "rhdf5" tests/` returns empty
- `grep -c "skip_if_not_installed.*blosc" tests/testthat/` shows multiple matches
- `R CMD check --no-manual . 2>&1 | grep -E "(ERROR|WARNING)"` shows fewer errors/warnings
</verification>

<success_criteria>
Test files are CRAN-compatible:
1. All zarr tests have blosc skip when using as_zarr()
2. No rhdf5 references exist in tests
3. Tests check for hdf5r (not rhdf5) for HDF5 support
</success_criteria>

<output>
After completion, create `.planning/phases/05-final-validation/05-02-SUMMARY.md`
</output>
