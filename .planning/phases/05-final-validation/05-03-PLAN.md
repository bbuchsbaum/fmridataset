---
phase: 05-final-validation
plan: 03
type: execute
wave: 2
depends_on: ["05-01", "05-02"]
files_modified:
  - cran-comments.md
autonomous: true

must_haves:
  truths:
    - "R CMD check --as-cran produces 0 errors"
    - "R CMD check --as-cran produces 0 warnings (or only documented acceptable warnings)"
    - "R CMD check --as-cran produces 0 notes (or only documented acceptable notes)"
    - "Package installs and loads in local development environment"
  artifacts:
    - path: "cran-comments.md"
      provides: "Documentation of check results and known issues for CRAN reviewers"
      contains: ["R CMD check results", "Test environments"]
  key_links:
    - from: "R CMD check"
      to: "cran-comments.md"
      via: "documents results"
      pattern: "errors.*warnings.*notes"
---

<objective>
Run final R CMD check --as-cran validation and document results.

Purpose: Verify that all previous fixes have resolved the check issues. Document any unavoidable warnings/notes for CRAN reviewers. Test fresh installation.

Output: Clean check results (0 errors, minimal warnings/notes) and cran-comments.md documenting the package state.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-final-validation/05-RESEARCH.md
@.planning/phases/05-final-validation/05-01-SUMMARY.md
@.planning/phases/05-final-validation/05-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run R CMD check --as-cran</name>
  <files></files>
  <action>
  Execute the full CRAN check process:

  1. Clean build:
     ```bash
     rm -rf fmridataset.Rcheck fmridataset_*.tar.gz
     R CMD build .
     ```

  2. Run CRAN check:
     ```bash
     R CMD check --as-cran fmridataset_*.tar.gz
     ```

  3. Review results in fmridataset.Rcheck/00check.log

  Expected results after fixes:
  - 0 errors (test failures fixed by blosc skip)
  - 1 WARNING expected: "Strong dependencies not in mainstream repositories: delarr" (cannot fix until delarr is on CRAN)
  - 1 WARNING expected: "Suggests or Enhances not in mainstream repositories: bidser, fmristore" (acceptable for optional deps)
  - 1 NOTE expected: "New submission" (first-time CRAN submission)
  - 1 NOTE possible: HTML validation tool issue (system-dependent)

  If unexpected errors/warnings occur, investigate and fix before proceeding.
  </action>
  <verify>
  Run: `tail -5 fmridataset.Rcheck/00check.log` should show "Status: X ERROR(s), Y WARNING(s), Z NOTE(s)"
  Confirm: errors = 0 is required
  </verify>
  <done>
  - R CMD check --as-cran completes with 0 errors
  - Any warnings are documented and expected (non-CRAN dependencies)
  - Any notes are documented and acceptable
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify local installation</name>
  <files></files>
  <action>
  Verify the package installs and loads correctly from the local environment where dependencies are already available:

  1. Install package from source:
     ```bash
     R CMD INSTALL . 2>&1 | tail -10
     ```

  2. Verify package loads in vanilla R session:
     ```bash
     R --vanilla -e "library(fmridataset); packageVersion('fmridataset')"
     ```

  3. Verify tarball structure is valid:
     ```bash
     TARBALL=$(ls fmridataset_*.tar.gz | head -1)
     R --vanilla -e "untar('${TARBALL}', list = TRUE) |> head(20)"
     ```

  Note: Full installation from tarball in a clean system requires all dependencies (delarr, neuroim2, etc.) which are not on CRAN. This task verifies installation works in the current development environment where dependencies are available.
  </action>
  <verify>
  Run: `R --vanilla -e "library(fmridataset); packageVersion('fmridataset')"` should print version
  </verify>
  <done>
  - Package installs from source without errors
  - Package loads in vanilla R session
  - Package reports correct version
  - Tarball has valid structure
  </done>
</task>

<task type="auto">
  <name>Task 3: Create cran-comments.md</name>
  <files>cran-comments.md</files>
  <action>
  Create (or update) cran-comments.md to document the check results for CRAN reviewers.

  Content should include:

  ```markdown
  ## R CMD check results

  0 errors | 1-2 warnings | 1-2 notes

  ## Test environments

  * local macOS (aarch64-apple-darwin20), R 4.5.1

  ## Warnings

  ### Strong dependencies not in mainstream repositories

  This package depends on `delarr`, `fmrihrf`, and `neuroim2` which are not yet
  on CRAN. These packages are being prepared for CRAN submission. This package
  will only be submitted to CRAN after its dependencies are accepted.

  ### Suggests not in mainstream repositories

  `bidser` and `fmristore` are optional dependencies from GitHub. They are used
  only for advanced features (BIDS integration and HDF5 fMRI storage) and are
  properly wrapped with `requireNamespace()` checks.

  ## Notes

  ### New submission

  This is the first submission of this package to CRAN.

  ### HTML validation (if present)

  The "tidy doesn't look like recent enough HTML Tidy" note is a tool
  availability issue on the test system, not a package issue.

  ## Downstream dependencies

  There are currently no downstream dependencies for this package on CRAN.
  ```

  Adjust the content based on actual check results from Task 1.
  </action>
  <verify>
  Run: `cat cran-comments.md` to review the file content
  Verify: File documents actual check results accurately
  </verify>
  <done>
  - cran-comments.md exists in package root
  - File accurately documents check results
  - All warnings and notes are explained
  - CRAN reviewers have context for any non-zero results
  </done>
</task>

</tasks>

<verification>
- `cat fmridataset.Rcheck/00check.log | tail -1` shows "Status: 0 ERROR(s), ..."
- `ls cran-comments.md` confirms file exists
- `R --vanilla -e "library(fmridataset)"` runs without error
</verification>

<success_criteria>
Phase 5 Final Validation complete:
1. R CMD check --as-cran produces 0 errors
2. All warnings are expected and documented
3. All notes are acceptable and documented
4. Package installs and loads correctly
5. cran-comments.md documents results for CRAN submission
</success_criteria>

<output>
After completion, create `.planning/phases/05-final-validation/05-03-SUMMARY.md`
</output>
