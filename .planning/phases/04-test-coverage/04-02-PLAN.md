---
phase: 04-test-coverage
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/testthat/test-h5_backend.R
autonomous: true

must_haves:
  truths:
    - "h5_backend constructor validates source and mask inputs"
    - "h5_backend open/close lifecycle manages H5 handles properly"
    - "h5_backend get_dims returns correct spatial and time dimensions"
    - "h5_backend get_mask loads and validates mask correctly"
    - "h5_backend get_data returns correct data with subsetting"
    - "h5_backend get_metadata returns neuroimaging metadata"
    - "Tests skip gracefully when fmristore/hdf5r unavailable"
  artifacts:
    - path: "tests/testthat/test-h5_backend.R"
      provides: "Comprehensive h5_backend tests"
      min_lines: 200
  key_links:
    - from: "tests/testthat/test-h5_backend.R"
      to: "R/h5_backend.R"
      via: "tests h5_backend() constructor and backend_* methods"
      pattern: "h5_backend|backend_open|backend_close|backend_get_"
---

<objective>
Create comprehensive tests for h5_backend.R to achieve 80%+ coverage.

Purpose: TEST-02 requires h5_backend.R coverage from 26% to 80%+. The H5 backend is critical for HDF5-based neuroimaging workflows using fmristore.

Output:
- `tests/testthat/test-h5_backend.R` with tests covering constructor validation, lifecycle management, data access, and error handling
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-test-coverage/04-CONTEXT.md
@.planning/phases/04-test-coverage/04-RESEARCH.md
@R/h5_backend.R
@tests/testthat/helper-golden.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create h5_backend constructor and validation tests</name>
  <files>tests/testthat/test-h5_backend.R</files>
  <action>
Create `tests/testthat/test-h5_backend.R` with tests for h5_backend constructor and input validation.

**Required skip guards at start of each test:**
```r
skip_if_not_installed("fmristore")
skip_if_not_installed("hdf5r")
skip_if_not_installed("neuroim2")
```

**Constructor validation tests:**

1. "h5_backend requires fmristore package":
   - Use `with_mocked_bindings()` to mock `requireNamespace` returning FALSE for fmristore
   - Expect error "Package 'fmristore' is required"

2. "h5_backend validates source file existence":
   - Call `h5_backend("/nonexistent/file.h5", "/nonexistent/mask.h5")`
   - Expect error containing "H5 source files not found"

3. "h5_backend validates source type":
   - Call `h5_backend(123, "mask.h5")`
   - Expect error "source must be character vector"

4. "h5_backend validates mask file existence":
   - Create a temp H5 file for source
   - Call with valid source but nonexistent mask
   - Expect error "H5 mask file not found"

5. "h5_backend validates mask source type":
   - Create valid source file
   - Call `h5_backend(valid_source, 123)`
   - Expect error "mask_source must be file path"

6. "h5_backend constructor returns correct class":
   - Create valid H5 files using helper
   - Verify object has class c("h5_backend", "storage_backend")
   - Verify `$source`, `$mask_source`, `$preload` are set

**Helper for creating test H5NeuroVec files:**
Since fmristore H5 files have specific structure, either:
- Use `fmristore::write_h5_neurovec()` if available
- Or create minimal H5 structure manually with hdf5r matching expected format

If creating manually impossible without fmristore internals, use integration approach:
Create NeuroVec, write to H5 via fmristore, then test backend.
  </action>
  <verify>
```bash
cd /Users/bbuchsbaum/code/fmridataset && Rscript -e "devtools::test(filter = 'h5_backend')" 2>&1 | head -50
```
Constructor tests pass or skip gracefully.
  </verify>
  <done>test-h5_backend.R has constructor validation tests that pass or skip when deps unavailable</done>
</task>

<task type="auto">
  <name>Task 2: Add h5_backend lifecycle and data access tests</name>
  <files>tests/testthat/test-h5_backend.R</files>
  <action>
Extend `tests/testthat/test-h5_backend.R` with lifecycle and data access tests.

**Backend lifecycle tests:**

1. "h5_backend opens and loads data when preload=TRUE":
   - Create H5 files with test data
   - Create backend with preload=TRUE
   - Call backend_open()
   - Verify `$h5_objects` is populated
   - Verify `$mask` is populated
   - Verify `$dims` is set

2. "h5_backend close releases resources":
   - Open backend with preload=TRUE
   - Call backend_close()
   - Verify h5 objects are closed (no error on repeated close)

3. "h5_backend lazy loading works":
   - Create backend with preload=FALSE
   - Call backend_get_dims() (should work without full open)
   - Verify dims are returned correctly

**backend_get_dims tests:**

1. "h5_backend get_dims returns correct structure":
   - Create H5 with known dims (4, 4, 4, 10)
   - Verify dims$spatial == c(4, 4, 4)
   - Verify dims$time == 10

2. "h5_backend get_dims handles multiple files":
   - Create two H5 files with 5 timepoints each
   - Verify dims$time == 10 (sum of both)

**backend_get_mask tests:**

1. "h5_backend get_mask returns logical vector":
   - Create backend with H5 mask
   - Call backend_get_mask()
   - Verify result is logical
   - Verify length equals prod(spatial_dims)

2. "h5_backend get_mask validates mask content":
   - Mask with all FALSE should error "no TRUE values"
   - Mask with NAs should error "contains NA values"

**backend_get_data tests:**

1. "h5_backend get_data returns full matrix":
   - Create backend, open, get_data(rows=NULL, cols=NULL)
   - Verify dimensions match (time x masked_voxels)

2. "h5_backend get_data subsets correctly":
   - get_data(rows=1:5, cols=1:10)
   - Verify result is 5 x 10 matrix

3. "h5_backend get_data concatenates multiple files":
   - Two H5 files, get_data for all rows
   - Verify data is concatenated along time

**backend_get_metadata tests:**

1. "h5_backend get_metadata returns neuroimaging info":
   - Verify format == "h5"
   - Verify affine, voxel_dims, origin present
  </action>
  <verify>
```bash
cd /Users/bbuchsbaum/code/fmridataset && Rscript -e "devtools::test(filter = 'h5_backend')"
```
All h5_backend tests pass or skip gracefully.
  </verify>
  <done>test-h5_backend.R has comprehensive lifecycle and data access tests</done>
</task>

<task type="auto">
  <name>Task 3: Verify h5_backend coverage improvement</name>
  <files></files>
  <action>
Run coverage analysis on h5_backend.R to verify improvement toward 80% target.

1. Run file-specific coverage:
```r
if (requireNamespace("fmristore", quietly = TRUE) &&
    requireNamespace("hdf5r", quietly = TRUE)) {
  cov <- covr::file_coverage("R/h5_backend.R", "tests/testthat/test-h5_backend.R")
  covr::percent_coverage(cov)
}
```

2. If coverage is below 80%, identify uncovered lines and add targeted tests:
   - Multiple H5 file handling paths
   - H5 vs NIfTI mask loading branches
   - In-memory mask object path
   - Error recovery paths in on.exit handlers

3. Document coverage result in task output.

Note: If fmristore/hdf5r packages are not installed, this task will produce minimal coverage data. The tests are designed to skip gracefully.
  </action>
  <verify>
```bash
cd /Users/bbuchsbaum/code/fmridataset && Rscript -e "
if (requireNamespace('fmristore', quietly = TRUE) &&
    requireNamespace('hdf5r', quietly = TRUE)) {
  cov <- covr::file_coverage('R/h5_backend.R', 'tests/testthat/test-h5_backend.R')
  pct <- covr::percent_coverage(cov)
  cat('h5_backend.R coverage:', round(pct, 1), '%\n')
  if (pct < 80) {
    cat('WARNING: Coverage below 80% target\n')
    print(covr::zero_coverage(cov))
  }
} else {
  cat('fmristore/hdf5r not installed - skipping coverage check\n')
}
"
```
  </verify>
  <done>Coverage analysis complete; h5_backend.R coverage documented (80%+ if deps available, or graceful skip documented)</done>
</task>

</tasks>

<verification>
1. `tests/testthat/test-h5_backend.R` exists with comprehensive tests
2. `devtools::test(filter = "h5_backend")` passes or skips gracefully
3. Coverage analysis shows improvement from 26% baseline
4. All backend methods (open, close, get_dims, get_mask, get_data, get_metadata) are tested
</verification>

<success_criteria>
- test-h5_backend.R tests all h5_backend methods systematically
- Tests use proper skip guards for fmristore, hdf5r, neuroim2
- Resource cleanup tested (on.exit patterns from Phase 2)
- Coverage moves toward 80% target (verified if deps available)
</success_criteria>

<output>
After completion, create `.planning/phases/04-test-coverage/04-02-SUMMARY.md`
</output>
