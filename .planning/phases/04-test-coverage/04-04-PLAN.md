---
phase: 04-test-coverage
plan: 04
type: execute
wave: 2
depends_on: ["04-01", "04-02", "04-03"]
files_modified: []
autonomous: true

must_haves:
  truths:
    - "Overall package coverage is measured"
    - "Coverage report identifies remaining gaps"
    - "Coverage target achievement is documented"
  artifacts:
    - path: ".planning/phases/04-test-coverage/COVERAGE-REPORT.md"
      provides: "Coverage analysis and gap identification"
      min_lines: 30
  key_links:
    - from: ".planning/phases/04-test-coverage/COVERAGE-REPORT.md"
      to: "tests/testthat/"
      via: "documents test coverage results"
      pattern: "coverage|percent"
---

<objective>
Run overall package coverage analysis and document results against 80% target.

Purpose: TEST-06 requires 80%+ overall package coverage. This plan measures final coverage after all test additions and identifies any remaining gaps.

Output:
- Coverage analysis results
- `.planning/phases/04-test-coverage/COVERAGE-REPORT.md` documenting coverage by file and overall
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-test-coverage/04-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run full package coverage analysis</name>
  <files></files>
  <action>
Run comprehensive coverage analysis on the entire package.

```r
# Full package coverage
cov <- covr::package_coverage()

# Overall percentage
overall_pct <- covr::percent_coverage(cov)
cat("Overall package coverage:", round(overall_pct, 1), "%\n")

# Coverage by file
file_cov <- covr::tally_coverage(cov, by = "file")
print(file_cov[order(file_cov$percent), c("filename", "percent")])

# Target files specifically
target_files <- c(
  "R/zarr_backend.R",
  "R/h5_backend.R",
  "R/as_delayed_array.R",
  "R/as_delayed_array_dataset.R",
  "R/dataset_methods.R"
)

for (f in target_files) {
  file_row <- file_cov[file_cov$filename == f, ]
  if (nrow(file_row) > 0) {
    cat(f, ":", round(file_row$percent, 1), "%\n")
  }
}
```

Record:
1. Overall package coverage percentage
2. Coverage for each target file
3. List of files below 80% threshold
  </action>
  <verify>
```bash
cd /Users/bbuchsbaum/code/fmridataset && Rscript -e "
cov <- covr::package_coverage()
pct <- covr::percent_coverage(cov)
cat('Overall coverage:', round(pct, 1), '%\n')
cat('Target:', ifelse(pct >= 80, 'MET', 'NOT MET'), '\n')
"
```
  </verify>
  <done>Full package coverage measured and recorded</done>
</task>

<task type="auto">
  <name>Task 2: Identify and document coverage gaps</name>
  <files>.planning/phases/04-test-coverage/COVERAGE-REPORT.md</files>
  <action>
Create `.planning/phases/04-test-coverage/COVERAGE-REPORT.md` documenting:

1. **Overall Coverage Summary**
   - Overall percentage vs 80% target
   - Status: MET/NOT MET

2. **Target File Coverage Table**

| File | Before | After | Target | Status |
|------|--------|-------|--------|--------|
| zarr_backend.R | 5% | X% | 80% | MET/GAP |
| h5_backend.R | 26% | X% | 80% | MET/GAP |
| as_delayed_array.R | 10% | X% | 80% | MET/GAP |
| as_delayed_array_dataset.R | 6% | X% | 80% | MET/GAP |
| dataset_methods.R | 24% | X% | 80% | MET/GAP |

3. **Files Below 80% Threshold**
   - List any files still below 80%
   - Note if low coverage is due to optional dependencies (expected)

4. **Uncovered Lines Analysis**
   - For files with significant gaps, list key uncovered code paths
   - Note if uncovered paths are:
     - Error handlers (acceptable)
     - Optional dependency branches (expected to skip)
     - Core functionality (needs more tests)

5. **Recommendations**
   - If overall < 80%: specific files/functions to target
   - If overall >= 80%: note achievement, suggest maintenance strategy

6. **Notes on Optional Dependencies**
   - zarr tests: skipped if zarr not installed
   - h5 tests: skipped if fmristore/hdf5r not installed
   - DelayedArray tests: skipped if DelayedArray not installed
   - This means coverage varies by test environment
  </action>
  <verify>
```bash
test -f /Users/bbuchsbaum/code/fmridataset/.planning/phases/04-test-coverage/COVERAGE-REPORT.md && echo "COVERAGE-REPORT.md exists"
```
  </verify>
  <done>COVERAGE-REPORT.md created with full analysis</done>
</task>

<task type="auto">
  <name>Task 3: Run devtools::test() to verify all tests pass</name>
  <files></files>
  <action>
Run the full test suite to ensure all new tests pass without breaking existing tests.

```bash
cd /Users/bbuchsbaum/code/fmridataset && Rscript -e "devtools::test()"
```

Expected outcome:
- All tests pass or skip gracefully
- No failures or errors
- Skipped tests are due to optional dependencies (expected)

If any tests fail:
1. Document the failure
2. Determine if it's a test bug or code bug
3. Fix or document as known issue
  </action>
  <verify>
```bash
cd /Users/bbuchsbaum/code/fmridataset && Rscript -e "
result <- devtools::test()
if (any(as.data.frame(result)\$failed > 0)) {
  cat('FAILED: Some tests failed\n')
  quit(status = 1)
} else {
  cat('PASSED: All tests passed or skipped\n')
}
"
```
  </verify>
  <done>Full test suite passes with no failures</done>
</task>

</tasks>

<verification>
1. Package coverage measured
2. COVERAGE-REPORT.md created with analysis
3. All tests pass (failures = 0)
4. Coverage documented against 80% target
</verification>

<success_criteria>
- Overall package coverage documented (target: 80%+)
- Each target file coverage documented
- Coverage report explains any gaps due to optional dependencies
- Test suite passes with no failures
</success_criteria>

<output>
After completion, create `.planning/phases/04-test-coverage/04-04-SUMMARY.md`
</output>
