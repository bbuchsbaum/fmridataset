---
phase: 04-test-coverage
plan: 04
type: execute
wave: 2
depends_on: ["01", "02", "03"]
files_modified: []
autonomous: true

must_haves:
  truths:
    - "Overall package coverage >= 80% (or documented reason if lower)"
    - "All 5 target files achieve 80%+ coverage (or skip documented)"
    - "Coverage report identifies specific uncovered code paths"
    - "Full test suite passes with zero failures"
  artifacts:
    - path: ".planning/phases/04-test-coverage/COVERAGE-REPORT.md"
      provides: "Coverage analysis and gap identification"
      min_lines: 30
      contains: ["Overall Coverage Summary", "Target File Coverage Table", "Recommendations"]
  key_links:
    - from: ".planning/phases/04-test-coverage/COVERAGE-REPORT.md"
      to: "tests/testthat/"
      via: "documents test coverage results"
      pattern: "coverage|percent"
---

<objective>
Run overall package coverage analysis and document results against 80% target.

Purpose: TEST-06 requires 80%+ overall package coverage. This plan measures final coverage after all test additions and identifies any remaining gaps.

Output:
- Coverage analysis results
- `.planning/phases/04-test-coverage/COVERAGE-REPORT.md` documenting coverage by file and overall
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-test-coverage/04-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run full package coverage analysis</name>
  <files></files>
  <action>
Run comprehensive coverage analysis on the entire package.

```r
# Full package coverage
cov <- covr::package_coverage()

# Overall percentage
overall_pct <- covr::percent_coverage(cov)
cat("Overall package coverage:", round(overall_pct, 1), "%\n")

# Coverage by file
file_cov <- covr::tally_coverage(cov, by = "file")
print(file_cov[order(file_cov$percent), c("filename", "percent")])

# Target files specifically
target_files <- c(
  "R/zarr_backend.R",
  "R/h5_backend.R",
  "R/as_delayed_array.R",
  "R/as_delayed_array_dataset.R",
  "R/dataset_methods.R"
)

for (f in target_files) {
  file_row <- file_cov[file_cov$filename == f, ]
  if (nrow(file_row) > 0) {
    cat(f, ":", round(file_row$percent, 1), "%\n")
  }
}
```

Record:
1. Overall package coverage percentage
2. Coverage for each target file
3. List of files below 80% threshold
  </action>
  <verify>
```bash
cd /Users/bbuchsbaum/code/fmridataset && Rscript -e "
cov <- covr::package_coverage()
pct <- covr::percent_coverage(cov)
cat('Overall coverage:', round(pct, 1), '%\n')
cat('Target:', ifelse(pct >= 80, 'MET', 'NOT MET'), '\n')
"
```
  </verify>
  <done>Full package coverage measured and recorded</done>
</task>

<task type="auto">
  <name>Task 2: Create COVERAGE-REPORT.md with required sections</name>
  <files>.planning/phases/04-test-coverage/COVERAGE-REPORT.md</files>
  <action>
Create `.planning/phases/04-test-coverage/COVERAGE-REPORT.md` with the following **required sections**:

**1. Overall Coverage Summary** (REQUIRED)
```markdown
## Overall Coverage Summary

- **Overall Coverage:** X.X%
- **Target:** 80%
- **Status:** MET / NOT MET
- **Date:** YYYY-MM-DD
```

**2. Target File Coverage Table** (REQUIRED)
```markdown
## Target File Coverage Table

| File | Before | After | Target | Status |
|------|--------|-------|--------|--------|
| zarr_backend.R | 5% | X% | 80% | MET/GAP |
| h5_backend.R | 26% | X% | 80% | MET/GAP |
| as_delayed_array.R | 10% | X% | 80% | MET/GAP |
| as_delayed_array_dataset.R | 6% | X% | 80% | MET/GAP |
| dataset_methods.R | 24% | X% | 80% | MET/GAP |
```

**3. Files Below 80% Threshold** (REQUIRED)
- List any files still below 80%
- Note if low coverage is due to optional dependencies (expected)

**4. Uncovered Lines Analysis** (REQUIRED)
- For files with significant gaps, list key uncovered code paths
- Note if uncovered paths are:
  - Error handlers (acceptable)
  - Optional dependency branches (expected to skip)
  - Core functionality (needs more tests)

**5. Recommendations** (REQUIRED)
- If overall < 80%: specific files/functions to target
- If overall >= 80%: note achievement, suggest maintenance strategy

**6. Notes on Optional Dependencies** (REQUIRED)
- zarr tests: skipped if zarr not installed
- h5 tests: skipped if fmristore/hdf5r not installed
- DelayedArray tests: skipped if DelayedArray not installed
- This means coverage varies by test environment
  </action>
  <verify>
```bash
cd /Users/bbuchsbaum/code/fmridataset && Rscript -e "
report_path <- '.planning/phases/04-test-coverage/COVERAGE-REPORT.md'

# Check file exists
if (!file.exists(report_path)) {
  stop('COVERAGE-REPORT.md does not exist')
}

# Read content
content <- readLines(report_path)
full_text <- paste(content, collapse = '\n')

# Check required sections
required_sections <- c(
  'Overall Coverage Summary',
  'Target File Coverage Table',
  'Files Below 80%',
  'Uncovered Lines Analysis',
  'Recommendations',
  'Notes on Optional Dependencies'
)

missing <- character(0)
for (section in required_sections) {
  if (!grepl(section, full_text, ignore.case = TRUE)) {
    missing <- c(missing, section)
  }
}

if (length(missing) > 0) {
  stop('Missing required sections: ', paste(missing, collapse = ', '))
}

# Check minimum length
if (length(content) < 30) {
  stop('COVERAGE-REPORT.md has only ', length(content), ' lines (minimum: 30)')
}

cat('COVERAGE-REPORT.md validation PASSED\n')
cat('- File exists: YES\n')
cat('- All 6 required sections: YES\n')
cat('- Minimum 30 lines:', length(content), 'lines\n')
"
```
  </verify>
  <done>COVERAGE-REPORT.md created with all 6 required sections: Overall Coverage Summary, Target File Coverage Table, Files Below 80% Threshold, Uncovered Lines Analysis, Recommendations, Notes on Optional Dependencies</done>
</task>

<task type="auto">
  <name>Task 3: Run devtools::test() to verify all tests pass</name>
  <files></files>
  <action>
Run the full test suite to ensure all new tests pass without breaking existing tests.

```bash
cd /Users/bbuchsbaum/code/fmridataset && Rscript -e "devtools::test()"
```

Expected outcome:
- All tests pass or skip gracefully
- No failures or errors
- Skipped tests are due to optional dependencies (expected)

If any tests fail:
1. Document the failure
2. Determine if it's a test bug or code bug
3. Fix or document as known issue
  </action>
  <verify>
```bash
cd /Users/bbuchsbaum/code/fmridataset && Rscript -e "
result <- devtools::test()
if (any(as.data.frame(result)\$failed > 0)) {
  cat('FAILED: Some tests failed\n')
  quit(status = 1)
} else {
  cat('PASSED: All tests passed or skipped\n')
}
"
```
  </verify>
  <done>Full test suite passes with no failures</done>
</task>

</tasks>

<verification>
1. Package coverage measured
2. COVERAGE-REPORT.md created with all 6 required sections
3. COVERAGE-REPORT.md validated (exists, contains required sections, >= 30 lines)
4. All tests pass (failures = 0)
5. Coverage documented against 80% target
</verification>

<success_criteria>
- Overall package coverage documented with concrete percentage (target: >= 80%)
- Each target file coverage documented with before/after comparison
- Coverage report contains all 6 required sections with valid content
- Test suite passes with no failures
</success_criteria>

<output>
After completion, create `.planning/phases/04-test-coverage/04-04-SUMMARY.md`
</output>
