---
phase: 04-test-coverage
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/testthat/test-as_delayed_array.R
  - tests/testthat/test-dataset_methods.R
autonomous: true

must_haves:
  truths:
    - "as_delayed_array converts matrix_backend to DelayedArray"
    - "as_delayed_array converts nifti_backend to DelayedArray"
    - "as_delayed_array converts study_backend to DelayedArray"
    - "as_delayed_array errors gracefully when DelayedArray unavailable"
    - "as_delayed_array.default errors with unknown class"
    - "Dataset methods delegate to sampling_frame correctly"
    - "All 5 dataset classes support all 9 delegated methods"
    - "Tests skip gracefully when DelayedArray unavailable"
  artifacts:
    - path: "tests/testthat/test-as_delayed_array.R"
      provides: "Tests for as_delayed_array.R (backends) AND as_delayed_array_dataset.R (datasets) - single file covers both source files"
      min_lines: 120
    - path: "tests/testthat/test-dataset_methods.R"
      provides: "Tests for dataset_methods.R delegation"
      min_lines: 100
  key_links:
    - from: "tests/testthat/test-as_delayed_array.R"
      to: "R/as_delayed_array.R"
      via: "tests as_delayed_array() generic and backend methods"
      pattern: "as_delayed_array.*backend"
    - from: "tests/testthat/test-as_delayed_array.R"
      to: "R/as_delayed_array_dataset.R"
      via: "tests as_delayed_array() dataset methods (same test file, separate test sections)"
      pattern: "as_delayed_array.*dataset"
    - from: "tests/testthat/test-dataset_methods.R"
      to: "R/dataset_methods.R"
      via: "tests delegation to sampling_frame"
      pattern: "get_TR|n_timepoints|n_runs|blocklens|blockids"
---

<objective>
Create comprehensive tests for as_delayed_array.R, as_delayed_array_dataset.R, and dataset_methods.R to achieve 80%+ coverage.

Purpose: TEST-03, TEST-04, TEST-05 require coverage improvements for DelayedArray conversions and dataset method delegation.

Output:
- `tests/testthat/test-as_delayed_array.R` covering backend conversions (as_delayed_array.R) AND dataset conversions (as_delayed_array_dataset.R) in separate test sections within the same file
- `tests/testthat/test-dataset_methods.R` covering all delegated methods for all dataset classes
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-test-coverage/04-CONTEXT.md
@.planning/phases/04-test-coverage/04-RESEARCH.md
@R/as_delayed_array.R
@R/as_delayed_array_dataset.R
@R/dataset_methods.R
@R/dataset_constructors.R
</context>

<file_coverage_note>
**Clarification:** test-as_delayed_array.R is a SINGLE test file that covers TWO source files:
- `R/as_delayed_array.R` (backend conversions) - tested in "Backend conversion tests" section
- `R/as_delayed_array_dataset.R` (dataset conversions) - tested in "Dataset conversion tests" section

This is intentional because both files implement the same generic (`as_delayed_array`) and are logically related. The test file uses `describe()` or `context()` blocks to separate backend vs dataset tests clearly.
</file_coverage_note>

<tasks>

<task type="auto">
  <name>Task 1: Create as_delayed_array tests for backends</name>
  <files>tests/testthat/test-as_delayed_array.R</files>
  <action>
Create `tests/testthat/test-as_delayed_array.R` with tests for as_delayed_array.R (backend methods).

**File structure:**
```r
# test-as_delayed_array.R
# Tests for both as_delayed_array.R (backends) and as_delayed_array_dataset.R (datasets)

# ============================================
# Section 1: Backend conversion tests (as_delayed_array.R)
# ============================================

# ... backend tests here (Task 1) ...

# ============================================
# Section 2: Dataset conversion tests (as_delayed_array_dataset.R)
# ============================================

# ... dataset tests here (Task 2) ...
```

**Guard function tests (test even without DelayedArray):**

1. "as_delayed_array is generic function":
   - Verify `is.function(as_delayed_array)` is TRUE
   - Verify it's an S3 generic using `isS3stdGeneric()`

2. ".ensure_delayed_array errors when DelayedArray unavailable":
   - Use `withr::with_options()` to set `fmridataset.disable_delayedarray = TRUE`
   - Call `.ensure_delayed_array()` (via `fmridataset:::.ensure_delayed_array()`)
   - Expect error "DelayedArray support is disabled"

3. "as_delayed_array.default errors with unknown class":
   - Create object with class "unknown_class"
   - Call `as_delayed_array()` on it
   - Expect error "No as_delayed_array method for class: unknown_class"

**Backend conversion tests (require DelayedArray):**

Use `skip_if_not_installed("DelayedArray")` for these tests.

4. "as_delayed_array converts matrix_backend":
   - Create matrix_backend with 10x20 matrix
   - Convert with as_delayed_array()
   - Verify result is S4 class "DelayedArray" or "DelayedMatrix"
   - Verify dim() matches original (rows=10, cols=sum(mask))
   - Verify data values match via as.matrix()

5. "as_delayed_array.matrix_backend subsetting works":
   - Create DelayedArray from matrix_backend
   - Subset [1:5, 1:10]
   - Verify subset dimensions
   - Verify subset values match original

6. "as_delayed_array converts nifti_backend":
   - Skip if no nifti test files available (use dummy_mode if needed)
   - Create nifti_backend
   - Convert with as_delayed_array()
   - Verify DelayedArray class
   - Note: May need to mock or use existing test infrastructure

7. "as_delayed_array converts study_backend":
   - Create two matrix_backends
   - Create study_backend from them
   - Convert with as_delayed_array()
   - Verify DelayedArray class
   - Verify dimensions reflect combined data

8. "register_delayed_array_support is idempotent":
   - Call register_delayed_array_support() twice
   - Second call should return silently (check `.delayed_array_support_env$registered`)
  </action>
  <verify>
```bash
cd /Users/bbuchsbaum/code/fmridataset && Rscript -e "devtools::test(filter = 'as_delayed_array')"
```
Tests pass or skip gracefully when DelayedArray unavailable.
  </verify>
  <done>test-as_delayed_array.R has backend conversion tests (Section 1) with proper skip guards</done>
</task>

<task type="auto">
  <name>Task 2: Add as_delayed_array tests for datasets</name>
  <files>tests/testthat/test-as_delayed_array.R</files>
  <action>
Extend `tests/testthat/test-as_delayed_array.R` with tests for as_delayed_array_dataset.R (Section 2).

**Dataset conversion tests (require DelayedArray):**

1. "as_delayed_array converts matrix_dataset":
   - Create matrix_dataset(matrix(1:100, 10, 10), TR=2, run_length=10)
   - Convert with as_delayed_array()
   - Verify DelayedArray class
   - Verify dim() matches (10 rows, sum(mask) cols)

2. "as_delayed_array converts fmri_mem_dataset":
   - Skip if neuroim2 unavailable
   - Create NeuroVec and NeuroVol mask
   - Create fmri_mem_dataset
   - Convert with as_delayed_array()
   - Verify DelayedArray class

3. "as_delayed_array converts fmri_file_dataset":
   - Create fmri_file_dataset with backend
   - Convert with as_delayed_array()
   - Verify DelayedArray class
   - Verify dimension match

4. "as_delayed_array fmri_file_dataset errors on legacy object":
   - Create mock object with class "fmri_file_dataset" but NULL backend
   - Expect error "not supported for legacy fmri_file_dataset"

**S4 method dispatch verification:**

5. "as_delayed_array S4 methods are registered":
   - Verify methods exist for matrix_dataset, fmri_file_dataset, fmri_mem_dataset
   - Use `methods::hasMethod("as_delayed_array", "matrix_dataset")`
  </action>
  <verify>
```bash
cd /Users/bbuchsbaum/code/fmridataset && Rscript -e "devtools::test(filter = 'as_delayed_array')"
```
All as_delayed_array tests pass or skip gracefully.
  </verify>
  <done>test-as_delayed_array.R covers both backend conversions (Section 1, as_delayed_array.R) and dataset conversions (Section 2, as_delayed_array_dataset.R)</done>
</task>

<task type="auto">
  <name>Task 3: Create dataset_methods delegation tests</name>
  <files>tests/testthat/test-dataset_methods.R</files>
  <action>
Create `tests/testthat/test-dataset_methods.R` with comprehensive delegation tests.

**Test strategy:**
For each of the 5 dataset classes, test all 9 delegated methods return correct values from sampling_frame.

**5 dataset classes to test:**
1. matrix_dataset
2. fmri_dataset (alias for fmri_file_dataset)
3. fmri_mem_dataset
4. fmri_file_dataset
5. fmri_study_dataset

**9 delegated methods to test:**
1. get_TR()
2. n_timepoints()
3. n_runs()
4. get_run_lengths() / blocklens()
5. blocklens()
6. blockids()
7. get_run_duration()
8. get_total_duration()
9. samples()

**matrix_dataset tests (no skip guards needed - pure R):**

1. "matrix_dataset delegates get_TR correctly":
   - Create dataset with TR=2.5
   - Verify get_TR(dataset) == 2.5

2. "matrix_dataset delegates n_timepoints correctly":
   - Create dataset with 100 row matrix
   - Verify n_timepoints(dataset) == 100

3. "matrix_dataset delegates n_runs correctly":
   - Create with run_length = c(50, 50)
   - Verify n_runs(dataset) == 2

4. "matrix_dataset delegates get_run_lengths correctly":
   - Create with run_length = c(30, 40, 30)
   - Verify get_run_lengths(dataset) == c(30, 40, 30)

5. "matrix_dataset delegates blocklens correctly":
   - Verify blocklens(dataset) matches run_length

6. "matrix_dataset delegates blockids correctly":
   - Verify blockids(dataset) returns run indices for each timepoint

7. "matrix_dataset delegates get_run_duration correctly":
   - TR=2, run_length=50 means duration=100s per run
   - Verify get_run_duration(dataset) returns correct values

8. "matrix_dataset delegates get_total_duration correctly":
   - TR=2, total 100 timepoints = 200s total
   - Verify get_total_duration(dataset) == 200

9. "matrix_dataset delegates samples correctly":
   - Verify samples(dataset) returns sample indices

**fmri_mem_dataset tests (require neuroim2):**

10. "fmri_mem_dataset delegation works":
    - Skip if neuroim2 unavailable
    - Create fmri_mem_dataset
    - Test get_TR, n_timepoints, n_runs all delegate correctly

**fmri_file_dataset tests (use dummy_mode):**

11. "fmri_file_dataset delegation works":
    - Create fmri_dataset with dummy_mode=TRUE
    - Test delegation methods

**fmri_study_dataset tests:**

12. "fmri_study_dataset has correct n_runs":
    - Create from two matrix_datasets with 2 runs each
    - Verify n_runs returns correct count

13. "fmri_study_dataset subject_ids method works":
    - Create with subject_ids = c("S01", "S02")
    - Verify subject_ids(dataset) returns correct IDs
  </action>
  <verify>
```bash
cd /Users/bbuchsbaum/code/fmridataset && Rscript -e "devtools::test(filter = 'dataset_methods')"
```
All dataset_methods tests pass.
  </verify>
  <done>test-dataset_methods.R comprehensively tests delegation: all 9 methods (get_TR, n_timepoints, n_runs, get_run_lengths, blocklens, blockids, get_run_duration, get_total_duration, samples) for all 5 dataset classes (matrix_dataset, fmri_dataset, fmri_mem_dataset, fmri_file_dataset, fmri_study_dataset)</done>
</task>

</tasks>

<verification>
1. `tests/testthat/test-as_delayed_array.R` exists with backend tests (Section 1) and dataset tests (Section 2)
2. `tests/testthat/test-dataset_methods.R` exists with delegation tests
3. `devtools::test(filter = "as_delayed|dataset_methods")` passes
4. Coverage improvement verified for:
   - as_delayed_array.R (from 10%)
   - as_delayed_array_dataset.R (from 6%)
   - dataset_methods.R (from 24%)
</verification>

<success_criteria>
- as_delayed_array conversions tested for all backend and dataset types
- DelayedArray optional dependency handled with skip guards
- All 9 delegated methods tested for all 5 dataset classes
- Coverage moves toward 80% target for all three files
</success_criteria>

<output>
After completion, create `.planning/phases/04-test-coverage/04-03-SUMMARY.md`
</output>
