---
phase: 04-test-coverage
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/testthat/helper-backends.R
  - tests/testthat/test-zarr_backend.R
autonomous: true

must_haves:
  truths:
    - "zarr_backend constructor validates inputs correctly"
    - "zarr_backend open/close lifecycle works"
    - "zarr_backend get_dims returns correct dimensions"
    - "zarr_backend get_mask returns valid mask"
    - "zarr_backend get_data returns correct data subsets"
    - "zarr_backend get_metadata returns format info"
    - "Tests skip gracefully when zarr package unavailable"
  artifacts:
    - path: "tests/testthat/helper-backends.R"
      provides: "Shared test data generators for backend tests"
      exports: ["create_test_zarr", "create_test_h5", "create_test_matrix"]
    - path: "tests/testthat/test-zarr_backend.R"
      provides: "Comprehensive zarr_backend tests"
      min_lines: 150
  key_links:
    - from: "tests/testthat/test-zarr_backend.R"
      to: "R/zarr_backend.R"
      via: "tests zarr_backend() constructor and backend_* methods"
      pattern: "zarr_backend|backend_open|backend_close|backend_get_"
    - from: "tests/testthat/helper-backends.R"
      to: "tests/testthat/test-zarr_backend.R"
      via: "provides create_test_zarr() helper"
      pattern: "create_test_zarr"
---

<objective>
Create test helper functions and comprehensive tests for zarr_backend.R to achieve 80%+ coverage.

Purpose: TEST-01 requires zarr_backend.R coverage from 5% to 80%+. Helper functions enable consistent test data generation across all backend tests.

Output:
- `tests/testthat/helper-backends.R` with `create_test_zarr()`, `create_test_h5()`, `create_test_matrix()` helpers
- `tests/testthat/test-zarr_backend.R` with comprehensive backend method tests
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-test-coverage/04-CONTEXT.md
@.planning/phases/04-test-coverage/04-RESEARCH.md
@R/zarr_backend.R
@tests/testthat/helper-golden.R
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create helper-backends.R with test data generators</name>
  <files>tests/testthat/helper-backends.R</files>
  <action>
Create `tests/testthat/helper-backends.R` with shared helper functions for backend testing:

1. `create_test_zarr(dims = c(4, 4, 4, 10), path = NULL)`:
   - Use `skip_if_not_installed("zarr")` at start
   - Generate random array with given dimensions using `set.seed(42)` for reproducibility
   - Write to Zarr v3 store using `zarr::zarr_create()` and bracket assignment
   - Return path to store
   - If path is NULL, use `tempfile(pattern = "zarr_test_")`

2. `create_test_h5(dims = c(4, 4, 4, 10), path = NULL)`:
   - Use `skip_if_not_installed("hdf5r")` at start
   - Generate random 4D array
   - Write to HDF5 using hdf5r::H5File
   - Create "data" dataset with the array
   - Close file properly
   - Return path

3. `create_test_matrix(n_time = 10, n_voxels = 64)`:
   - Generate random matrix (time x voxels)
   - Return matrix directly (no file needed)

4. `create_test_mask(n_voxels = 64, proportion_valid = 0.8)`:
   - Generate logical mask with given proportion TRUE
   - Return logical vector

Use minimal dimensions (4x4x4x10) for fast tests. Set `set.seed(42)` before random generation for reproducibility.
  </action>
  <verify>
```r
# In R console after devtools::load_all()
source("tests/testthat/helper-backends.R")
# Should define the helper functions without error
exists("create_test_zarr")
exists("create_test_h5")
exists("create_test_matrix")
```
  </verify>
  <done>helper-backends.R exists with all four helper functions defined</done>
</task>

<task type="auto">
  <name>Task 2: Create comprehensive zarr_backend tests</name>
  <files>tests/testthat/test-zarr_backend.R</files>
  <action>
Create `tests/testthat/test-zarr_backend.R` with comprehensive tests for zarr_backend.R.

**Test groups to cover (use `skip_if_not_installed("zarr")` in each test):**

1. **Constructor validation tests:**
   - `zarr_backend()` with valid path returns object with correct class
   - `zarr_backend(NULL)` errors with "source must be a single character string"
   - `zarr_backend(c("a", "b"))` errors (multiple paths)
   - `zarr_backend(123)` errors (wrong type)
   - Test preload parameter is stored

2. **Backend lifecycle tests:**
   - Create real Zarr store using `create_test_zarr()` in `withr::local_tempdir()`
   - `backend_open()` on new backend sets is_open = TRUE
   - `backend_open()` on already-open backend returns unchanged
   - `backend_close()` clears zarr_array and sets is_open = FALSE
   - Test backend state after close (zarr_array should be NULL)

3. **backend_get_dims tests:**
   - Returns list with `spatial` and `time` components
   - `spatial` is numeric vector of length 3
   - `time` is single integer
   - Dimensions match what was written

4. **backend_get_mask tests:**
   - Returns logical vector
   - Length equals prod(spatial_dims)
   - All TRUE by default (Zarr backend returns all-valid mask)
   - No NA values in mask

5. **backend_get_data tests:**
   - Full data retrieval (rows=NULL, cols=NULL)
   - Subset rows only
   - Subset cols only
   - Subset both rows and cols
   - Error on closed backend ("Backend must be opened")
   - Error on invalid row indices
   - Error on invalid col indices

6. **backend_get_metadata tests:**
   - Returns list with storage_format = "zarr"
   - Contains zarr_version field
   - Error on closed backend

7. **Error path tests:**
   - `backend_open()` on non-existent path errors with "Zarr store not found"
   - Test non-4D array rejection (if possible to create)

**Pattern to follow:**
```r
test_that("description", {
  skip_if_not_installed("zarr")

  tmp_dir <- withr::local_tempdir()
  zarr_path <- create_test_zarr(dims = c(4, 4, 4, 10), path = file.path(tmp_dir, "test.zarr"))

  backend <- zarr_backend(zarr_path)
  # ... test assertions
})
```
  </action>
  <verify>
```bash
cd /Users/bbuchsbaum/code/fmridataset && Rscript -e "devtools::test(filter = 'zarr_backend')"
```
Tests should pass (or skip gracefully if zarr not installed).
  </verify>
  <done>test-zarr_backend.R exists with tests covering constructor, lifecycle, get_dims, get_mask, get_data, get_metadata, and error paths</done>
</task>

<task type="auto">
  <name>Task 3: Verify zarr_backend coverage improvement</name>
  <files></files>
  <action>
Run coverage analysis on zarr_backend.R to verify improvement toward 80% target.

1. Run file-specific coverage:
```r
cov <- covr::file_coverage("R/zarr_backend.R", "tests/testthat/test-zarr_backend.R")
covr::percent_coverage(cov)
```

2. If coverage is below 80%, identify uncovered lines:
```r
uncovered <- covr::zero_coverage(cov)
print(uncovered)
```

3. If significant gaps remain, add targeted tests for uncovered code paths:
   - Preload branch (line 134-137)
   - Large data reading branch (proportion > 0.5)
   - Metadata attribute extraction branches

Note: If zarr package is not installed, this task will produce minimal coverage data. The tests are designed to skip gracefully in that case.
  </action>
  <verify>
```bash
cd /Users/bbuchsbaum/code/fmridataset && Rscript -e "
if (requireNamespace('zarr', quietly = TRUE)) {
  cov <- covr::file_coverage('R/zarr_backend.R', 'tests/testthat/test-zarr_backend.R')
  pct <- covr::percent_coverage(cov)
  cat('zarr_backend.R coverage:', round(pct, 1), '%\n')
  if (pct < 80) {
    cat('WARNING: Coverage below 80% target\n')
    print(covr::zero_coverage(cov))
  }
} else {
  cat('zarr package not installed - skipping coverage check\n')
}
"
```
  </verify>
  <done>Coverage analysis complete; zarr_backend.R coverage is documented (80%+ if zarr available, or graceful skip documented)</done>
</task>

</tasks>

<verification>
1. `tests/testthat/helper-backends.R` exists with helper functions
2. `tests/testthat/test-zarr_backend.R` exists with comprehensive tests
3. `devtools::test(filter = "zarr_backend")` passes or skips gracefully
4. Coverage analysis shows improvement from 5% baseline
</verification>

<success_criteria>
- helper-backends.R provides reusable test data generators
- test-zarr_backend.R tests all zarr_backend methods systematically
- Tests skip gracefully when zarr package unavailable
- Coverage moves toward 80% target (verified if zarr available)
</success_criteria>

<output>
After completion, create `.planning/phases/04-test-coverage/04-01-SUMMARY.md`
</output>
