<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Advanced Backend Development: Storage Extensions â€¢ fmridataset</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Advanced Backend Development: Storage Extensions">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">fmridataset</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.8.9</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/architecture-overview.html">Architecture Deep Dive: Design Principles and Extensibility</a></li>
    <li><a class="dropdown-item" href="../articles/backend-development-basics.html">Backend Development Basics: Creating Custom Storage Backends</a></li>
    <li><a class="dropdown-item" href="../articles/backend-registry.html">Backend Registry: Extending Data Format Support</a></li>
    <li><a class="dropdown-item" href="../articles/extending-backends.html">Advanced Backend Development: Storage Extensions</a></li>
    <li><a class="dropdown-item" href="../articles/fmridataset-intro.html">Getting Started with fmridataset</a></li>
    <li><a class="dropdown-item" href="../articles/h5-backend-usage.html">HDF5 Storage: High-Performance Data Management for Large-Scale fMRI Studies</a></li>
    <li><a class="dropdown-item" href="../articles/study-level-analysis.html">Scaling to Study-Level Analysis: From Single Subjects to Group Studies</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/bbuchsbaum/fmridataset/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Advanced Backend Development: Storage Extensions</h1>
                        <h4 data-toc-skip class="author">fmridataset
Team</h4>
            
            <h4 data-toc-skip class="date">2026-01-22</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/bbuchsbaum/fmridataset/blob/main/vignettes/extending-backends.Rmd" class="external-link"><code>vignettes/extending-backends.Rmd</code></a></small>
      <div class="d-none name"><code>extending-backends.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="motivation-beyond-basic-backends">Motivation: Beyond Basic Backends<a class="anchor" aria-label="anchor" href="#motivation-beyond-basic-backends"></a>
</h2>
<p>This scenario requires backends supporting proprietary formats with
complex metadata, hierarchical organization, and advanced compression.
Data includes fMRI time series, physiological recordings, eye tracking
data, and quality metrics. Standard file-based backends cannot handle
this structure, requiring streaming access, caching, and integration
with data management systems.</p>
<p>This vignette covers advanced backend development techniques
extending the basic contract for production storage systems. Topics
include caching strategies, streaming data access, error handling,
performance optimization, and integration patterns for complex data
sources.</p>
</div>
<div class="section level2">
<h2 id="quick-start-production-backend-example">Quick Start: Production Backend Example<a class="anchor" aria-label="anchor" href="#quick-start-production-backend-example"></a>
</h2>
<p>This example implements a NeuroStream backend demonstrating advanced
techniques including streaming capabilities, metadata handling, and
caching:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bbuchsbaum/fmridataset" class="external-link">fmridataset</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Step 1: Create a sophisticated NeuroStream backend</span></span>
<span><span class="va">neurostream_backend</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">stream_url</span>, <span class="va">cache_dir</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                                <span class="va">chunk_size_mb</span> <span class="op">=</span> <span class="fl">64</span>, <span class="va">compression</span> <span class="op">=</span> <span class="st">"auto"</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Advanced input validation</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">is.character</a></span><span class="op">(</span><span class="va">stream_url</span><span class="op">)</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">stream_url</span><span class="op">)</span> <span class="op">!=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"stream_url must be a single character string"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"^(http|file|neurostream)://"</span>, <span class="va">stream_url</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"Invalid stream URL format. Expected protocol prefix (http://, file://, or neurostream://)"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Validate cache configuration</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">cache_dir</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.exists</a></span><span class="op">(</span><span class="va">cache_dir</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span></span>
<span>        <span class="op">{</span></span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">cache_dir</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>        <span class="op">}</span>,</span>
<span>        error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"Cannot create cache directory: "</span>, <span class="va">cache_dir</span>, <span class="st">" - "</span>, <span class="fu"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">conditionMessage</a></span><span class="op">(</span><span class="va">e</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Validate chunk size</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">is.numeric</a></span><span class="op">(</span><span class="va">chunk_size_mb</span><span class="op">)</span> <span class="op">||</span> <span class="va">chunk_size_mb</span> <span class="op">&lt;=</span> <span class="fl">0</span> <span class="op">||</span> <span class="va">chunk_size_mb</span> <span class="op">&gt;</span> <span class="fl">1024</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"chunk_size_mb must be between 1 and 1024 MB"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Initialize connection metadata</span></span>
<span>  <span class="va">connection_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span></span>
<span>    <span class="st">"ns_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"%Y%m%d_%H%M%S"</span><span class="op">)</span>, <span class="st">"_"</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">:</span><span class="fl">9999</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Create advanced backend object</span></span>
<span>  <span class="va">backend</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="co"># Core configuration</span></span>
<span>    stream_url <span class="op">=</span> <span class="va">stream_url</span>,</span>
<span>    cache_dir <span class="op">=</span> <span class="va">cache_dir</span>,</span>
<span>    chunk_size_mb <span class="op">=</span> <span class="va">chunk_size_mb</span>,</span>
<span>    compression <span class="op">=</span> <span class="va">compression</span>,</span>
<span>    connection_id <span class="op">=</span> <span class="va">connection_id</span>,</span>
<span></span>
<span>    <span class="co"># State management</span></span>
<span>    is_open <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    is_streaming <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    connection_handle <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span></span>
<span>    <span class="co"># Data caching</span></span>
<span>    metadata_cache <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    spatial_cache <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    temporal_cache <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    data_chunks_cache <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span></span>
<span>    <span class="co"># Performance tracking</span></span>
<span>    bytes_read <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    cache_hits <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    cache_misses <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    last_access_time <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span></span>
<span>    <span class="co"># Advanced features</span></span>
<span>    streaming_buffer <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    compression_ratio <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    error_recovery_attempts <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    max_error_recovery_attempts <span class="op">=</span> <span class="fl">3</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">backend</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"neurostream_backend"</span>, <span class="st">"storage_backend"</span><span class="op">)</span></span>
<span>  <span class="va">backend</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Step 2: Implement sophisticated backend methods</span></span>
<span><span class="va">backend_open.neurostream_backend</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">backend</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">backend</span><span class="op">$</span><span class="va">is_open</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">backend</span><span class="op">)</span> <span class="co"># Already open</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Opening NeuroStream connection:"</span>, <span class="va">backend</span><span class="op">$</span><span class="va">connection_id</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Simulate connection establishment with error recovery</span></span>
<span>  <span class="va">attempt</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>  <span class="kw">while</span> <span class="op">(</span><span class="va">attempt</span> <span class="op">&lt;=</span> <span class="va">backend</span><span class="op">$</span><span class="va">max_error_recovery_attempts</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span></span>
<span>      <span class="op">{</span></span>
<span>        <span class="co"># Simulate connection process</span></span>
<span>        <span class="va">backend</span><span class="op">$</span><span class="va">connection_handle</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>          url <span class="op">=</span> <span class="va">backend</span><span class="op">$</span><span class="va">stream_url</span>,</span>
<span>          established_at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>          protocol_version <span class="op">=</span> <span class="st">"2.1"</span>,</span>
<span>          server_capabilities <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"streaming"</span>, <span class="st">"compression"</span>, <span class="st">"metadata_queries"</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span></span>
<span>        <span class="co"># Fetch and cache metadata</span></span>
<span>        <span class="va">backend</span><span class="op">$</span><span class="va">metadata_cache</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>          format_version <span class="op">=</span> <span class="st">"NeuroStream-2.1"</span>,</span>
<span>          spatial_dims <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">64</span>, <span class="fl">64</span>, <span class="fl">40</span><span class="op">)</span>,</span>
<span>          temporal_length <span class="op">=</span> <span class="fl">300</span>,</span>
<span>          acquisition_params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>            TR <span class="op">=</span> <span class="fl">2.0</span>,</span>
<span>            TE <span class="op">=</span> <span class="fl">30</span>,</span>
<span>            flip_angle <span class="op">=</span> <span class="fl">90</span>,</span>
<span>            voxel_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span></span>
<span>          <span class="op">)</span>,</span>
<span>          quality_metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>            snr_estimate <span class="op">=</span> <span class="fl">45.2</span>,</span>
<span>            motion_max <span class="op">=</span> <span class="fl">0.8</span>,</span>
<span>            temporal_variance <span class="op">=</span> <span class="fl">12.3</span></span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span></span>
<span>        <span class="co"># Initialize spatial structures</span></span>
<span>        <span class="va">backend</span><span class="op">$</span><span class="va">spatial_cache</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>          mask <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">TRUE</span>, <span class="fu"><a href="https://rdrr.io/r/base/prod.html" class="external-link">prod</a></span><span class="op">(</span><span class="va">backend</span><span class="op">$</span><span class="va">metadata_cache</span><span class="op">$</span><span class="va">spatial_dims</span><span class="op">)</span><span class="op">)</span>,</span>
<span>          roi_labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"region_"</span>, <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/prod.html" class="external-link">prod</a></span><span class="op">(</span><span class="va">backend</span><span class="op">$</span><span class="va">metadata_cache</span><span class="op">$</span><span class="va">spatial_dims</span><span class="op">)</span><span class="op">)</span>,</span>
<span>          coordinates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span></span>
<span>            x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">backend</span><span class="op">$</span><span class="va">metadata_cache</span><span class="op">$</span><span class="va">spatial_dims</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>            y <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">backend</span><span class="op">$</span><span class="va">metadata_cache</span><span class="op">$</span><span class="va">spatial_dims</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,</span>
<span>            z <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">backend</span><span class="op">$</span><span class="va">metadata_cache</span><span class="op">$</span><span class="va">spatial_dims</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span></span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span></span>
<span>        <span class="co"># Setup temporal structures</span></span>
<span>        <span class="va">backend</span><span class="op">$</span><span class="va">temporal_cache</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>          timepoints <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">backend</span><span class="op">$</span><span class="va">metadata_cache</span><span class="op">$</span><span class="va">temporal_length</span>,</span>
<span>          acquisition_times <span class="op">=</span> <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">backend</span><span class="op">$</span><span class="va">metadata_cache</span><span class="op">$</span><span class="va">temporal_length</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span></span>
<span>            <span class="va">backend</span><span class="op">$</span><span class="va">metadata_cache</span><span class="op">$</span><span class="va">acquisition_params</span><span class="op">$</span><span class="va">TR</span>,</span>
<span>          run_boundaries <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">151</span>, <span class="fl">301</span><span class="op">)</span>, <span class="co"># Example run structure</span></span>
<span>          quality_flags <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"good"</span>, <span class="va">backend</span><span class="op">$</span><span class="va">metadata_cache</span><span class="op">$</span><span class="va">temporal_length</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span></span>
<span>        <span class="co"># Initialize streaming if supported</span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="st">"streaming"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">backend</span><span class="op">$</span><span class="va">connection_handle</span><span class="op">$</span><span class="va">server_capabilities</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="va">backend</span><span class="op">$</span><span class="va">is_streaming</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span>          <span class="va">backend</span><span class="op">$</span><span class="va">streaming_buffer</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>            buffer_size_mb <span class="op">=</span> <span class="va">backend</span><span class="op">$</span><span class="va">chunk_size_mb</span>,</span>
<span>            current_buffer <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>            buffer_range <span class="op">=</span> <span class="cn">NULL</span></span>
<span>          <span class="op">)</span></span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Streaming mode enabled\n"</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span></span>
<span>        <span class="va">backend</span><span class="op">$</span><span class="va">is_open</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span>        <span class="va">backend</span><span class="op">$</span><span class="va">last_access_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"NeuroStream connection established successfully\n"</span><span class="op">)</span></span>
<span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">backend</span><span class="op">)</span></span>
<span>      <span class="op">}</span>,</span>
<span>      error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Connection attempt"</span>, <span class="va">attempt</span>, <span class="st">"failed:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">conditionMessage</a></span><span class="op">(</span><span class="va">e</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>        <span class="va">attempt</span> <span class="op">&lt;-</span> <span class="va">attempt</span> <span class="op">+</span> <span class="fl">1</span></span>
<span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="va">attempt</span> <span class="op">&lt;=</span> <span class="va">backend</span><span class="op">$</span><span class="va">max_error_recovery_attempts</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Retrying in"</span>, <span class="va">attempt</span>, <span class="st">"seconds...\n"</span><span class="op">)</span></span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html" class="external-link">Sys.sleep</a></span><span class="op">(</span><span class="va">attempt</span><span class="op">)</span> <span class="co"># Exponential backoff</span></span>
<span>        <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>          <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span></span>
<span>            <span class="st">"Failed to establish NeuroStream connection after "</span>,</span>
<span>            <span class="va">backend</span><span class="op">$</span><span class="va">max_error_recovery_attempts</span>, <span class="st">" attempts: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">conditionMessage</a></span><span class="op">(</span><span class="va">e</span><span class="op">)</span></span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">backend_close.neurostream_backend</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">backend</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">backend</span><span class="op">$</span><span class="va">is_open</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Closing NeuroStream connection:"</span>, <span class="va">backend</span><span class="op">$</span><span class="va">connection_id</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Report performance statistics</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">backend</span><span class="op">$</span><span class="va">bytes_read</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">cache_hit_rate</span> <span class="op">&lt;-</span> <span class="va">backend</span><span class="op">$</span><span class="va">cache_hits</span> <span class="op">/</span> <span class="op">(</span><span class="va">backend</span><span class="op">$</span><span class="va">cache_hits</span> <span class="op">+</span> <span class="va">backend</span><span class="op">$</span><span class="va">cache_misses</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Performance summary:\n"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Bytes read:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">backend</span><span class="op">$</span><span class="va">bytes_read</span>, units <span class="op">=</span> <span class="st">"auto"</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Cache hit rate:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">cache_hit_rate</span>, <span class="fl">1</span><span class="op">)</span>, <span class="st">"%\n"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span></span>
<span>      <span class="st">"  Compression ratio:"</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">backend</span><span class="op">$</span><span class="va">compression_ratio</span><span class="op">)</span>, <span class="st">"N/A"</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">backend</span><span class="op">$</span><span class="va">compression_ratio</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">":1"</span><span class="op">)</span></span>
<span>      <span class="op">)</span>, <span class="st">"\n"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Clear caches and release resources</span></span>
<span>  <span class="va">backend</span><span class="op">$</span><span class="va">data_chunks_cache</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">backend</span><span class="op">$</span><span class="va">streaming_buffer</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>  <span class="va">backend</span><span class="op">$</span><span class="va">connection_handle</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>  <span class="va">backend</span><span class="op">$</span><span class="va">is_open</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span>
<span>  <span class="va">backend</span><span class="op">$</span><span class="va">is_streaming</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"NeuroStream connection closed\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">backend_get_dims.neurostream_backend</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">backend</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">backend</span><span class="op">$</span><span class="va">is_open</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"NeuroStream backend must be opened before querying dimensions"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Use cached metadata for fast response</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    spatial <span class="op">=</span> <span class="va">backend</span><span class="op">$</span><span class="va">metadata_cache</span><span class="op">$</span><span class="va">spatial_dims</span>,</span>
<span>    time <span class="op">=</span> <span class="va">backend</span><span class="op">$</span><span class="va">metadata_cache</span><span class="op">$</span><span class="va">temporal_length</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">backend_get_mask.neurostream_backend</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">backend</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">backend</span><span class="op">$</span><span class="va">is_open</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"NeuroStream backend must be opened before accessing mask"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Return cached mask</span></span>
<span>  <span class="va">backend</span><span class="op">$</span><span class="va">spatial_cache</span><span class="op">$</span><span class="va">mask</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">backend_get_data.neurostream_backend</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">backend</span>, <span class="va">rows</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">cols</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">backend</span><span class="op">$</span><span class="va">is_open</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"NeuroStream backend must be opened before accessing data"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">backend</span><span class="op">$</span><span class="va">last_access_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Determine data requirements</span></span>
<span>  <span class="va">total_timepoints</span> <span class="op">&lt;-</span> <span class="va">backend</span><span class="op">$</span><span class="va">metadata_cache</span><span class="op">$</span><span class="va">temporal_length</span></span>
<span>  <span class="va">total_voxels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">backend</span><span class="op">$</span><span class="va">spatial_cache</span><span class="op">$</span><span class="va">mask</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">requested_rows</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">rows</span><span class="op">)</span><span class="op">)</span> <span class="fl">1</span><span class="op">:</span><span class="va">total_timepoints</span> <span class="kw">else</span> <span class="va">rows</span></span>
<span>  <span class="va">requested_cols</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">cols</span><span class="op">)</span><span class="op">)</span> <span class="fl">1</span><span class="op">:</span><span class="va">total_voxels</span> <span class="kw">else</span> <span class="va">cols</span></span>
<span></span>
<span>  <span class="co"># Check cache first</span></span>
<span>  <span class="va">cache_key</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span></span>
<span>    <span class="st">"data_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">requested_rows</span><span class="op">)</span>, <span class="st">"_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">requested_rows</span><span class="op">)</span>,</span>
<span>    <span class="st">"_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">requested_cols</span><span class="op">)</span>, <span class="st">"_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">requested_cols</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">cache_key</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">backend</span><span class="op">$</span><span class="va">data_chunks_cache</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">backend</span><span class="op">$</span><span class="va">cache_hits</span> <span class="op">&lt;-</span> <span class="va">backend</span><span class="op">$</span><span class="va">cache_hits</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Cache hit for data request\n"</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">backend</span><span class="op">$</span><span class="va">data_chunks_cache</span><span class="op">[[</span><span class="va">cache_key</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">backend</span><span class="op">$</span><span class="va">cache_misses</span> <span class="op">&lt;-</span> <span class="va">backend</span><span class="op">$</span><span class="va">cache_misses</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Cache miss - fetching data from stream\n"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Simulate intelligent data fetching</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span></span>
<span>    <span class="op">{</span></span>
<span>      <span class="co"># For demo, create synthetic data with realistic characteristics</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span> <span class="co"># Reproducible for vignette</span></span>
<span></span>
<span>      <span class="co"># Simulate streaming data with temporal autocorrelation</span></span>
<span>      <span class="va">n_rows</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">requested_rows</span><span class="op">)</span></span>
<span>      <span class="va">n_cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">requested_cols</span><span class="op">)</span></span>
<span></span>
<span>      <span class="co"># Create base signal with temporal structure</span></span>
<span>      <span class="va">base_signal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_rows</span> <span class="op">*</span> <span class="va">n_cols</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="va">n_rows</span>, ncol <span class="op">=</span> <span class="va">n_cols</span><span class="op">)</span></span>
<span></span>
<span>      <span class="co"># Add temporal autocorrelation</span></span>
<span>      <span class="kw">for</span> <span class="op">(</span><span class="va">col</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_cols</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw">for</span> <span class="op">(</span><span class="va">row</span> <span class="kw">in</span> <span class="fl">2</span><span class="op">:</span><span class="va">n_rows</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="va">base_signal</span><span class="op">[</span><span class="va">row</span>, <span class="va">col</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.7</span> <span class="op">*</span> <span class="va">base_signal</span><span class="op">[</span><span class="va">row</span> <span class="op">-</span> <span class="fl">1</span>, <span class="va">col</span><span class="op">]</span> <span class="op">+</span></span>
<span>            <span class="fl">0.3</span> <span class="op">*</span> <span class="va">base_signal</span><span class="op">[</span><span class="va">row</span>, <span class="va">col</span><span class="op">]</span></span>
<span>        <span class="op">}</span></span>
<span>      <span class="op">}</span></span>
<span></span>
<span>      <span class="co"># Add spatial correlation structure</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="va">n_cols</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">spatial_kernel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/dist.html" class="external-link">dist</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n_cols</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fl">5</span><span class="op">)</span></span>
<span>        <span class="kw">for</span> <span class="op">(</span><span class="va">row</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_rows</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="va">base_signal</span><span class="op">[</span><span class="va">row</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">base_signal</span><span class="op">[</span><span class="va">row</span>, <span class="op">]</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">spatial_kernel</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">spatial_kernel</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>      <span class="op">}</span></span>
<span></span>
<span>      <span class="co"># Cache the result</span></span>
<span>      <span class="va">backend</span><span class="op">$</span><span class="va">data_chunks_cache</span><span class="op">[[</span><span class="va">cache_key</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">base_signal</span></span>
<span></span>
<span>      <span class="co"># Update performance metrics</span></span>
<span>      <span class="va">estimated_bytes</span> <span class="op">&lt;-</span> <span class="va">n_rows</span> <span class="op">*</span> <span class="va">n_cols</span> <span class="op">*</span> <span class="fl">8</span> <span class="co"># 8 bytes per double</span></span>
<span>      <span class="va">backend</span><span class="op">$</span><span class="va">bytes_read</span> <span class="op">&lt;-</span> <span class="va">backend</span><span class="op">$</span><span class="va">bytes_read</span> <span class="op">+</span> <span class="va">estimated_bytes</span></span>
<span></span>
<span>      <span class="co"># Simulate compression ratio</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="va">backend</span><span class="op">$</span><span class="va">compression</span> <span class="op">!=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">backend</span><span class="op">$</span><span class="va">compression_ratio</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2.5</span>, <span class="fl">4.0</span><span class="op">)</span> <span class="co"># Typical fMRI compression</span></span>
<span>      <span class="op">}</span></span>
<span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Fetched"</span>, <span class="va">n_rows</span>, <span class="st">"Ã—"</span>, <span class="va">n_cols</span>, <span class="st">"data matrix from NeuroStream\n"</span><span class="op">)</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">base_signal</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">backend</span><span class="op">$</span><span class="va">error_recovery_attempts</span> <span class="op">&lt;-</span> <span class="va">backend</span><span class="op">$</span><span class="va">error_recovery_attempts</span> <span class="op">+</span> <span class="fl">1</span></span>
<span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="va">backend</span><span class="op">$</span><span class="va">error_recovery_attempts</span> <span class="op">&lt;=</span> <span class="va">backend</span><span class="op">$</span><span class="va">max_error_recovery_attempts</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Data fetch error, attempting recovery:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">conditionMessage</a></span><span class="op">(</span><span class="va">e</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html" class="external-link">Sys.sleep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="../reference/backend_get_data.html">backend_get_data</a></span><span class="op">(</span><span class="va">backend</span>, <span class="va">rows</span>, <span class="va">cols</span><span class="op">)</span><span class="op">)</span> <span class="co"># Recursive retry</span></span>
<span>      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"Failed to fetch data after multiple attempts: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">conditionMessage</a></span><span class="op">(</span><span class="va">e</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">backend_get_metadata.neurostream_backend</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">backend</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">base_metadata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    format <span class="op">=</span> <span class="st">"NeuroStream"</span>,</span>
<span>    stream_url <span class="op">=</span> <span class="va">backend</span><span class="op">$</span><span class="va">stream_url</span>,</span>
<span>    connection_id <span class="op">=</span> <span class="va">backend</span><span class="op">$</span><span class="va">connection_id</span>,</span>
<span>    is_open <span class="op">=</span> <span class="va">backend</span><span class="op">$</span><span class="va">is_open</span>,</span>
<span>    is_streaming <span class="op">=</span> <span class="va">backend</span><span class="op">$</span><span class="va">is_streaming</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">backend</span><span class="op">$</span><span class="va">is_open</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Include rich metadata when connection is active</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">base_metadata</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      acquisition_params <span class="op">=</span> <span class="va">backend</span><span class="op">$</span><span class="va">metadata_cache</span><span class="op">$</span><span class="va">acquisition_params</span>,</span>
<span>      quality_metrics <span class="op">=</span> <span class="va">backend</span><span class="op">$</span><span class="va">metadata_cache</span><span class="op">$</span><span class="va">quality_metrics</span>,</span>
<span>      performance_stats <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        bytes_read <span class="op">=</span> <span class="va">backend</span><span class="op">$</span><span class="va">bytes_read</span>,</span>
<span>        cache_hits <span class="op">=</span> <span class="va">backend</span><span class="op">$</span><span class="va">cache_hits</span>,</span>
<span>        cache_misses <span class="op">=</span> <span class="va">backend</span><span class="op">$</span><span class="va">cache_misses</span>,</span>
<span>        cache_hit_rate <span class="op">=</span> <span class="kw">if</span> <span class="op">(</span><span class="op">(</span><span class="va">backend</span><span class="op">$</span><span class="va">cache_hits</span> <span class="op">+</span> <span class="va">backend</span><span class="op">$</span><span class="va">cache_misses</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="va">backend</span><span class="op">$</span><span class="va">cache_hits</span> <span class="op">/</span> <span class="op">(</span><span class="va">backend</span><span class="op">$</span><span class="va">cache_hits</span> <span class="op">+</span> <span class="va">backend</span><span class="op">$</span><span class="va">cache_misses</span><span class="op">)</span></span>
<span>        <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>          <span class="fl">0</span></span>
<span>        <span class="op">}</span></span>
<span>      <span class="op">)</span>,</span>
<span>      server_info <span class="op">=</span> <span class="va">backend</span><span class="op">$</span><span class="va">connection_handle</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"protocol_version"</span>, <span class="st">"server_capabilities"</span><span class="op">)</span><span class="op">]</span></span>
<span>    <span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">base_metadata</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Step 3: Register the advanced backend</span></span>
<span><span class="fu"><a href="../reference/register_backend.html">register_backend</a></span><span class="op">(</span></span>
<span>  name <span class="op">=</span> <span class="st">"neurostream"</span>,</span>
<span>  factory <span class="op">=</span> <span class="va">neurostream_backend</span>,</span>
<span>  description <span class="op">=</span> <span class="st">"Advanced NeuroStream backend with streaming, caching, and error recovery"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"NeuroStream backend registered with advanced features\n"</span><span class="op">)</span></span></code></pre></div>
<p>Now letâ€™s demonstrate the advanced backend in action:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create and use the advanced backend</span></span>
<span><span class="va">ns_backend</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_backend.html">create_backend</a></span><span class="op">(</span><span class="st">"neurostream"</span>,</span>
<span>  stream_url <span class="op">=</span> <span class="st">"neurostream://example.server.edu/study123"</span>,</span>
<span>  cache_dir <span class="op">=</span> <span class="st">"/tmp/neurostream_cache"</span>,</span>
<span>  chunk_size_mb <span class="op">=</span> <span class="fl">32</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Open with sophisticated connection management</span></span>
<span><span class="va">ns_backend</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/backend_open.html">backend_open</a></span><span class="op">(</span><span class="va">ns_backend</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Query rich metadata</span></span>
<span><span class="va">metadata</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/backend_get_metadata.html">backend_get_metadata</a></span><span class="op">(</span><span class="va">ns_backend</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Connected to:"</span>, <span class="va">metadata</span><span class="op">$</span><span class="va">stream_url</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Protocol version:"</span>, <span class="va">metadata</span><span class="op">$</span><span class="va">server_info</span><span class="op">$</span><span class="va">protocol_version</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Server capabilities:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">metadata</span><span class="op">$</span><span class="va">server_info</span><span class="op">$</span><span class="va">server_capabilities</span>, collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Use in dataset creation</span></span>
<span><span class="va">dataset</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fmri_dataset.html">fmri_dataset</a></span><span class="op">(</span></span>
<span>  scans <span class="op">=</span> <span class="va">ns_backend</span>,</span>
<span>  TR <span class="op">=</span> <span class="va">metadata</span><span class="op">$</span><span class="va">acquisition_params</span><span class="op">$</span><span class="va">TR</span>,</span>
<span>  run_length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">150</span>, <span class="fl">150</span><span class="op">)</span> <span class="co"># Two 150-timepoint runs</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Created advanced dataset with NeuroStream backend\n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/print.html">print</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Demonstrate intelligent caching</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"First data access (cache miss):\n"</span><span class="op">)</span></span>
<span><span class="va">data1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_data_matrix.html">get_data_matrix</a></span><span class="op">(</span><span class="va">dataset</span>, run_id <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Data dimensions:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">data1</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Second data access (cache hit):\n"</span><span class="op">)</span></span>
<span><span class="va">data2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_data_matrix.html">get_data_matrix</a></span><span class="op">(</span><span class="va">dataset</span>, run_id <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Data dimensions:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">data2</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Show performance statistics</span></span>
<span><span class="va">final_metadata</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/backend_get_metadata.html">backend_get_metadata</a></span><span class="op">(</span><span class="va">ns_backend</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span></span>
<span>  <span class="st">"Final cache hit rate:"</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">final_metadata</span><span class="op">$</span><span class="va">performance_stats</span><span class="op">$</span><span class="va">cache_hit_rate</span> <span class="op">*</span> <span class="fl">100</span>, <span class="fl">1</span><span class="op">)</span>, <span class="st">"%\n"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Clean shutdown</span></span>
<span><span class="fu"><a href="../reference/backend_close.html">backend_close</a></span><span class="op">(</span><span class="va">ns_backend</span><span class="op">)</span></span></code></pre></div>
<p><strong>Implementation Summary</strong>: Advanced backends implement
streaming protocols, multi-tier caching, error recovery, and performance
monitoring while maintaining interface compatibility with the standard
backend contract.</p>
</div>
<div class="section level2">
<h2 id="understanding-advanced-backend-patterns">Understanding Advanced Backend Patterns<a class="anchor" aria-label="anchor" href="#understanding-advanced-backend-patterns"></a>
</h2>
<p>The NeuroStream backend example showcases several advanced patterns
that are essential for production-quality backend development. These
patterns address real-world challenges like network reliability, memory
efficiency, and performance optimization.</p>
<div class="section level3">
<h3 id="intelligent-caching-strategies">Intelligent Caching Strategies<a class="anchor" aria-label="anchor" href="#intelligent-caching-strategies"></a>
</h3>
<p>Modern neuroimaging datasets are often too large to fit entirely in
memory, but they exhibit access patterns that can be exploited through
intelligent caching. The NeuroStream backend implements a sophisticated
caching system that tracks both spatial and temporal access patterns to
optimize performance.</p>
<p>The caching system maintains separate caches for metadata, spatial
information, and data chunks. Metadata is cached aggressively since itâ€™s
small but frequently accessed. Spatial information like masks and
coordinates is cached because itâ€™s static throughout an analysis
session. Data chunks are cached based on access patterns, with recently
used chunks kept in memory while older chunks are evicted.</p>
<p>This multi-tier caching approach ensures that common access patterns
(like processing runs sequentially or repeatedly accessing the same
voxel subsets) achieve high cache hit rates while preventing memory
exhaustion. The system also tracks cache performance, providing insights
into access patterns that can inform future optimizations.</p>
</div>
<div class="section level3">
<h3 id="error-recovery-and-resilience">Error Recovery and Resilience<a class="anchor" aria-label="anchor" href="#error-recovery-and-resilience"></a>
</h3>
<p>Network-based backends must handle connection failures, timeouts, and
data corruption gracefully. The NeuroStream backend implements
exponential backoff retry logic, connection health monitoring, and
graceful degradation strategies that keep analyses running even when
network conditions are poor.</p>
<p>The error recovery system distinguishes between different types of
failures and applies appropriate recovery strategies. Transient network
errors trigger automatic retries with exponential backoff, while
protocol errors or authentication failures fail fast with informative
error messages. The system also tracks error rates and can switch to
alternative connection methods when primary connections become
unreliable.</p>
<p>This resilience is crucial for long-running analyses that might span
hours or days. Rather than failing completely when network issues occur,
the backend attempts recovery while providing progress feedback to
users. This approach significantly improves the reliability of analyses
involving remote or cloud-based data sources.</p>
</div>
<div class="section level3">
<h3 id="streaming-and-progressive-loading">Streaming and Progressive Loading<a class="anchor" aria-label="anchor" href="#streaming-and-progressive-loading"></a>
</h3>
<p>For very large datasets, traditional approaches that load entire
datasets into memory become impractical. The NeuroStream backend
implements streaming protocols that enable progressive data loading,
where only the currently needed data is transferred and cached
locally.</p>
<p>The streaming system coordinates with the caching layer to predict
future data needs based on current access patterns. When sequential
access is detected, the system pre-fetches upcoming data chunks. When
random access patterns are detected, it focuses on caching recently
accessed chunks. This adaptive behavior ensures optimal performance
across different analysis patterns.</p>
<p>Streaming also enables real-time analysis scenarios where data is
generated continuously during acquisition. The backend can connect to
live data streams and provide access to data as it becomes available,
enabling real-time quality monitoring and adaptive experimental
paradigms.</p>
</div>
</div>
<div class="section level2">
<h2 id="deep-dive-advanced-backend-features">Deep Dive: Advanced Backend Features<a class="anchor" aria-label="anchor" href="#deep-dive-advanced-backend-features"></a>
</h2>
<p>With the foundational patterns established, letâ€™s explore specific
advanced features that distinguish production-quality backends from
basic implementations.</p>
<div class="section level3">
<h3 id="protocol-abstraction-and-versioning">Protocol Abstraction and Versioning<a class="anchor" aria-label="anchor" href="#protocol-abstraction-and-versioning"></a>
</h3>
<p>Sophisticated backends often need to support multiple protocol
versions or data format variants. The NeuroStream backend demonstrates
how to implement protocol abstraction that enables backward
compatibility and feature negotiation:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Advanced protocol handling</span></span>
<span><span class="va">implement_protocol_negotiation</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">backend</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">negotiate_protocol</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">backend</span>, <span class="va">requested_version</span> <span class="op">=</span> <span class="st">"2.1"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Simulate protocol negotiation</span></span>
<span>    <span class="va">server_versions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"1.0"</span>, <span class="st">"1.5"</span>, <span class="st">"2.0"</span>, <span class="st">"2.1"</span><span class="op">)</span></span>
<span>    <span class="va">client_versions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"2.0"</span>, <span class="st">"2.1"</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Find highest common version</span></span>
<span>    <span class="va">common_versions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">intersect</a></span><span class="op">(</span><span class="va">server_versions</span>, <span class="va">client_versions</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">common_versions</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"No compatible protocol version found"</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="va">negotiated_version</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">common_versions</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Negotiated protocol version:"</span>, <span class="va">negotiated_version</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Configure backend based on negotiated version</span></span>
<span>    <span class="va">backend</span><span class="op">$</span><span class="va">protocol_version</span> <span class="op">&lt;-</span> <span class="va">negotiated_version</span></span>
<span>    <span class="va">backend</span><span class="op">$</span><span class="va">features</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/switch.html" class="external-link">switch</a></span><span class="op">(</span><span class="va">negotiated_version</span>,</span>
<span>      <span class="st">"1.0"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"basic_access"</span><span class="op">)</span>,</span>
<span>      <span class="st">"1.5"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"basic_access"</span>, <span class="st">"metadata_queries"</span><span class="op">)</span>,</span>
<span>      <span class="st">"2.0"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"basic_access"</span>, <span class="st">"metadata_queries"</span>, <span class="st">"chunked_transfer"</span><span class="op">)</span>,</span>
<span>      <span class="st">"2.1"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>        <span class="st">"basic_access"</span>, <span class="st">"metadata_queries"</span>, <span class="st">"chunked_transfer"</span>,</span>
<span>        <span class="st">"streaming"</span>, <span class="st">"compression"</span>, <span class="st">"quality_metrics"</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">backend</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Version-specific method dispatch</span></span>
<span>  <span class="va">get_data_v1</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">backend</span>, <span class="va">rows</span>, <span class="va">cols</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Using v1.x data access protocol\n"</span><span class="op">)</span></span>
<span>    <span class="co"># Simple data access implementation</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">get_data_v2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">backend</span>, <span class="va">rows</span>, <span class="va">cols</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Using v2.x data access protocol with streaming\n"</span><span class="op">)</span></span>
<span>    <span class="co"># Advanced streaming implementation</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Dynamic method selection based on protocol version</span></span>
<span>  <span class="va">select_implementation</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">backend</span>, <span class="va">operation</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">version_major</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="va">backend</span><span class="op">$</span><span class="va">protocol_version</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">implementations</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      <span class="st">"1"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>get_data <span class="op">=</span> <span class="va">get_data_v1</span><span class="op">)</span>,</span>
<span>      <span class="st">"2"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>get_data <span class="op">=</span> <span class="va">get_data_v2</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">implementations</span><span class="op">[[</span><span class="va">version_major</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="va">operation</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Protocol abstraction framework implemented\n"</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>negotiate <span class="op">=</span> <span class="va">negotiate_protocol</span>, select <span class="op">=</span> <span class="va">select_implementation</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Example usage</span></span>
<span><span class="va">protocol_system</span> <span class="op">&lt;-</span> <span class="fu">implement_protocol_negotiation</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># enhanced_backend &lt;- protocol_system$negotiate(backend, "2.1")</span></span></code></pre></div>
<p>This protocol abstraction enables backends to work across different
server versions and gracefully handle feature unavailability.</p>
</div>
<div class="section level3">
<h3 id="advanced-memory-management">Advanced Memory Management<a class="anchor" aria-label="anchor" href="#advanced-memory-management"></a>
</h3>
<p>Production backends must carefully manage memory usage to handle
datasets that exceed available RAM. The NeuroStream backend implements
sophisticated memory management including memory-mapped files, lazy
loading, and intelligent cache eviction:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Advanced memory management system</span></span>
<span><span class="va">implement_memory_management</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">backend</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Memory usage tracking</span></span>
<span>  <span class="va">track_memory_usage</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">backend</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"pryr"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">current_usage</span> <span class="op">&lt;-</span> <span class="fu">pryr</span><span class="fu">::</span><span class="fu">mem_used</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">backend</span><span class="op">$</span><span class="va">memory_stats</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        current_usage <span class="op">=</span> <span class="va">current_usage</span>,</span>
<span>        peak_usage <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">backend</span><span class="op">$</span><span class="va">memory_stats</span><span class="op">$</span><span class="va">peak_usage</span> <span class="op"><a href="../reference/grapes-or-or-grapes.html">%||%</a></span> <span class="fl">0</span>, <span class="va">current_usage</span><span class="op">)</span>,</span>
<span>        last_check <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">backend</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Intelligent cache eviction</span></span>
<span>  <span class="va">implement_cache_eviction</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">backend</span>, <span class="va">max_cache_size_mb</span> <span class="op">=</span> <span class="fl">256</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">cache_size_mb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">backend</span><span class="op">$</span><span class="va">data_chunks_cache</span>, <span class="kw">function</span><span class="op">(</span><span class="va">chunk</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">is.matrix</a></span><span class="op">(</span><span class="va">chunk</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">chunk</span><span class="op">)</span> <span class="op">/</span> <span class="fl">1e6</span> <span class="kw">else</span> <span class="fl">0</span></span>
<span>    <span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">cache_size_mb</span> <span class="op">&gt;</span> <span class="va">max_cache_size_mb</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span></span>
<span>        <span class="st">"Cache size ("</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">cache_size_mb</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>        <span class="st">"MB) exceeds limit, evicting least recently used items\n"</span></span>
<span>      <span class="op">)</span></span>
<span></span>
<span>      <span class="co"># Sort cache items by access time (simulated)</span></span>
<span>      <span class="va">cache_access_times</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">backend</span><span class="op">$</span><span class="va">data_chunks_cache</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">key</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="co"># In practice, track actual access times</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="co"># Simulate access time</span></span>
<span>      <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>      <span class="co"># Remove oldest items until under limit</span></span>
<span>      <span class="va">sorted_keys</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">cache_access_times</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="va">keys_to_remove</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>      <span class="kw">for</span> <span class="op">(</span><span class="va">key</span> <span class="kw">in</span> <span class="va">sorted_keys</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="va">cache_size_mb</span> <span class="op">&lt;=</span> <span class="va">max_cache_size_mb</span><span class="op">)</span> <span class="kw">break</span></span>
<span></span>
<span>        <span class="va">chunk_size_mb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">backend</span><span class="op">$</span><span class="va">data_chunks_cache</span><span class="op">[[</span><span class="va">key</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="fl">1e6</span></span>
<span>        <span class="va">backend</span><span class="op">$</span><span class="va">data_chunks_cache</span><span class="op">[[</span><span class="va">key</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>        <span class="va">cache_size_mb</span> <span class="op">&lt;-</span> <span class="va">cache_size_mb</span> <span class="op">-</span> <span class="va">chunk_size_mb</span></span>
<span>        <span class="va">keys_to_remove</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">keys_to_remove</span>, <span class="va">key</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Evicted"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">keys_to_remove</span><span class="op">)</span>, <span class="st">"cache items\n"</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">backend</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Memory-mapped file support</span></span>
<span>  <span class="va">implement_memory_mapping</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">backend</span>, <span class="va">file_path</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"mmap"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Using memory-mapped file access for large data\n"</span><span class="op">)</span></span>
<span>      <span class="co"># In practice, implement actual memory mapping</span></span>
<span>      <span class="va">backend</span><span class="op">$</span><span class="va">memory_mapped</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span>      <span class="va">backend</span><span class="op">$</span><span class="va">mmap_handle</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>file <span class="op">=</span> <span class="va">file_path</span>, mapping <span class="op">=</span> <span class="st">"simulated"</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Memory mapping not available, using standard file access\n"</span><span class="op">)</span></span>
<span>      <span class="va">backend</span><span class="op">$</span><span class="va">memory_mapped</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">backend</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Adaptive loading strategies</span></span>
<span>  <span class="va">implement_adaptive_loading</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">backend</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Analyze access patterns to optimize loading strategy</span></span>
<span>    <span class="va">analyze_access_pattern</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">access_history</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">access_history</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">3</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="st">"random"</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span></span>
<span>      <span class="co"># Detect sequential access</span></span>
<span>      <span class="va">diffs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="va">access_history</span><span class="op">)</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="va">diffs</span> <span class="op">==</span> <span class="va">diffs</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="st">"sequential"</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span></span>
<span>      <span class="co"># Detect block access</span></span>
<span>      <span class="va">unique_diffs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">diffs</span><span class="op">)</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">unique_diffs</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="st">"block"</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="st">"random"</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="co"># Adapt loading strategy based on pattern</span></span>
<span>    <span class="va">backend</span><span class="op">$</span><span class="va">loading_strategy</span> <span class="op">&lt;-</span> <span class="fu">analyze_access_pattern</span><span class="op">(</span><span class="va">backend</span><span class="op">$</span><span class="va">access_history</span> <span class="op"><a href="../reference/grapes-or-or-grapes.html">%||%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Detected access pattern:"</span>, <span class="va">backend</span><span class="op">$</span><span class="va">loading_strategy</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Configure prefetching based on pattern</span></span>
<span>    <span class="va">backend</span><span class="op">$</span><span class="va">prefetch_size</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/switch.html" class="external-link">switch</a></span><span class="op">(</span><span class="va">backend</span><span class="op">$</span><span class="va">loading_strategy</span>,</span>
<span>      <span class="st">"sequential"</span> <span class="op">=</span> <span class="va">backend</span><span class="op">$</span><span class="va">chunk_size_mb</span> <span class="op">*</span> <span class="fl">2</span>, <span class="co"># Aggressive prefetching</span></span>
<span>      <span class="st">"block"</span> <span class="op">=</span> <span class="va">backend</span><span class="op">$</span><span class="va">chunk_size_mb</span>, <span class="co"># Moderate prefetching</span></span>
<span>      <span class="st">"random"</span> <span class="op">=</span> <span class="va">backend</span><span class="op">$</span><span class="va">chunk_size_mb</span> <span class="op">*</span> <span class="fl">0.5</span> <span class="co"># Conservative prefetching</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">backend</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    track_memory <span class="op">=</span> <span class="va">track_memory_usage</span>,</span>
<span>    evict_cache <span class="op">=</span> <span class="va">implement_cache_eviction</span>,</span>
<span>    memory_map <span class="op">=</span> <span class="va">implement_memory_mapping</span>,</span>
<span>    adapt_loading <span class="op">=</span> <span class="va">implement_adaptive_loading</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># memory_mgmt &lt;- implement_memory_management()</span></span></code></pre></div>
<p>This memory management system enables backends to handle arbitrarily
large datasets while maintaining predictable memory usage.</p>
</div>
<div class="section level3">
<h3 id="quality-assurance-and-validation">Quality Assurance and Validation<a class="anchor" aria-label="anchor" href="#quality-assurance-and-validation"></a>
</h3>
<p>Production backends should include comprehensive quality assurance
measures that detect data corruption, validate metadata consistency, and
ensure data integrity:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Comprehensive quality assurance system</span></span>
<span><span class="va">implement_quality_assurance</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">backend</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Data integrity checking</span></span>
<span>  <span class="va">validate_data_integrity</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data_chunk</span>, <span class="va">expected_checksum</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">integrity_checks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Check for invalid values</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">data_chunk</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">integrity_checks</span><span class="op">$</span><span class="va">na_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        status <span class="op">=</span> <span class="st">"WARNING"</span>,</span>
<span>        count <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">data_chunk</span><span class="op">)</span><span class="op">)</span>,</span>
<span>        proportion <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">data_chunk</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.infinite</a></span><span class="op">(</span><span class="va">data_chunk</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">integrity_checks</span><span class="op">$</span><span class="va">infinite_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        status <span class="op">=</span> <span class="st">"ERROR"</span>,</span>
<span>        count <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/is.finite.html" class="external-link">is.infinite</a></span><span class="op">(</span><span class="va">data_chunk</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="co"># Check data range</span></span>
<span>    <span class="va">data_range</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">data_chunk</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="va">data_range</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">integrity_checks</span><span class="op">$</span><span class="va">constant_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        status <span class="op">=</span> <span class="st">"WARNING"</span>,</span>
<span>        message <span class="op">=</span> <span class="st">"All values are identical"</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="co"># Check for unusual values</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">data_chunk</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1000</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">integrity_checks</span><span class="op">$</span><span class="va">extreme_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        status <span class="op">=</span> <span class="st">"WARNING"</span>,</span>
<span>        max_abs_value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">data_chunk</span><span class="op">)</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="co"># Checksum validation if provided</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">expected_checksum</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">actual_checksum</span> <span class="op">&lt;-</span> <span class="fu">digest</span><span class="fu">::</span><span class="fu"><a href="https://eddelbuettel.github.io/digest/man/digest.html" class="external-link">digest</a></span><span class="op">(</span><span class="va">data_chunk</span>, algo <span class="op">=</span> <span class="st">"md5"</span><span class="op">)</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="va">actual_checksum</span> <span class="op">!=</span> <span class="va">expected_checksum</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">integrity_checks</span><span class="op">$</span><span class="va">checksum_mismatch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>          status <span class="op">=</span> <span class="st">"ERROR"</span>,</span>
<span>          expected <span class="op">=</span> <span class="va">expected_checksum</span>,</span>
<span>          actual <span class="op">=</span> <span class="va">actual_checksum</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">integrity_checks</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Temporal consistency checking</span></span>
<span>  <span class="va">validate_temporal_consistency</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">backend</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">consistency_checks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">backend</span><span class="op">$</span><span class="va">temporal_cache</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">temporal_info</span> <span class="op">&lt;-</span> <span class="va">backend</span><span class="op">$</span><span class="va">temporal_cache</span></span>
<span></span>
<span>      <span class="co"># Check for temporal gaps</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">temporal_info</span><span class="op">$</span><span class="va">acquisition_times</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">time_diffs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="va">temporal_info</span><span class="op">$</span><span class="va">acquisition_times</span><span class="op">)</span></span>
<span>        <span class="va">expected_tr</span> <span class="op">&lt;-</span> <span class="va">backend</span><span class="op">$</span><span class="va">metadata_cache</span><span class="op">$</span><span class="va">acquisition_params</span><span class="op">$</span><span class="va">TR</span></span>
<span></span>
<span>        <span class="va">irregular_intervals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">time_diffs</span> <span class="op">-</span> <span class="va">expected_tr</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">expected_tr</span> <span class="op">*</span> <span class="fl">0.1</span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="va">irregular_intervals</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="va">consistency_checks</span><span class="op">$</span><span class="va">irregular_timing</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>            status <span class="op">=</span> <span class="st">"WARNING"</span>,</span>
<span>            irregular_count <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">irregular_intervals</span><span class="op">)</span>,</span>
<span>            max_deviation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">time_diffs</span> <span class="op">-</span> <span class="va">expected_tr</span><span class="op">)</span><span class="op">)</span></span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>      <span class="op">}</span></span>
<span></span>
<span>      <span class="co"># Check run boundary consistency</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">temporal_info</span><span class="op">$</span><span class="va">run_boundaries</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">run_lengths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>          <span class="va">temporal_info</span><span class="op">$</span><span class="va">run_boundaries</span>,</span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">temporal_info</span><span class="op">$</span><span class="va">timepoints</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>        <span class="op">)</span><span class="op">)</span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="va">run_lengths</span> <span class="op">&lt;=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="va">consistency_checks</span><span class="op">$</span><span class="va">invalid_run_boundaries</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>            status <span class="op">=</span> <span class="st">"ERROR"</span>,</span>
<span>            message <span class="op">=</span> <span class="st">"Invalid run boundary specification"</span></span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">consistency_checks</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Spatial consistency checking</span></span>
<span>  <span class="va">validate_spatial_consistency</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">backend</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">consistency_checks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">backend</span><span class="op">$</span><span class="va">spatial_cache</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">spatial_info</span> <span class="op">&lt;-</span> <span class="va">backend</span><span class="op">$</span><span class="va">spatial_cache</span></span>
<span></span>
<span>      <span class="co"># Validate mask properties</span></span>
<span>      <span class="va">mask</span> <span class="op">&lt;-</span> <span class="va">spatial_info</span><span class="op">$</span><span class="va">mask</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="op">!</span><span class="va">mask</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">consistency_checks</span><span class="op">$</span><span class="va">empty_mask</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>          status <span class="op">=</span> <span class="st">"ERROR"</span>,</span>
<span>          message <span class="op">=</span> <span class="st">"Mask contains no valid voxels"</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span></span>
<span>      <span class="co"># Check coordinate consistency</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">spatial_info</span><span class="op">$</span><span class="va">coordinates</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">expected_voxels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">spatial_info</span><span class="op">$</span><span class="va">coordinates</span><span class="op">)</span></span>
<span>        <span class="va">actual_voxels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">mask</span><span class="op">)</span></span>
<span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="va">expected_voxels</span> <span class="op">!=</span> <span class="va">actual_voxels</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="va">consistency_checks</span><span class="op">$</span><span class="va">coordinate_mismatch</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>            status <span class="op">=</span> <span class="st">"ERROR"</span>,</span>
<span>            expected_voxels <span class="op">=</span> <span class="va">expected_voxels</span>,</span>
<span>            actual_voxels <span class="op">=</span> <span class="va">actual_voxels</span></span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">consistency_checks</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Comprehensive validation report</span></span>
<span>  <span class="va">generate_validation_report</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">backend</span>, <span class="va">data_sample</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">report</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      timestamp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      backend_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">backend</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>      validation_status <span class="op">=</span> <span class="st">"PASS"</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Run all validation checks</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">data_sample</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">report</span><span class="op">$</span><span class="va">data_integrity</span> <span class="op">&lt;-</span> <span class="fu">validate_data_integrity</span><span class="op">(</span><span class="va">data_sample</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="va">report</span><span class="op">$</span><span class="va">temporal_consistency</span> <span class="op">&lt;-</span> <span class="fu">validate_temporal_consistency</span><span class="op">(</span><span class="va">backend</span><span class="op">)</span></span>
<span>    <span class="va">report</span><span class="op">$</span><span class="va">spatial_consistency</span> <span class="op">&lt;-</span> <span class="fu">validate_spatial_consistency</span><span class="op">(</span><span class="va">backend</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Determine overall status</span></span>
<span>    <span class="va">all_checks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="va">report</span><span class="op">$</span><span class="va">data_integrity</span>, <span class="va">report</span><span class="op">$</span><span class="va">temporal_consistency</span>,</span>
<span>      <span class="va">report</span><span class="op">$</span><span class="va">spatial_consistency</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="va">error_count</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">all_checks</span>, <span class="kw">function</span><span class="op">(</span><span class="va">check</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">is.list</a></span><span class="op">(</span><span class="va">check</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="st">"status"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">check</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">check</span><span class="op">$</span><span class="va">status</span> <span class="op">==</span> <span class="st">"ERROR"</span></span>
<span>      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>        <span class="cn">FALSE</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">warning_count</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">all_checks</span>, <span class="kw">function</span><span class="op">(</span><span class="va">check</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">is.list</a></span><span class="op">(</span><span class="va">check</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="st">"status"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">check</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">check</span><span class="op">$</span><span class="va">status</span> <span class="op">==</span> <span class="st">"WARNING"</span></span>
<span>      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>        <span class="cn">FALSE</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">error_count</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">report</span><span class="op">$</span><span class="va">validation_status</span> <span class="op">&lt;-</span> <span class="st">"FAIL"</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">warning_count</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">report</span><span class="op">$</span><span class="va">validation_status</span> <span class="op">&lt;-</span> <span class="st">"WARNING"</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="va">report</span><span class="op">$</span><span class="va">summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      errors <span class="op">=</span> <span class="va">error_count</span>,</span>
<span>      warnings <span class="op">=</span> <span class="va">warning_count</span>,</span>
<span>      status <span class="op">=</span> <span class="va">report</span><span class="op">$</span><span class="va">validation_status</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">report</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    validate_data <span class="op">=</span> <span class="va">validate_data_integrity</span>,</span>
<span>    validate_temporal <span class="op">=</span> <span class="va">validate_temporal_consistency</span>,</span>
<span>    validate_spatial <span class="op">=</span> <span class="va">validate_spatial_consistency</span>,</span>
<span>    generate_report <span class="op">=</span> <span class="va">generate_validation_report</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># qa_system &lt;- implement_quality_assurance()</span></span></code></pre></div>
<p>This quality assurance system provides comprehensive validation that
helps ensure data reliability and catch potential issues early in the
analysis pipeline.</p>
</div>
</div>
<div class="section level2">
<h2 id="advanced-topics">Advanced Topics<a class="anchor" aria-label="anchor" href="#advanced-topics"></a>
</h2>
<p>Once youâ€™ve mastered the fundamental advanced patterns, these
sophisticated techniques enable backends to handle the most demanding
neuroimaging scenarios.</p>
<div class="section level3">
<h3 id="distributed-and-cloud-integration">Distributed and Cloud Integration<a class="anchor" aria-label="anchor" href="#distributed-and-cloud-integration"></a>
</h3>
<p>Modern neuroimaging increasingly involves distributed computing and
cloud storage. Advanced backends can integrate with cloud services,
distributed file systems, and compute clusters:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Cloud and distributed computing integration</span></span>
<span><span class="va">implement_cloud_integration</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">backend</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Cloud storage abstraction</span></span>
<span>  <span class="va">setup_cloud_storage</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">backend</span>, <span class="va">cloud_config</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">supported_providers</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"aws"</span>, <span class="st">"gcp"</span>, <span class="st">"azure"</span>, <span class="st">"custom"</span><span class="op">)</span></span>
<span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">cloud_config</span><span class="op">$</span><span class="va">provider</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">supported_providers</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"Unsupported cloud provider: "</span>, <span class="va">cloud_config</span><span class="op">$</span><span class="va">provider</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="co"># Configure cloud-specific authentication and endpoints</span></span>
<span>    <span class="va">backend</span><span class="op">$</span><span class="va">cloud_config</span> <span class="op">&lt;-</span> <span class="va">cloud_config</span></span>
<span>    <span class="va">backend</span><span class="op">$</span><span class="va">cloud_authenticated</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Cloud storage configured for provider:"</span>, <span class="va">cloud_config</span><span class="op">$</span><span class="va">provider</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Setup cloud-specific optimizations</span></span>
<span>    <span class="va">backend</span><span class="op">$</span><span class="va">transfer_optimization</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/switch.html" class="external-link">switch</a></span><span class="op">(</span><span class="va">cloud_config</span><span class="op">$</span><span class="va">provider</span>,</span>
<span>      <span class="st">"aws"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>multipart_threshold <span class="op">=</span> <span class="fl">100e6</span>, max_concurrency <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>      <span class="st">"gcp"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>chunk_size <span class="op">=</span> <span class="fl">256e6</span>, compression <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>      <span class="st">"azure"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>block_size <span class="op">=</span> <span class="fl">100e6</span>, parallel_uploads <span class="op">=</span> <span class="fl">8</span><span class="op">)</span>,</span>
<span>      <span class="st">"custom"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>use_defaults <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">backend</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Distributed caching</span></span>
<span>  <span class="va">implement_distributed_caching</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">backend</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Simulate distributed cache coordination</span></span>
<span>    <span class="va">backend</span><span class="op">$</span><span class="va">distributed_cache</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      enabled <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>      cache_nodes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cache-01.cluster"</span>, <span class="st">"cache-02.cluster"</span>, <span class="st">"cache-03.cluster"</span><span class="op">)</span>,</span>
<span>      consistency_level <span class="op">=</span> <span class="st">"eventual"</span>, <span class="co"># or "strong"</span></span>
<span>      replication_factor <span class="op">=</span> <span class="fl">2</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Cache distribution strategy</span></span>
<span>    <span class="va">distribute_cache_item</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">cache_key</span>, <span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># Hash-based consistent distribution</span></span>
<span>      <span class="va">hash_value</span> <span class="op">&lt;-</span> <span class="fu">digest</span><span class="fu">::</span><span class="fu"><a href="https://eddelbuettel.github.io/digest/man/digest.html" class="external-link">digest</a></span><span class="op">(</span><span class="va">cache_key</span>, algo <span class="op">=</span> <span class="st">"crc32"</span><span class="op">)</span></span>
<span>      <span class="va">node_index</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strtoi.html" class="external-link">strtoi</a></span><span class="op">(</span><span class="va">hash_value</span>, <span class="fl">16L</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">backend</span><span class="op">$</span><span class="va">distributed_cache</span><span class="op">$</span><span class="va">cache_nodes</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>      <span class="va">primary_node</span> <span class="op">&lt;-</span> <span class="va">backend</span><span class="op">$</span><span class="va">distributed_cache</span><span class="op">$</span><span class="va">cache_nodes</span><span class="op">[</span><span class="va">node_index</span><span class="op">]</span></span>
<span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Distributing cache item"</span>, <span class="va">cache_key</span>, <span class="st">"to node"</span>, <span class="va">primary_node</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span></span>
<span>      <span class="co"># In practice, implement actual distributed cache protocol</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>primary_node <span class="op">=</span> <span class="va">primary_node</span>, replicated <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="va">backend</span><span class="op">$</span><span class="va">cache_distribution</span> <span class="op">&lt;-</span> <span class="va">distribute_cache_item</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">backend</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Parallel data access</span></span>
<span>  <span class="va">implement_parallel_access</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">backend</span>, <span class="va">max_workers</span> <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"parallel"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">backend</span><span class="op">$</span><span class="va">parallel_enabled</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span>      <span class="va">backend</span><span class="op">$</span><span class="va">max_workers</span> <span class="op">&lt;-</span> <span class="va">max_workers</span></span>
<span></span>
<span>      <span class="co"># Setup worker pool</span></span>
<span>      <span class="va">backend</span><span class="op">$</span><span class="va">worker_pool</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeCluster</a></span><span class="op">(</span><span class="va">max_workers</span><span class="op">)</span></span>
<span></span>
<span>      <span class="co"># Parallel data fetching strategy</span></span>
<span>      <span class="va">parallel_fetch_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data_requests</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Processing"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">data_requests</span><span class="op">)</span>, <span class="st">"data requests in parallel\n"</span><span class="op">)</span></span>
<span></span>
<span>        <span class="va">results</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">parLapply</a></span><span class="op">(</span></span>
<span>          <span class="va">backend</span><span class="op">$</span><span class="va">worker_pool</span>, <span class="va">data_requests</span>,</span>
<span>          <span class="kw">function</span><span class="op">(</span><span class="va">request</span><span class="op">)</span> <span class="op">{</span></span>
<span>            <span class="co"># Simulate parallel data access</span></span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html" class="external-link">Sys.sleep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.1</span>, <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span> <span class="co"># Simulate network/disk latency</span></span>
<span>            <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>              request <span class="op">=</span> <span class="va">request</span>, status <span class="op">=</span> <span class="st">"success"</span>,</span>
<span>              data_size <span class="op">=</span> <span class="va">request</span><span class="op">$</span><span class="va">rows</span> <span class="op">*</span> <span class="va">request</span><span class="op">$</span><span class="va">cols</span></span>
<span>            <span class="op">)</span><span class="op">)</span></span>
<span>          <span class="op">}</span></span>
<span>        <span class="op">)</span></span>
<span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span></span>
<span>      <span class="va">backend</span><span class="op">$</span><span class="va">parallel_fetch</span> <span class="op">&lt;-</span> <span class="va">parallel_fetch_data</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Parallel processing not available\n"</span><span class="op">)</span></span>
<span>      <span class="va">backend</span><span class="op">$</span><span class="va">parallel_enabled</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">backend</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    setup_cloud <span class="op">=</span> <span class="va">setup_cloud_storage</span>,</span>
<span>    distributed_cache <span class="op">=</span> <span class="va">implement_distributed_caching</span>,</span>
<span>    parallel_access <span class="op">=</span> <span class="va">implement_parallel_access</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Example cloud configuration</span></span>
<span><span class="va">cloud_config</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  provider <span class="op">=</span> <span class="st">"aws"</span>,</span>
<span>  region <span class="op">=</span> <span class="st">"us-west-2"</span>,</span>
<span>  bucket <span class="op">=</span> <span class="st">"neuroimaging-data-bucket"</span>,</span>
<span>  credentials <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    access_key_id <span class="op">=</span> <span class="st">"AKIA..."</span>,</span>
<span>    secret_access_key <span class="op">=</span> <span class="st">"..."</span>,</span>
<span>    session_token <span class="op">=</span> <span class="st">"..."</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># cloud_integration &lt;- implement_cloud_integration()</span></span></code></pre></div>
<p>This cloud integration enables backends to work seamlessly with
modern cloud-native neuroimaging workflows.</p>
</div>
<div class="section level3">
<h3 id="real-time-and-streaming-analytics">Real-Time and Streaming Analytics<a class="anchor" aria-label="anchor" href="#real-time-and-streaming-analytics"></a>
</h3>
<p>Advanced backends can support real-time data streams for online
analysis, adaptive experiments, and quality monitoring:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Real-time streaming and analytics</span></span>
<span><span class="va">implement_realtime_capabilities</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">backend</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Real-time data stream handling</span></span>
<span>  <span class="va">setup_realtime_stream</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">backend</span>, <span class="va">stream_config</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">backend</span><span class="op">$</span><span class="va">realtime_config</span> <span class="op">&lt;-</span> <span class="va">stream_config</span></span>
<span>    <span class="va">backend</span><span class="op">$</span><span class="va">stream_buffer</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      size <span class="op">=</span> <span class="va">stream_config</span><span class="op">$</span><span class="va">buffer_size</span> <span class="op"><a href="../reference/grapes-or-or-grapes.html">%||%</a></span> <span class="fl">1000</span>,</span>
<span>      data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow <span class="op">=</span> <span class="va">stream_config</span><span class="op">$</span><span class="va">buffer_size</span>, ncol <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>      timestamps <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">stream_config</span><span class="op">$</span><span class="va">buffer_size</span><span class="op">)</span>,</span>
<span>      write_index <span class="op">=</span> <span class="fl">1</span>,</span>
<span>      read_index <span class="op">=</span> <span class="fl">1</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span></span>
<span>      <span class="st">"Real-time stream configured with buffer size:"</span>,</span>
<span>      <span class="va">backend</span><span class="op">$</span><span class="va">stream_buffer</span><span class="op">$</span><span class="va">size</span>, <span class="st">"\n"</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">backend</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Online quality monitoring</span></span>
<span>  <span class="va">implement_online_qc</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">backend</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">backend</span><span class="op">$</span><span class="va">online_qc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      enabled <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>      metrics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        motion_threshold <span class="op">=</span> <span class="fl">2.0</span>, <span class="co"># mm</span></span>
<span>        signal_dropout_threshold <span class="op">=</span> <span class="fl">0.1</span>, <span class="co"># proportion</span></span>
<span>        temporal_snr_threshold <span class="op">=</span> <span class="fl">10</span>, <span class="co"># ratio</span></span>
<span>        spike_detection_threshold <span class="op">=</span> <span class="fl">3</span> <span class="co"># standard deviations</span></span>
<span>      <span class="op">)</span>,</span>
<span>      alert_callbacks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Real-time quality check function</span></span>
<span>    <span class="va">check_realtime_quality</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">new_data</span>, <span class="va">timepoint</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">qc_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>timepoint <span class="op">=</span> <span class="va">timepoint</span>, status <span class="op">=</span> <span class="st">"pass"</span>, alerts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>      <span class="co"># Motion detection (simulated)</span></span>
<span>      <span class="va">estimated_motion</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">3</span><span class="op">)</span> <span class="co"># mm</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="va">estimated_motion</span> <span class="op">&gt;</span> <span class="va">backend</span><span class="op">$</span><span class="va">online_qc</span><span class="op">$</span><span class="va">metrics</span><span class="op">$</span><span class="va">motion_threshold</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">qc_results</span><span class="op">$</span><span class="va">alerts</span><span class="op">$</span><span class="va">motion</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>          severity <span class="op">=</span> <span class="st">"warning"</span>,</span>
<span>          value <span class="op">=</span> <span class="va">estimated_motion</span>,</span>
<span>          threshold <span class="op">=</span> <span class="va">backend</span><span class="op">$</span><span class="va">online_qc</span><span class="op">$</span><span class="va">metrics</span><span class="op">$</span><span class="va">motion_threshold</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span></span>
<span>      <span class="co"># Signal dropout detection</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="va">new_data</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">dropout_prop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">new_data</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="va">dropout_prop</span> <span class="op">&gt;</span> <span class="va">backend</span><span class="op">$</span><span class="va">online_qc</span><span class="op">$</span><span class="va">metrics</span><span class="op">$</span><span class="va">signal_dropout_threshold</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="va">qc_results</span><span class="op">$</span><span class="va">alerts</span><span class="op">$</span><span class="va">dropout</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>            severity <span class="op">=</span> <span class="st">"error"</span>,</span>
<span>            proportion <span class="op">=</span> <span class="va">dropout_prop</span>,</span>
<span>            threshold <span class="op">=</span> <span class="va">backend</span><span class="op">$</span><span class="va">online_qc</span><span class="op">$</span><span class="va">metrics</span><span class="op">$</span><span class="va">signal_dropout_threshold</span></span>
<span>          <span class="op">)</span></span>
<span>          <span class="va">qc_results</span><span class="op">$</span><span class="va">status</span> <span class="op">&lt;-</span> <span class="st">"fail"</span></span>
<span>        <span class="op">}</span></span>
<span>      <span class="op">}</span></span>
<span></span>
<span>      <span class="co"># Temporal SNR check (simplified)</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="va">timepoint</span> <span class="op">&gt;</span> <span class="fl">10</span><span class="op">)</span> <span class="op">{</span> <span class="co"># Need some history for SNR calculation</span></span>
<span>        <span class="va">mean_signal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">new_data</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>        <span class="va">signal_var</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">new_data</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>        <span class="va">temporal_snr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">signal_var</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="va">mean_signal</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">signal_var</span><span class="op">)</span>, <span class="cn">Inf</span><span class="op">)</span></span>
<span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="va">temporal_snr</span> <span class="op">&lt;</span> <span class="va">backend</span><span class="op">$</span><span class="va">online_qc</span><span class="op">$</span><span class="va">metrics</span><span class="op">$</span><span class="va">temporal_snr_threshold</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="va">qc_results</span><span class="op">$</span><span class="va">alerts</span><span class="op">$</span><span class="va">low_snr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>            severity <span class="op">=</span> <span class="st">"warning"</span>,</span>
<span>            snr <span class="op">=</span> <span class="va">temporal_snr</span>,</span>
<span>            threshold <span class="op">=</span> <span class="va">backend</span><span class="op">$</span><span class="va">online_qc</span><span class="op">$</span><span class="va">metrics</span><span class="op">$</span><span class="va">temporal_snr_threshold</span></span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>      <span class="op">}</span></span>
<span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">qc_results</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="va">backend</span><span class="op">$</span><span class="va">check_quality</span> <span class="op">&lt;-</span> <span class="va">check_realtime_quality</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">backend</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Adaptive processing</span></span>
<span>  <span class="va">implement_adaptive_processing</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">backend</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">backend</span><span class="op">$</span><span class="va">adaptive_config</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      enabled <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>      adaptation_triggers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"quality_degradation"</span>, <span class="st">"motion_excess"</span>, <span class="st">"signal_loss"</span><span class="op">)</span>,</span>
<span>      responses <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        quality_degradation <span class="op">=</span> <span class="st">"increase_averaging"</span>,</span>
<span>        motion_excess <span class="op">=</span> <span class="st">"trigger_realignment"</span>,</span>
<span>        signal_loss <span class="op">=</span> <span class="st">"alert_operator"</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Adaptive response function</span></span>
<span>    <span class="va">trigger_adaptation</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">alert_type</span>, <span class="va">alert_data</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="va">alert_type</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">backend</span><span class="op">$</span><span class="va">adaptive_config</span><span class="op">$</span><span class="va">responses</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">response</span> <span class="op">&lt;-</span> <span class="va">backend</span><span class="op">$</span><span class="va">adaptive_config</span><span class="op">$</span><span class="va">responses</span><span class="op">[[</span><span class="va">alert_type</span><span class="op">]</span><span class="op">]</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Triggering adaptive response:"</span>, <span class="va">response</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span></span>
<span>        <span class="co"># Implement specific adaptations</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/switch.html" class="external-link">switch</a></span><span class="op">(</span><span class="va">response</span>,</span>
<span>          <span class="st">"increase_averaging"</span> <span class="op">=</span> <span class="op">{</span></span>
<span>            <span class="va">backend</span><span class="op">$</span><span class="va">processing_params</span><span class="op">$</span><span class="va">smoothing_kernel</span> <span class="op">&lt;-</span></span>
<span>              <span class="va">backend</span><span class="op">$</span><span class="va">processing_params</span><span class="op">$</span><span class="va">smoothing_kernel</span> <span class="op">*</span> <span class="fl">1.2</span></span>
<span>          <span class="op">}</span>,</span>
<span>          <span class="st">"trigger_realignment"</span> <span class="op">=</span> <span class="op">{</span></span>
<span>            <span class="va">backend</span><span class="op">$</span><span class="va">processing_flags</span><span class="op">$</span><span class="va">motion_correction</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span>          <span class="op">}</span>,</span>
<span>          <span class="st">"alert_operator"</span> <span class="op">=</span> <span class="op">{</span></span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"ALERT: Operator intervention required -"</span>, <span class="va">alert_type</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>          <span class="op">}</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="va">backend</span><span class="op">$</span><span class="va">trigger_adaptation</span> <span class="op">&lt;-</span> <span class="va">trigger_adaptation</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">backend</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    setup_stream <span class="op">=</span> <span class="va">setup_realtime_stream</span>,</span>
<span>    online_qc <span class="op">=</span> <span class="va">implement_online_qc</span>,</span>
<span>    adaptive_processing <span class="op">=</span> <span class="va">implement_adaptive_processing</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># realtime_system &lt;- implement_realtime_capabilities()</span></span></code></pre></div>
<p>Real-time capabilities enable backends to support modern adaptive
neuroimaging paradigms and continuous quality monitoring.</p>
</div>
</div>
<div class="section level2">
<h2 id="tips-and-best-practices">Tips and Best Practices<a class="anchor" aria-label="anchor" href="#tips-and-best-practices"></a>
</h2>
<p>Here are advanced guidelines learned from developing production
neuroimaging backends that handle enterprise-scale deployments and
critical research applications.</p>
<div class="section level3">
<h3 id="performance-monitoring-requirements">Performance Monitoring Requirements<a class="anchor" aria-label="anchor" href="#performance-monitoring-requirements"></a>
</h3>
<p><strong>Required Metrics for Production Backends</strong>: - Cache
hit rates and eviction patterns - Data transfer throughput (MB/s) -
Error rates by category - Resource utilization (memory, file handles,
connections) - Latency percentiles (p50, p95, p99)</p>
<p>Implement metric collection from initial development to establish
baseline performance characteristics.</p>
</div>
<div class="section level3">
<h3 id="failure-handling-architecture">Failure Handling Architecture<a class="anchor" aria-label="anchor" href="#failure-handling-architecture"></a>
</h3>
<p><strong>Required Failure Mitigation Strategies</strong>: -
<strong>Circuit breakers</strong>: Prevent cascade failures by stopping
requests to failing services - <strong>Graceful degradation</strong>:
Provide partial functionality when components fail - <strong>Retry
logic</strong>: Exponential backoff with jitter for transient failures -
<strong>Resource limits</strong>: Prevent resource exhaustion through
quotas and timeouts - <strong>Error categorization</strong>: Distinguish
between recoverable and fatal errors</p>
</div>
<div class="section level3">
<h3 id="performance-profiling-strategy">Performance Profiling Strategy<a class="anchor" aria-label="anchor" href="#performance-profiling-strategy"></a>
</h3>
<p><strong>Continuous Profiling Requirements</strong>: 1. Profile memory
allocation patterns using <code>profmem</code> or <code>profvis</code>
2. Benchmark I/O operations with representative data sizes 3. Measure
cache efficiency under various access patterns 4. Test performance
degradation under resource constraints 5. Compare development
vs.Â production performance characteristics</p>
<p>Document performance baselines and regression thresholds in backend
specifications.</p>
</div>
<div class="section level3">
<h3 id="production-deployment-strategies">Production Deployment Strategies<a class="anchor" aria-label="anchor" href="#production-deployment-strategies"></a>
</h3>
<p>Deploying advanced backends in production environments requires
careful attention to operational concerns:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Production deployment considerations</span></span>
<span><span class="va">implement_production_features</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">backend</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Comprehensive logging and monitoring</span></span>
<span>  <span class="va">setup_monitoring</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">backend</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">backend</span><span class="op">$</span><span class="va">monitoring</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      enabled <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>      log_level <span class="op">=</span> <span class="st">"INFO"</span>, <span class="co"># DEBUG, INFO, WARN, ERROR</span></span>
<span>      metrics_endpoint <span class="op">=</span> <span class="st">"/metrics"</span>,</span>
<span>      health_check_endpoint <span class="op">=</span> <span class="st">"/health"</span>,</span>
<span>      performance_tracking <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Structured logging</span></span>
<span>    <span class="va">log_event</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">level</span>, <span class="va">message</span>, <span class="va">context</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">log_entry</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        timestamp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"%Y-%m-%d %H:%M:%S"</span><span class="op">)</span>,</span>
<span>        level <span class="op">=</span> <span class="va">level</span>,</span>
<span>        backend_id <span class="op">=</span> <span class="va">backend</span><span class="op">$</span><span class="va">connection_id</span>,</span>
<span>        message <span class="op">=</span> <span class="va">message</span>,</span>
<span>        context <span class="op">=</span> <span class="va">context</span></span>
<span>      <span class="op">)</span></span>
<span></span>
<span>      <span class="co"># In production, send to centralized logging system</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span></span>
<span>        <span class="st">"["</span>, <span class="va">log_entry</span><span class="op">$</span><span class="va">timestamp</span>, <span class="st">"] "</span>,</span>
<span>        <span class="va">level</span>, <span class="st">": "</span>, <span class="va">message</span>, <span class="st">"\n"</span></span>
<span>      <span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="va">backend</span><span class="op">$</span><span class="va">log</span> <span class="op">&lt;-</span> <span class="va">log_event</span></span>
<span></span>
<span>    <span class="co"># Health check implementation</span></span>
<span>    <span class="va">health_check</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">health_status</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        status <span class="op">=</span> <span class="st">"healthy"</span>,</span>
<span>        timestamp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        checks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span></span>
<span>      <span class="co"># Connection health</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="va">backend</span><span class="op">$</span><span class="va">is_open</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">health_status</span><span class="op">$</span><span class="va">checks</span><span class="op">$</span><span class="va">connection</span> <span class="op">&lt;-</span> <span class="st">"pass"</span></span>
<span>      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>        <span class="va">health_status</span><span class="op">$</span><span class="va">checks</span><span class="op">$</span><span class="va">connection</span> <span class="op">&lt;-</span> <span class="st">"fail"</span></span>
<span>        <span class="va">health_status</span><span class="op">$</span><span class="va">status</span> <span class="op">&lt;-</span> <span class="st">"unhealthy"</span></span>
<span>      <span class="op">}</span></span>
<span></span>
<span>      <span class="co"># Cache health</span></span>
<span>      <span class="va">cache_size</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">backend</span><span class="op">$</span><span class="va">data_chunks_cache</span><span class="op">)</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="va">cache_size</span> <span class="op">&lt;</span> <span class="fl">1000</span><span class="op">)</span> <span class="op">{</span> <span class="co"># Arbitrary threshold</span></span>
<span>        <span class="va">health_status</span><span class="op">$</span><span class="va">checks</span><span class="op">$</span><span class="va">cache</span> <span class="op">&lt;-</span> <span class="st">"pass"</span></span>
<span>      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>        <span class="va">health_status</span><span class="op">$</span><span class="va">checks</span><span class="op">$</span><span class="va">cache</span> <span class="op">&lt;-</span> <span class="st">"warning"</span></span>
<span>      <span class="op">}</span></span>
<span></span>
<span>      <span class="co"># Error rate health</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="va">backend</span><span class="op">$</span><span class="va">error_recovery_attempts</span> <span class="op">&lt;</span> <span class="va">backend</span><span class="op">$</span><span class="va">max_error_recovery_attempts</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">health_status</span><span class="op">$</span><span class="va">checks</span><span class="op">$</span><span class="va">error_rate</span> <span class="op">&lt;-</span> <span class="st">"pass"</span></span>
<span>      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>        <span class="va">health_status</span><span class="op">$</span><span class="va">checks</span><span class="op">$</span><span class="va">error_rate</span> <span class="op">&lt;-</span> <span class="st">"fail"</span></span>
<span>        <span class="va">health_status</span><span class="op">$</span><span class="va">status</span> <span class="op">&lt;-</span> <span class="st">"unhealthy"</span></span>
<span>      <span class="op">}</span></span>
<span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">health_status</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="va">backend</span><span class="op">$</span><span class="va">health_check</span> <span class="op">&lt;-</span> <span class="va">health_check</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">backend</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Configuration management</span></span>
<span>  <span class="va">implement_config_management</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">backend</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Support for external configuration</span></span>
<span>    <span class="va">load_config</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">config_source</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">default_config</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        cache_size_mb <span class="op">=</span> <span class="fl">256</span>,</span>
<span>        timeout_seconds <span class="op">=</span> <span class="fl">30</span>,</span>
<span>        retry_attempts <span class="op">=</span> <span class="fl">3</span>,</span>
<span>        compression_enabled <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        monitoring_enabled <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>      <span class="op">)</span></span>
<span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">config_source</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">config_source</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="co"># Load from config file</span></span>
<span>          <span class="va">external_config</span> <span class="op">&lt;-</span> <span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://jeroen.r-universe.dev/jsonlite/reference/fromJSON.html" class="external-link">fromJSON</a></span><span class="op">(</span><span class="va">config_source</span><span class="op">)</span></span>
<span>          <span class="va">config</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/modifyList.html" class="external-link">modifyList</a></span><span class="op">(</span><span class="va">default_config</span>, <span class="va">external_config</span><span class="op">)</span></span>
<span>        <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>          <span class="co"># Load from environment variables</span></span>
<span>          <span class="va">config</span> <span class="op">&lt;-</span> <span class="va">default_config</span></span>
<span>          <span class="va">config</span><span class="op">$</span><span class="va">cache_size_mb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span></span>
<span>            <span class="st">"CACHE_SIZE_MB"</span>,</span>
<span>            <span class="va">default_config</span><span class="op">$</span><span class="va">cache_size_mb</span></span>
<span>          <span class="op">)</span><span class="op">)</span></span>
<span>          <span class="va">config</span><span class="op">$</span><span class="va">timeout_seconds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span></span>
<span>            <span class="st">"TIMEOUT_SECONDS"</span>,</span>
<span>            <span class="va">default_config</span><span class="op">$</span><span class="va">timeout_seconds</span></span>
<span>          <span class="op">)</span><span class="op">)</span></span>
<span>          <span class="co"># Add other env var mappings...</span></span>
<span>        <span class="op">}</span></span>
<span>      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>        <span class="va">config</span> <span class="op">&lt;-</span> <span class="va">default_config</span></span>
<span>      <span class="op">}</span></span>
<span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">config</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="va">backend</span><span class="op">$</span><span class="va">config</span> <span class="op">&lt;-</span> <span class="fu">load_config</span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Configuration loaded with cache size:"</span>, <span class="va">backend</span><span class="op">$</span><span class="va">config</span><span class="op">$</span><span class="va">cache_size_mb</span>, <span class="st">"MB\n"</span><span class="op">)</span></span>
<span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">backend</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Security and authentication</span></span>
<span>  <span class="va">implement_security</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">backend</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">backend</span><span class="op">$</span><span class="va">security</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      authentication_required <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>      encryption_in_transit <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>      access_logging <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>      rate_limiting <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        enabled <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        requests_per_minute <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>        burst_size <span class="op">=</span> <span class="fl">100</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Token-based authentication</span></span>
<span>    <span class="va">authenticate_request</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">token</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># In practice, validate against authentication service</span></span>
<span>      <span class="va">valid_tokens</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"demo_token_123"</span>, <span class="st">"research_token_456"</span><span class="op">)</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">token</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">valid_tokens</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="co"># Rate limiting</span></span>
<span>    <span class="va">check_rate_limit</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">client_id</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># In practice, implement distributed rate limiting</span></span>
<span>      <span class="va">current_requests</span> <span class="op">&lt;-</span> <span class="va">backend</span><span class="op">$</span><span class="va">rate_limit_state</span><span class="op">[[</span><span class="va">client_id</span><span class="op">]</span><span class="op">]</span> <span class="op"><a href="../reference/grapes-or-or-grapes.html">%||%</a></span> <span class="fl">0</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="va">current_requests</span> <span class="op">&gt;=</span> <span class="va">backend</span><span class="op">$</span><span class="va">security</span><span class="op">$</span><span class="va">rate_limiting</span><span class="op">$</span><span class="va">requests_per_minute</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>allowed <span class="op">=</span> <span class="cn">FALSE</span>, retry_after <span class="op">=</span> <span class="fl">60</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>        <span class="va">backend</span><span class="op">$</span><span class="va">rate_limit_state</span><span class="op">[[</span><span class="va">client_id</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">current_requests</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>allowed <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="va">backend</span><span class="op">$</span><span class="va">authenticate</span> <span class="op">&lt;-</span> <span class="va">authenticate_request</span></span>
<span>    <span class="va">backend</span><span class="op">$</span><span class="va">check_rate_limit</span> <span class="op">&lt;-</span> <span class="va">check_rate_limit</span></span>
<span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">backend</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    setup_monitoring <span class="op">=</span> <span class="va">setup_monitoring</span>,</span>
<span>    config_management <span class="op">=</span> <span class="va">implement_config_management</span>,</span>
<span>    security <span class="op">=</span> <span class="va">implement_security</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># production_features &lt;- implement_production_features()</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="testing-and-validation-strategies">Testing and Validation Strategies<a class="anchor" aria-label="anchor" href="#testing-and-validation-strategies"></a>
</h3>
<p>Advanced backends require comprehensive testing strategies that cover
functionality, performance, and reliability:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Comprehensive testing framework</span></span>
<span><span class="va">implement_testing_framework</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Unit testing for backend components</span></span>
<span>  <span class="va">create_unit_tests</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">backend_class</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">test_suite</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Test basic contract compliance</span></span>
<span>    <span class="va">test_suite</span><span class="op">$</span><span class="va">test_contract</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">backend</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">backend_class</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>stream_url <span class="op">=</span> <span class="st">"test://localhost"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>      <span class="co"># Test lifecycle</span></span>
<span>      <span class="fu">testthat</span><span class="fu">::</span><span class="fu"><a href="https://testthat.r-lib.org/reference/logical-expectations.html" class="external-link">expect_false</a></span><span class="op">(</span><span class="va">backend</span><span class="op">$</span><span class="va">is_open</span><span class="op">)</span></span>
<span>      <span class="va">backend</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/backend_open.html">backend_open</a></span><span class="op">(</span><span class="va">backend</span><span class="op">)</span></span>
<span>      <span class="fu">testthat</span><span class="fu">::</span><span class="fu"><a href="https://testthat.r-lib.org/reference/logical-expectations.html" class="external-link">expect_true</a></span><span class="op">(</span><span class="va">backend</span><span class="op">$</span><span class="va">is_open</span><span class="op">)</span></span>
<span></span>
<span>      <span class="co"># Test data access methods exist</span></span>
<span>      <span class="fu">testthat</span><span class="fu">::</span><span class="fu"><a href="https://testthat.r-lib.org/reference/logical-expectations.html" class="external-link">expect_true</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/exists.html" class="external-link">exists</a></span><span class="op">(</span><span class="st">"backend_get_dims"</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="fu">testthat</span><span class="fu">::</span><span class="fu"><a href="https://testthat.r-lib.org/reference/logical-expectations.html" class="external-link">expect_true</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/exists.html" class="external-link">exists</a></span><span class="op">(</span><span class="st">"backend_get_mask"</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="fu">testthat</span><span class="fu">::</span><span class="fu"><a href="https://testthat.r-lib.org/reference/logical-expectations.html" class="external-link">expect_true</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/exists.html" class="external-link">exists</a></span><span class="op">(</span><span class="st">"backend_get_data"</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="fu">testthat</span><span class="fu">::</span><span class="fu"><a href="https://testthat.r-lib.org/reference/logical-expectations.html" class="external-link">expect_true</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/exists.html" class="external-link">exists</a></span><span class="op">(</span><span class="st">"backend_get_metadata"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>      <span class="fu"><a href="../reference/backend_close.html">backend_close</a></span><span class="op">(</span><span class="va">backend</span><span class="op">)</span></span>
<span>      <span class="fu">testthat</span><span class="fu">::</span><span class="fu"><a href="https://testthat.r-lib.org/reference/logical-expectations.html" class="external-link">expect_false</a></span><span class="op">(</span><span class="va">backend</span><span class="op">$</span><span class="va">is_open</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="co"># Test error handling</span></span>
<span>    <span class="va">test_suite</span><span class="op">$</span><span class="va">test_error_handling</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># Test invalid URLs</span></span>
<span>      <span class="fu">testthat</span><span class="fu">::</span><span class="fu"><a href="https://testthat.r-lib.org/reference/expect_error.html" class="external-link">expect_error</a></span><span class="op">(</span></span>
<span>        <span class="fu">backend_class</span><span class="op">(</span>stream_url <span class="op">=</span> <span class="st">"invalid://url"</span><span class="op">)</span>,</span>
<span>        <span class="st">"Invalid stream URL"</span></span>
<span>      <span class="op">)</span></span>
<span></span>
<span>      <span class="co"># Test unopened backend access</span></span>
<span>      <span class="va">backend</span> <span class="op">&lt;-</span> <span class="fu">backend_class</span><span class="op">(</span>stream_url <span class="op">=</span> <span class="st">"test://localhost"</span><span class="op">)</span></span>
<span>      <span class="fu">testthat</span><span class="fu">::</span><span class="fu"><a href="https://testthat.r-lib.org/reference/expect_error.html" class="external-link">expect_error</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="../reference/backend_get_dims.html">backend_get_dims</a></span><span class="op">(</span><span class="va">backend</span><span class="op">)</span>,</span>
<span>        <span class="st">"must be opened"</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="co"># Test performance characteristics</span></span>
<span>    <span class="va">test_suite</span><span class="op">$</span><span class="va">test_performance</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">backend</span> <span class="op">&lt;-</span> <span class="fu">backend_class</span><span class="op">(</span>stream_url <span class="op">=</span> <span class="st">"test://localhost"</span><span class="op">)</span></span>
<span>      <span class="va">backend</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/backend_open.html">backend_open</a></span><span class="op">(</span><span class="va">backend</span><span class="op">)</span></span>
<span></span>
<span>      <span class="co"># Test cache performance</span></span>
<span>      <span class="va">start_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">data1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/backend_get_data.html">backend_get_data</a></span><span class="op">(</span><span class="va">backend</span>, rows <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, cols <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span></span>
<span>      <span class="va">first_access_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="va">start_time</span></span>
<span></span>
<span>      <span class="va">start_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="va">data2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/backend_get_data.html">backend_get_data</a></span><span class="op">(</span><span class="va">backend</span>, rows <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, cols <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span></span>
<span>      <span class="va">second_access_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="va">start_time</span></span>
<span></span>
<span>      <span class="co"># Second access should be faster (cached)</span></span>
<span>      <span class="fu">testthat</span><span class="fu">::</span><span class="fu"><a href="https://testthat.r-lib.org/reference/comparison-expectations.html" class="external-link">expect_lt</a></span><span class="op">(</span><span class="va">second_access_time</span>, <span class="va">first_access_time</span><span class="op">)</span></span>
<span></span>
<span>      <span class="fu"><a href="../reference/backend_close.html">backend_close</a></span><span class="op">(</span><span class="va">backend</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">test_suite</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Integration testing</span></span>
<span>  <span class="va">create_integration_tests</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">integration_tests</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Test with fmridataset integration</span></span>
<span>    <span class="va">integration_tests</span><span class="op">$</span><span class="va">test_dataset_integration</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">backend</span> <span class="op">&lt;-</span> <span class="fu">neurostream_backend</span><span class="op">(</span>stream_url <span class="op">=</span> <span class="st">"test://localhost"</span><span class="op">)</span></span>
<span></span>
<span>      <span class="co"># Test dataset creation</span></span>
<span>      <span class="va">dataset</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fmri_dataset.html">fmri_dataset</a></span><span class="op">(</span></span>
<span>        scans <span class="op">=</span> <span class="va">backend</span>,</span>
<span>        TR <span class="op">=</span> <span class="fl">2.0</span>,</span>
<span>        run_length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fl">50</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span></span>
<span>      <span class="fu">testthat</span><span class="fu">::</span><span class="fu"><a href="https://testthat.r-lib.org/reference/logical-expectations.html" class="external-link">expect_true</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">dataset</span>, <span class="st">"fmri_dataset"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>      <span class="co"># Test data access through dataset</span></span>
<span>      <span class="va">data_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_data_matrix.html">get_data_matrix</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">)</span></span>
<span>      <span class="fu">testthat</span><span class="fu">::</span><span class="fu"><a href="https://testthat.r-lib.org/reference/logical-expectations.html" class="external-link">expect_true</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">is.matrix</a></span><span class="op">(</span><span class="va">data_matrix</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="fu">testthat</span><span class="fu">::</span><span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html" class="external-link">expect_equal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data_matrix</span><span class="op">)</span>, <span class="fl">100</span><span class="op">)</span> <span class="co"># 50 + 50</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="co"># Test chunking integration</span></span>
<span>    <span class="va">integration_tests</span><span class="op">$</span><span class="va">test_chunking</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">backend</span> <span class="op">&lt;-</span> <span class="fu">neurostream_backend</span><span class="op">(</span>stream_url <span class="op">=</span> <span class="st">"test://localhost"</span><span class="op">)</span></span>
<span>      <span class="va">dataset</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fmri_dataset.html">fmri_dataset</a></span><span class="op">(</span>scans <span class="op">=</span> <span class="va">backend</span>, TR <span class="op">=</span> <span class="fl">2.0</span>, run_length <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span></span>
<span>      <span class="co"># Test chunking</span></span>
<span>      <span class="va">chunks</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/data_chunks.html">data_chunks</a></span><span class="op">(</span><span class="va">dataset</span>, nchunks <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span>      <span class="fu">testthat</span><span class="fu">::</span><span class="fu"><a href="https://testthat.r-lib.org/reference/expect_length.html" class="external-link">expect_length</a></span><span class="op">(</span><span class="va">chunks</span>, <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span>      <span class="co"># Test chunk data access</span></span>
<span>      <span class="kw">for</span> <span class="op">(</span><span class="va">chunk</span> <span class="kw">in</span> <span class="va">chunks</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu">testthat</span><span class="fu">::</span><span class="fu"><a href="https://testthat.r-lib.org/reference/logical-expectations.html" class="external-link">expect_true</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">is.matrix</a></span><span class="op">(</span><span class="va">chunk</span><span class="op">$</span><span class="va">data</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="fu">testthat</span><span class="fu">::</span><span class="fu"><a href="https://testthat.r-lib.org/reference/comparison-expectations.html" class="external-link">expect_gt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">chunk</span><span class="op">$</span><span class="va">data</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>        <span class="fu">testthat</span><span class="fu">::</span><span class="fu"><a href="https://testthat.r-lib.org/reference/comparison-expectations.html" class="external-link">expect_gt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">chunk</span><span class="op">$</span><span class="va">data</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">integration_tests</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Performance benchmarking</span></span>
<span>  <span class="va">create_performance_tests</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">perf_tests</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Benchmark data access patterns</span></span>
<span>    <span class="va">perf_tests</span><span class="op">$</span><span class="va">benchmark_access_patterns</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"microbenchmark"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">backend</span> <span class="op">&lt;-</span> <span class="fu">neurostream_backend</span><span class="op">(</span>stream_url <span class="op">=</span> <span class="st">"test://localhost"</span><span class="op">)</span></span>
<span>        <span class="va">backend</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/backend_open.html">backend_open</a></span><span class="op">(</span><span class="va">backend</span><span class="op">)</span></span>
<span></span>
<span>        <span class="co"># Benchmark different access patterns</span></span>
<span>        <span class="va">benchmark_results</span> <span class="op">&lt;-</span> <span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu">microbenchmark</span><span class="op">(</span></span>
<span>          sequential_small <span class="op">=</span> <span class="fu"><a href="../reference/backend_get_data.html">backend_get_data</a></span><span class="op">(</span><span class="va">backend</span>, rows <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, cols <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">100</span><span class="op">)</span>,</span>
<span>          sequential_large <span class="op">=</span> <span class="fu"><a href="../reference/backend_get_data.html">backend_get_data</a></span><span class="op">(</span><span class="va">backend</span>, rows <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">100</span>, cols <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">100</span><span class="op">)</span>,</span>
<span>          random_access <span class="op">=</span> <span class="fu"><a href="../reference/backend_get_data.html">backend_get_data</a></span><span class="op">(</span><span class="va">backend</span>,</span>
<span>            rows <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">100</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>            cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">1000</span>, <span class="fl">100</span><span class="op">)</span></span>
<span>          <span class="op">)</span>,</span>
<span>          times <span class="op">=</span> <span class="fl">10</span></span>
<span>        <span class="op">)</span></span>
<span></span>
<span>        <span class="fu"><a href="../reference/print.html">print</a></span><span class="op">(</span><span class="va">benchmark_results</span><span class="op">)</span></span>
<span>        <span class="fu"><a href="../reference/backend_close.html">backend_close</a></span><span class="op">(</span><span class="va">backend</span><span class="op">)</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">benchmark_results</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="co"># Memory usage profiling</span></span>
<span>    <span class="va">perf_tests</span><span class="op">$</span><span class="va">profile_memory_usage</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"profmem"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">backend</span> <span class="op">&lt;-</span> <span class="fu">neurostream_backend</span><span class="op">(</span>stream_url <span class="op">=</span> <span class="st">"test://localhost"</span><span class="op">)</span></span>
<span></span>
<span>        <span class="co"># Profile memory during backend operations</span></span>
<span>        <span class="va">memory_profile</span> <span class="op">&lt;-</span> <span class="fu">profmem</span><span class="fu">::</span><span class="fu"><a href="https://henrikbengtsson.github.io/profmem/reference/profmem.html" class="external-link">profmem</a></span><span class="op">(</span><span class="op">{</span></span>
<span>          <span class="va">backend</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/backend_open.html">backend_open</a></span><span class="op">(</span><span class="va">backend</span><span class="op">)</span></span>
<span>          <span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/backend_get_data.html">backend_get_data</a></span><span class="op">(</span><span class="va">backend</span>, rows <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">100</span>, cols <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">1000</span><span class="op">)</span></span>
<span>          <span class="fu"><a href="../reference/backend_close.html">backend_close</a></span><span class="op">(</span><span class="va">backend</span><span class="op">)</span></span>
<span>        <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">memory_profile</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">perf_tests</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    unit_tests <span class="op">=</span> <span class="va">create_unit_tests</span>,</span>
<span>    integration_tests <span class="op">=</span> <span class="va">create_integration_tests</span>,</span>
<span>    performance_tests <span class="op">=</span> <span class="va">create_performance_tests</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># testing_framework &lt;- implement_testing_framework()</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="troubleshooting-advanced-backend-issues">Troubleshooting Advanced Backend Issues<a class="anchor" aria-label="anchor" href="#troubleshooting-advanced-backend-issues"></a>
</h2>
<p>Advanced backends introduce complexity that can lead to sophisticated
failure modes. Understanding how to diagnose and resolve these issues is
crucial for production deployments.</p>
<div class="section level3">
<h3 id="network-and-connectivity-issues">Network and Connectivity Issues<a class="anchor" aria-label="anchor" href="#network-and-connectivity-issues"></a>
</h3>
<p>Advanced backends often depend on network resources, leading to
complex failure scenarios:</p>
<dl>
<dt><strong>Intermittent Connection Failures</strong></dt>
<dd>
Implement exponential backoff with jitter, circuit breaker patterns, and
connection pooling. Monitor connection health continuously and switch to
backup endpoints when primary connections become unreliable.
</dd>
<dt><strong>Data Corruption During Transfer</strong></dt>
<dd>
Use checksums and integrity validation at multiple layers. Implement
end-to-end verification and automatic retry with different transfer
methods when corruption is detected.
</dd>
<dt><strong>Performance Degradation Under Load</strong></dt>
<dd>
Monitor network throughput, implement adaptive chunk sizing, and use
quality-of-service prioritization. Consider implementing local caching
proxies for frequently accessed data.
</dd>
</dl>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Network troubleshooting tools</span></span>
<span><span class="va">implement_network_diagnostics</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">backend</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Connection health monitoring</span></span>
<span>  <span class="va">monitor_connection_health</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">backend</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">health_metrics</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      timestamp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      connection_latency <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>      throughput_mbps <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>      packet_loss <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>      connection_stable <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Simulate latency measurement</span></span>
<span>    <span class="va">start_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="co"># In practice: ping or small data request</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html" class="external-link">Sys.sleep</a></span><span class="op">(</span><span class="fl">0.01</span><span class="op">)</span> <span class="co"># Simulate network latency</span></span>
<span>    <span class="va">health_metrics</span><span class="op">$</span><span class="va">connection_latency</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/difftime.html" class="external-link">difftime</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">start_time</span>, units <span class="op">=</span> <span class="st">"secs"</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Simulate throughput measurement</span></span>
<span>    <span class="co"># In practice: transfer known data size and measure time</span></span>
<span>    <span class="va">health_metrics</span><span class="op">$</span><span class="va">throughput_mbps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">50</span>, <span class="fl">1000</span><span class="op">)</span> <span class="co"># Mbps</span></span>
<span></span>
<span>    <span class="co"># Determine connection stability</span></span>
<span>    <span class="va">health_metrics</span><span class="op">$</span><span class="va">connection_stable</span> <span class="op">&lt;-</span></span>
<span>      <span class="va">health_metrics</span><span class="op">$</span><span class="va">connection_latency</span> <span class="op">&lt;</span> <span class="fl">0.1</span> <span class="op">&amp;&amp;</span> <span class="va">health_metrics</span><span class="op">$</span><span class="va">throughput_mbps</span> <span class="op">&gt;</span> <span class="fl">100</span></span>
<span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">health_metrics</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Adaptive connection management</span></span>
<span>  <span class="va">implement_adaptive_connection</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">backend</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">backend</span><span class="op">$</span><span class="va">connection_adaption</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      enabled <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>      performance_history <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      adaptation_thresholds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        latency_warning <span class="op">=</span> <span class="fl">0.5</span>, <span class="co"># seconds</span></span>
<span>        latency_critical <span class="op">=</span> <span class="fl">2.0</span>, <span class="co"># seconds</span></span>
<span>        throughput_warning <span class="op">=</span> <span class="fl">50</span>, <span class="co"># Mbps</span></span>
<span>        throughput_critical <span class="op">=</span> <span class="fl">10</span> <span class="co"># Mbps</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="va">adapt_connection_strategy</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">health_metrics</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">current_performance</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        latency <span class="op">=</span> <span class="va">health_metrics</span><span class="op">$</span><span class="va">connection_latency</span>,</span>
<span>        throughput <span class="op">=</span> <span class="va">health_metrics</span><span class="op">$</span><span class="va">throughput_mbps</span></span>
<span>      <span class="op">)</span></span>
<span></span>
<span>      <span class="co"># Store performance history</span></span>
<span>      <span class="va">backend</span><span class="op">$</span><span class="va">connection_adaption</span><span class="op">$</span><span class="va">performance_history</span> <span class="op">&lt;-</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/append.html" class="external-link">append</a></span><span class="op">(</span><span class="va">backend</span><span class="op">$</span><span class="va">connection_adaption</span><span class="op">$</span><span class="va">performance_history</span>,</span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">current_performance</span><span class="op">)</span>,</span>
<span>          after <span class="op">=</span> <span class="fl">0</span></span>
<span>        <span class="op">)</span></span>
<span></span>
<span>      <span class="co"># Keep only recent history</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">backend</span><span class="op">$</span><span class="va">connection_adaption</span><span class="op">$</span><span class="va">performance_history</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">10</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">backend</span><span class="op">$</span><span class="va">connection_adaption</span><span class="op">$</span><span class="va">performance_history</span> <span class="op">&lt;-</span></span>
<span>          <span class="va">backend</span><span class="op">$</span><span class="va">connection_adaption</span><span class="op">$</span><span class="va">performance_history</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span></span>
<span>      <span class="op">}</span></span>
<span></span>
<span>      <span class="co"># Adapt based on current performance</span></span>
<span>      <span class="va">thresholds</span> <span class="op">&lt;-</span> <span class="va">backend</span><span class="op">$</span><span class="va">connection_adaption</span><span class="op">$</span><span class="va">adaptation_thresholds</span></span>
<span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="va">current_performance</span><span class="op">$</span><span class="va">latency</span> <span class="op">&gt;</span> <span class="va">thresholds</span><span class="op">$</span><span class="va">latency_critical</span> <span class="op">||</span></span>
<span>        <span class="va">current_performance</span><span class="op">$</span><span class="va">throughput</span> <span class="op">&lt;</span> <span class="va">thresholds</span><span class="op">$</span><span class="va">throughput_critical</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Critical performance degradation detected, switching to backup connection\n"</span><span class="op">)</span></span>
<span>        <span class="va">backend</span><span class="op">$</span><span class="va">connection_strategy</span> <span class="op">&lt;-</span> <span class="st">"backup"</span></span>
<span>      <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">current_performance</span><span class="op">$</span><span class="va">latency</span> <span class="op">&gt;</span> <span class="va">thresholds</span><span class="op">$</span><span class="va">latency_warning</span> <span class="op">||</span></span>
<span>        <span class="va">current_performance</span><span class="op">$</span><span class="va">throughput</span> <span class="op">&lt;</span> <span class="va">thresholds</span><span class="op">$</span><span class="va">throughput_warning</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Performance warning, reducing chunk size\n"</span><span class="op">)</span></span>
<span>        <span class="va">backend</span><span class="op">$</span><span class="va">chunk_size_mb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">backend</span><span class="op">$</span><span class="va">chunk_size_mb</span> <span class="op">*</span> <span class="fl">0.8</span>, <span class="fl">8</span><span class="op">)</span></span>
<span>      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>        <span class="co"># Performance is good, can increase chunk size</span></span>
<span>        <span class="va">backend</span><span class="op">$</span><span class="va">chunk_size_mb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">backend</span><span class="op">$</span><span class="va">chunk_size_mb</span> <span class="op">*</span> <span class="fl">1.1</span>, <span class="fl">128</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="va">backend</span><span class="op">$</span><span class="va">adapt_connection</span> <span class="op">&lt;-</span> <span class="va">adapt_connection_strategy</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">backend</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    monitor_health <span class="op">=</span> <span class="va">monitor_connection_health</span>,</span>
<span>    adaptive_connection <span class="op">=</span> <span class="va">implement_adaptive_connection</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="cache-and-memory-management-issues">Cache and Memory Management Issues<a class="anchor" aria-label="anchor" href="#cache-and-memory-management-issues"></a>
</h3>
<p>Advanced caching systems can exhibit complex behaviors that require
sophisticated debugging:</p>
<dl>
<dt><strong>Cache Thrashing</strong></dt>
<dd>
Monitor cache hit rates and access patterns. Implement cache warming
strategies and consider hierarchical caching with different eviction
policies for different access patterns.
</dd>
<dt><strong>Memory Leaks in Long-Running Sessions</strong></dt>
<dd>
Use memory profiling tools and implement periodic cache cleanup. Track
object lifetimes and ensure proper cleanup in error conditions.
</dd>
<dt><strong>Cache Inconsistency</strong></dt>
<dd>
Implement cache invalidation strategies and consistency checking. Use
versioning or timestamps to detect stale cache entries.
</dd>
</dl>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Cache debugging and optimization</span></span>
<span><span class="va">implement_cache_diagnostics</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">backend</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Cache performance analysis</span></span>
<span>  <span class="va">analyze_cache_performance</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">backend</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">cache_stats</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      timestamp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      total_items <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">backend</span><span class="op">$</span><span class="va">data_chunks_cache</span><span class="op">)</span>,</span>
<span>      hit_rate <span class="op">=</span> <span class="va">backend</span><span class="op">$</span><span class="va">cache_hits</span> <span class="op">/</span> <span class="op">(</span><span class="va">backend</span><span class="op">$</span><span class="va">cache_hits</span> <span class="op">+</span> <span class="va">backend</span><span class="op">$</span><span class="va">cache_misses</span><span class="op">)</span>,</span>
<span>      memory_usage_mb <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">backend</span><span class="op">$</span><span class="va">data_chunks_cache</span>, <span class="va">object.size</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fl">1e6</span>,</span>
<span>      access_patterns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Analyze access patterns</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">backend</span><span class="op">$</span><span class="va">access_history</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">access_intervals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="va">backend</span><span class="op">$</span><span class="va">access_history</span><span class="op">)</span></span>
<span>      <span class="va">cache_stats</span><span class="op">$</span><span class="va">access_patterns</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        mean_interval <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">access_intervals</span><span class="op">)</span>,</span>
<span>        sequential_accesses <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">access_intervals</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">access_intervals</span><span class="op">)</span>,</span>
<span>        random_accesses <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">access_intervals</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">10</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">access_intervals</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="co"># Identify cache hotspots</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">backend</span><span class="op">$</span><span class="va">data_chunks_cache</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">cache_access_counts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">backend</span><span class="op">$</span><span class="va">data_chunks_cache</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">key</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="co"># In practice, track actual access counts</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">100</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>      <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>      <span class="va">cache_stats</span><span class="op">$</span><span class="va">hotspots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        most_accessed <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">cache_access_counts</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>,</span>
<span>        least_accessed <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">cache_access_counts</span>, decreasing <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">cache_stats</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Cache optimization recommendations</span></span>
<span>  <span class="va">generate_cache_recommendations</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">cache_stats</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">recommendations</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Hit rate analysis</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">cache_stats</span><span class="op">$</span><span class="va">hit_rate</span> <span class="op">&lt;</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">recommendations</span><span class="op">$</span><span class="va">low_hit_rate</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        issue <span class="op">=</span> <span class="st">"Low cache hit rate"</span>,</span>
<span>        suggestion <span class="op">=</span> <span class="st">"Consider increasing cache size or adjusting eviction policy"</span>,</span>
<span>        current_rate <span class="op">=</span> <span class="va">cache_stats</span><span class="op">$</span><span class="va">hit_rate</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="co"># Memory usage analysis</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">cache_stats</span><span class="op">$</span><span class="va">memory_usage_mb</span> <span class="op">&gt;</span> <span class="fl">512</span><span class="op">)</span> <span class="op">{</span> <span class="co"># Arbitrary threshold</span></span>
<span>      <span class="va">recommendations</span><span class="op">$</span><span class="va">high_memory</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        issue <span class="op">=</span> <span class="st">"High cache memory usage"</span>,</span>
<span>        suggestion <span class="op">=</span> <span class="st">"Consider implementing more aggressive eviction or cache compression"</span>,</span>
<span>        current_usage <span class="op">=</span> <span class="va">cache_stats</span><span class="op">$</span><span class="va">memory_usage_mb</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="co"># Access pattern analysis</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">cache_stats</span><span class="op">$</span><span class="va">access_patterns</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="va">cache_stats</span><span class="op">$</span><span class="va">access_patterns</span><span class="op">$</span><span class="va">sequential_accesses</span> <span class="op">&gt;</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">recommendations</span><span class="op">$</span><span class="va">sequential_pattern</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>          issue <span class="op">=</span> <span class="st">"Highly sequential access pattern detected"</span>,</span>
<span>          suggestion <span class="op">=</span> <span class="st">"Consider implementing prefetching for sequential data"</span>,</span>
<span>          sequential_ratio <span class="op">=</span> <span class="va">cache_stats</span><span class="op">$</span><span class="va">access_patterns</span><span class="op">$</span><span class="va">sequential_accesses</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="va">cache_stats</span><span class="op">$</span><span class="va">access_patterns</span><span class="op">$</span><span class="va">random_accesses</span> <span class="op">&gt;</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">recommendations</span><span class="op">$</span><span class="va">random_pattern</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>          issue <span class="op">=</span> <span class="st">"Highly random access pattern detected"</span>,</span>
<span>          suggestion <span class="op">=</span> <span class="st">"Consider larger cache size and LRU eviction policy"</span>,</span>
<span>          random_ratio <span class="op">=</span> <span class="va">cache_stats</span><span class="op">$</span><span class="va">access_patterns</span><span class="op">$</span><span class="va">random_accesses</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">recommendations</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    analyze_performance <span class="op">=</span> <span class="va">analyze_cache_performance</span>,</span>
<span>    generate_recommendations <span class="op">=</span> <span class="va">generate_cache_recommendations</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="integration-with-other-vignettes">Integration with Other Vignettes<a class="anchor" aria-label="anchor" href="#integration-with-other-vignettes"></a>
</h2>
<p>This advanced backend development guide represents the culmination of
the fmridataset extension system:</p>
<p><strong>Foundation Knowledge</strong>: Start with <a href="backend-registry.html">Backend Registry</a> to understand the
basic backend contract and registration system before attempting
advanced development.</p>
<p><strong>Architecture Context</strong>: The <a href="architecture-overview.html">Architecture Overview</a> provides the
theoretical foundation for understanding how advanced backends fit into
the overall system design.</p>
<p><strong>Practical Application</strong>: - <a href="fmridataset-intro.html">Getting Started</a> - See how advanced
backends appear to end users - <a href="study-level-analysis.html">Study-Level Analysis</a> - Understand
how advanced backends scale to multi-subject studies - <a href="h5-backend-usage.html">H5 Backend Usage</a> - Example of a
production-quality backend implementation</p>
<p><strong>Production Deployment</strong>: The techniques in this
vignette enable backends that can handle enterprise-scale neuroimaging
workflows with requirements for reliability, performance, and
scalability that go far beyond research prototypes.</p>
<p><strong>Ecosystem Integration</strong>: Advanced backends can
integrate with cloud platforms, distributed computing systems, and
real-time data acquisition systems, enabling fmridataset to work in
modern neuroimaging infrastructure environments.</p>
</div>
<div class="section level2">
<h2 id="session-information">Session Information<a class="anchor" aria-label="anchor" href="#session-information"></a>
</h2>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Bradley Buchsbaum.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
