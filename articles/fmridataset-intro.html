<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Getting Started with fmridataset • fmridataset</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Getting Started with fmridataset">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">fmridataset</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.8.9</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/architecture-overview.html">Architecture Deep Dive: Design Principles and Extensibility</a></li>
    <li><a class="dropdown-item" href="../articles/backend-development-basics.html">Backend Development Basics: Creating Custom Storage Backends</a></li>
    <li><a class="dropdown-item" href="../articles/backend-registry.html">Backend Registry: Extending Data Format Support</a></li>
    <li><a class="dropdown-item" href="../articles/extending-backends.html">Advanced Backend Development: Storage Extensions</a></li>
    <li><a class="dropdown-item" href="../articles/fmridataset-intro.html">Getting Started with fmridataset</a></li>
    <li><a class="dropdown-item" href="../articles/h5-backend-usage.html">HDF5 Storage: High-Performance Data Management for Large-Scale fMRI Studies</a></li>
    <li><a class="dropdown-item" href="../articles/study-level-analysis.html">Scaling to Study-Level Analysis: From Single Subjects to Group Studies</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/bbuchsbaum/fmridataset/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Getting Started with fmridataset</h1>
                        <h4 data-toc-skip class="author">fmridataset
Team</h4>
            
            <h4 data-toc-skip class="date">2026-01-22</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/bbuchsbaum/fmridataset/blob/main/vignettes/fmridataset-intro.Rmd" class="external-link"><code>vignettes/fmridataset-intro.Rmd</code></a></small>
      <div class="d-none name"><code>fmridataset-intro.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="motivation-unified-fmri-data-access">Motivation: Unified fMRI Data Access<a class="anchor" aria-label="anchor" href="#motivation-unified-fmri-data-access"></a>
</h2>
<p>fMRI analyses frequently involve heterogeneous data sources: NIfTI
files from different scanners, BIDS-organized datasets, preprocessed
matrices from various pipelines, and archived HDF5 files. Each format
traditionally requires distinct loading procedures, memory management
approaches, and temporal organization methods.</p>
<p>The fmridataset package provides a unified interface layer that
abstracts these format-specific differences. This abstraction
enables:</p>
<ul>
<li>
<strong>Consistent data access</strong>: Identical functions work
across all supported formats</li>
<li>
<strong>Format-specific optimization</strong>: Each backend
implements optimal loading strategies</li>
<li>
<strong>Temporal structure preservation</strong>: Unified handling
of runs, TR, and event timing</li>
<li>
<strong>Memory efficiency</strong>: Lazy loading and chunking
strategies adapt to data characteristics</li>
</ul>
</div>
<div class="section level2">
<h2 id="quick-start-multi-format-data-access">Quick Start: Multi-Format Data Access<a class="anchor" aria-label="anchor" href="#quick-start-multi-format-data-access"></a>
</h2>
<p>Let’s jump into a concrete example that shows how fmridataset
simplifies a typical workflow. We’ll create a dataset from a simple
matrix, add temporal structure and experimental events, then demonstrate
the unified interface for data access:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bbuchsbaum/fmridataset" class="external-link">fmridataset</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create realistic synthetic fMRI data using helper function</span></span>
<span><span class="va">activation_periods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">20</span><span class="op">:</span><span class="fl">30</span>, <span class="fl">50</span><span class="op">:</span><span class="fl">60</span>, <span class="fl">120</span><span class="op">:</span><span class="fl">130</span>, <span class="fl">150</span><span class="op">:</span><span class="fl">160</span><span class="op">)</span></span>
<span><span class="va">fmri_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_example_fmri_data.html">generate_example_fmri_data</a></span><span class="op">(</span></span>
<span>  n_timepoints <span class="op">=</span> <span class="fl">200</span>,</span>
<span>  n_voxels <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  n_active <span class="op">=</span> <span class="fl">100</span>,</span>
<span>  activation_periods <span class="op">=</span> <span class="va">activation_periods</span>,</span>
<span>  signal_strength <span class="op">=</span> <span class="fl">0.5</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create dataset with temporal structure</span></span>
<span><span class="va">dataset</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/matrix_dataset.html">matrix_dataset</a></span><span class="op">(</span></span>
<span>  datamat <span class="op">=</span> <span class="va">fmri_matrix</span>,</span>
<span>  TR <span class="op">=</span> <span class="fl">2.0</span>, <span class="co"># 2-second repetition time</span></span>
<span>  run_length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">100</span><span class="op">)</span> <span class="co"># Two runs of 100 timepoints each</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add experimental design using helper function</span></span>
<span><span class="va">events</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_example_events.html">generate_example_events</a></span><span class="op">(</span></span>
<span>  n_runs <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  events_per_run <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  TR <span class="op">=</span> <span class="fl">2.0</span>,</span>
<span>  run_length <span class="op">=</span> <span class="fl">100</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">dataset</span><span class="op">$</span><span class="va">event_table</span> <span class="op">&lt;-</span> <span class="va">events</span></span>
<span></span>
<span><span class="co"># Display the dataset</span></span>
<span><span class="fu"><a href="../reference/print_dataset_info.html">print_dataset_info</a></span><span class="op">(</span><span class="va">dataset</span>, <span class="st">"Dataset Summary"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Dataset Summary</span></span>
<span><span class="co">#&gt; ---------------</span></span>
<span><span class="co">#&gt; Dataset class: matrix_dataset, fmri_dataset, list </span></span>
<span><span class="co">#&gt; TR: 2 seconds</span></span>
<span><span class="co">#&gt; Number of runs: 2 </span></span>
<span><span class="co">#&gt; Run lengths: 100 100 </span></span>
<span><span class="co">#&gt; Total timepoints: 200 </span></span>
<span><span class="co">#&gt; Events: 4 events across 2 runs</span></span></code></pre></div>
<p>Now let’s see the unified interface in action:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Access temporal information (same methods regardless of data source)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"TR:"</span>, <span class="fu"><a href="../reference/get_TR.html">get_TR</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">)</span>, <span class="st">"seconds\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; TR: 2 seconds</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Number of runs:"</span>, <span class="fu"><a href="../reference/n_runs.html">n_runs</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Number of runs: 2</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Total timepoints:"</span>, <span class="fu"><a href="../reference/n_timepoints.html">n_timepoints</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Total timepoints: 200</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Run durations:"</span>, <span class="fu"><a href="../reference/get_run_duration.html">get_run_duration</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">)</span>, <span class="st">"seconds\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Run durations: 200 200 seconds</span></span>
<span></span>
<span><span class="co"># Get data for analysis (returns standard R matrix)</span></span>
<span><span class="va">all_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_data_matrix.html">get_data_matrix</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Full data dimensions:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">all_data</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Full data dimensions: 200 1000</span></span>
<span></span>
<span><span class="co"># Get data from specific runs</span></span>
<span><span class="va">run1_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_data_matrix.html">get_data_matrix</a></span><span class="op">(</span><span class="va">dataset</span>, run_id <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Run 1 dimensions:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">run1_data</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Run 1 dimensions: 200 1000</span></span>
<span></span>
<span><span class="co"># Access experimental events</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nEvent Table:\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Event Table:</span></span>
<span><span class="fu"><a href="../reference/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">$</span><span class="va">event_table</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;       onset duration trial_type run</span></span>
<span><span class="co">#&gt; 1  66.66667       10     task_A   1</span></span>
<span><span class="co">#&gt; 2 133.33333       10     task_B   1</span></span>
<span><span class="co">#&gt; 3 266.66667       10     task_A   2</span></span>
<span><span class="co">#&gt; 4 333.33333       10     task_B   2</span></span></code></pre></div>
<p><strong>Technical Note</strong>: This unified interface operates
through backend abstraction. Each data format implements the same
contract, enabling format-independent analysis code.</p>
</div>
<div class="section level2">
<h2 id="core-concepts">Core Concepts<a class="anchor" aria-label="anchor" href="#core-concepts"></a>
</h2>
<p>Now that we’ve seen the unified interface in action, let’s understand
the key abstractions that make fmridataset powerful and flexible.</p>
<div class="section level3">
<h3 id="the-dataset-your-analysis-starting-point">The Dataset: Your Analysis Starting Point<a class="anchor" aria-label="anchor" href="#the-dataset-your-analysis-starting-point"></a>
</h3>
<p>A dataset in fmridataset represents everything you need for fMRI
analysis in one unified object. Think of it as a smart container that
knows about your data’s spatial organization (which voxels contain brain
tissue), temporal structure (how timepoints are organized into runs),
and experimental design (when events occurred). Unlike working with raw
files or matrices, a dataset maintains all this metadata and provides
consistent access methods regardless of how the underlying data is
stored.</p>
<p>This abstraction enables analysis functions to operate on any dataset
type through method dispatch. The dataset implementation handles
format-specific I/O operations while maintaining consistent public
methods across all backends.</p>
</div>
<div class="section level3">
<h3 id="storage-backends-format-independence">Storage Backends: Format Independence<a class="anchor" aria-label="anchor" href="#storage-backends-format-independence"></a>
</h3>
<p>Behind every dataset is a storage backend that handles the actual
data input/output operations. When you create a dataset from NIfTI
files, fmridataset automatically creates a NIfTI backend that knows how
to read those files efficiently. If you create a dataset from a matrix,
it uses a matrix backend optimized for in-memory data.</p>
<p>This separation between interface and implementation enables format
independence through the backend abstraction layer. Backend
implementations provide lazy loading for file-based data sources and
chunked processing for memory-constrained operations.</p>
</div>
<div class="section level3">
<h3 id="temporal-structure-more-than-just-time">Temporal Structure: More Than Just Time<a class="anchor" aria-label="anchor" href="#temporal-structure-more-than-just-time"></a>
</h3>
<p>fMRI data has rich temporal structure that goes beyond simple time
series. Runs may have different lengths, repetition times vary between
studies, and experimental events need to be aligned with acquisition
timing. The sampling frame abstraction captures all this temporal
complexity in a unified model.</p>
<p>Sampling frames maintain run boundary information and time-to-sample
index mappings. They provide methods for run-specific data extraction
and temporal unit conversion between seconds and TR indices.</p>
</div>
<div class="section level3">
<h3 id="data-chunking-efficiency-without-complexity">Data Chunking: Efficiency Without Complexity<a class="anchor" aria-label="anchor" href="#data-chunking-efficiency-without-complexity"></a>
</h3>
<p>Modern fMRI datasets can be enormous, often exceeding available
memory. Traditional approaches require you to manually split data into
pieces and carefully manage memory usage. fmridataset provides automatic
data chunking that handles this complexity transparently.</p>
<p>The chunking system partitions datasets into memory-manageable
segments for independent processing. Chunk generation uses configurable
parameters (<code>nchunks</code>, <code>runwise</code>) to determine
voxel groupings, with each chunk containing data subsets and
corresponding voxel metadata.</p>
</div>
</div>
<div class="section level2">
<h2 id="deep-dive-creating-and-using-datasets">Deep Dive: Creating and Using Datasets<a class="anchor" aria-label="anchor" href="#deep-dive-creating-and-using-datasets"></a>
</h2>
<p>With the fundamentals clear, let’s explore how to create datasets
from different sources and use their full capabilities effectively.</p>
<div class="section level3">
<h3 id="creating-datasets-from-different-sources">Creating Datasets from Different Sources<a class="anchor" aria-label="anchor" href="#creating-datasets-from-different-sources"></a>
</h3>
<div class="section level4">
<h4 id="matrix-datasets-when-data-is-already-in-memory">Matrix Datasets: When Data is Already in Memory<a class="anchor" aria-label="anchor" href="#matrix-datasets-when-data-is-already-in-memory"></a>
</h4>
<p>Matrix datasets are perfect when you already have preprocessed data
in R or when working with simulated data. They provide the fastest
access since no file I/O is required:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create from existing matrix</span></span>
<span><span class="va">data_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1000</span> <span class="op">*</span> <span class="fl">150</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">150</span>, ncol <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dataset</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/matrix_dataset.html">matrix_dataset</a></span><span class="op">(</span></span>
<span>  datamat <span class="op">=</span> <span class="va">data_matrix</span>,</span>
<span>  TR <span class="op">=</span> <span class="fl">2.5</span>,</span>
<span>  run_length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">75</span>, <span class="fl">75</span><span class="op">)</span> <span class="co"># Two equal runs</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Immediate access - no loading delay</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_data_matrix.html">get_data_matrix</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Matrix dataset dimensions:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Matrix dataset dimensions: 150 1000</span></span></code></pre></div>
<p>Matrix datasets store all data in memory, providing optimal access
performance for datasets within available RAM limits.</p>
</div>
<div class="section level4">
<h4 id="file-datasets-lazy-loading-for-large-data">File Datasets: Lazy Loading for Large Data<a class="anchor" aria-label="anchor" href="#file-datasets-lazy-loading-for-large-data"></a>
</h4>
<p>File datasets work with NIfTI files and implement lazy loading, where
data remains on disk until explicitly accessed:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># File-based dataset (paths would be real NIfTI files)</span></span>
<span><span class="va">file_paths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"/path/to/subject01_run1.nii.gz"</span>,</span>
<span>  <span class="st">"/path/to/subject01_run2.nii.gz"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">mask_path</span> <span class="op">&lt;-</span> <span class="st">"/path/to/brain_mask.nii.gz"</span></span>
<span></span>
<span><span class="co"># Creating the dataset doesn't load any data</span></span>
<span><span class="va">dataset</span> <span class="op">&lt;-</span> <span class="fu">fmri_file_dataset</span><span class="op">(</span></span>
<span>  scans <span class="op">=</span> <span class="va">file_paths</span>,</span>
<span>  mask <span class="op">=</span> <span class="va">mask_path</span>,</span>
<span>  TR <span class="op">=</span> <span class="fl">2.0</span>,</span>
<span>  run_length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">180</span>, <span class="fl">180</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Data loads when first accessed</span></span>
<span><span class="fu"><a href="../reference/print.html">print</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">)</span> <span class="co"># Shows metadata only</span></span>
<span><span class="co"># data &lt;- get_data_matrix(dataset)  # This would trigger loading</span></span></code></pre></div>
<p>File datasets implement lazy loading and apply brain mask filtering
to minimize memory requirements.</p>
</div>
<div class="section level4">
<h4 id="memory-datasets-working-with-neurovec-objects">Memory Datasets: Working with NeuroVec Objects<a class="anchor" aria-label="anchor" href="#memory-datasets-working-with-neurovec-objects"></a>
</h4>
<p>If you’re already using the neuroim2 package, memory datasets let you
work with existing NeuroVec objects:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Example with NeuroVec objects (requires neuroim2)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"neuroim2"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Create example NeuroVec</span></span>
<span>  <span class="va">dims</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">10</span>, <span class="fl">10</span>, <span class="fl">100</span><span class="op">)</span> <span class="co"># 10x10x10 voxels, 100 timepoints</span></span>
<span>  <span class="va">nvec</span> <span class="op">&lt;-</span> <span class="fu">neuroim2</span><span class="fu">::</span><span class="fu"><a href="https://bbuchsbaum.github.io/neuroim2/reference/NeuroVec-class.html" class="external-link">NeuroVec</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/prod.html" class="external-link">prod</a></span><span class="op">(</span><span class="va">dims</span><span class="op">)</span><span class="op">)</span>, <span class="va">dims</span><span class="op">)</span>,</span>
<span>    space <span class="op">=</span> <span class="fu">neuroim2</span><span class="fu">::</span><span class="fu"><a href="https://bbuchsbaum.github.io/neuroim2/reference/NeuroSpace.html" class="external-link">NeuroSpace</a></span><span class="op">(</span><span class="va">dims</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Create mask</span></span>
<span>  <span class="va">mask_dims</span> <span class="op">&lt;-</span> <span class="va">dims</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span></span>
<span>  <span class="va">mask</span> <span class="op">&lt;-</span> <span class="fu">neuroim2</span><span class="fu">::</span><span class="fu"><a href="https://bbuchsbaum.github.io/neuroim2/reference/NeuroVol.html" class="external-link">NeuroVol</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">mask_dims</span><span class="op">)</span>,</span>
<span>    space <span class="op">=</span> <span class="fu">neuroim2</span><span class="fu">::</span><span class="fu"><a href="https://bbuchsbaum.github.io/neuroim2/reference/NeuroSpace.html" class="external-link">NeuroSpace</a></span><span class="op">(</span><span class="va">mask_dims</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Create dataset</span></span>
<span>  <span class="va">dataset</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fmri_mem_dataset.html">fmri_mem_dataset</a></span><span class="op">(</span></span>
<span>    scans <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">nvec</span><span class="op">)</span>,</span>
<span>    mask <span class="op">=</span> <span class="va">mask</span>,</span>
<span>    TR <span class="op">=</span> <span class="fl">2.0</span>,</span>
<span>    run_length <span class="op">=</span> <span class="fl">100</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Memory datasets preserve the spatial structure of NeuroVec objects
while providing the unified dataset interface.</p>
</div>
</div>
<div class="section level3">
<h3 id="accessing-data-efficiently">Accessing Data Efficiently<a class="anchor" aria-label="anchor" href="#accessing-data-efficiently"></a>
</h3>
<div class="section level4">
<h4 id="direct-data-access">Direct Data Access<a class="anchor" aria-label="anchor" href="#direct-data-access"></a>
</h4>
<p>The primary way to get data is through
<code><a href="../reference/get_data_matrix.html">get_data_matrix()</a></code>, which always returns a standard R matrix
in timepoints × voxels orientation:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get complete dataset</span></span>
<span><span class="va">full_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_data_matrix.html">get_data_matrix</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Full data shape:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">full_data</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Full data shape: 100 1000</span></span>
<span></span>
<span><span class="co"># Get specific runs</span></span>
<span><span class="va">run1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_data_matrix.html">get_data_matrix</a></span><span class="op">(</span><span class="va">dataset</span>, run_id <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">run2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_data_matrix.html">get_data_matrix</a></span><span class="op">(</span><span class="va">dataset</span>, run_id <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Run 1 shape:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">run1</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Run 1 shape: 100 1000</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Run 2 shape:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">run2</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Run 2 shape: 100 1000</span></span>
<span></span>
<span><span class="co"># Get multiple runs</span></span>
<span><span class="va">runs_1_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_data_matrix.html">get_data_matrix</a></span><span class="op">(</span><span class="va">dataset</span>, run_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Runs 1-2 combined shape:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">runs_1_2</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Runs 1-2 combined shape: 100 1000</span></span></code></pre></div>
<p>For file-based datasets, these operations trigger data loading. The
package automatically applies brain masks and handles any necessary
format conversions.</p>
</div>
<div class="section level4">
<h4 id="memory-efficient-chunking">Memory-Efficient Chunking<a class="anchor" aria-label="anchor" href="#memory-efficient-chunking"></a>
</h4>
<p>For large datasets, chunking enables processing without loading
everything into memory:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create chunks for processing</span></span>
<span><span class="va">chunks</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/data_chunks.html">data_chunks</a></span><span class="op">(</span><span class="va">dataset</span>, nchunks <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Process each chunk independently</span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">chunk</span> <span class="kw">in</span> <span class="va">chunks</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span></span>
<span>    <span class="st">"Processing chunk"</span>, <span class="va">chunk</span><span class="op">$</span><span class="va">chunk_num</span>,</span>
<span>    <span class="st">"with"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">chunk</span><span class="op">$</span><span class="va">data</span><span class="op">)</span>, <span class="st">"voxels\n"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Your analysis here - each chunk$data is a standard matrix</span></span>
<span>  <span class="va">chunk_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">chunk</span><span class="op">$</span><span class="va">data</span><span class="op">)</span> <span class="co"># Example: compute mean time series</span></span>
<span>  <span class="va">results</span><span class="op">[[</span><span class="va">chunk</span><span class="op">$</span><span class="va">chunk_num</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">chunk_result</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Combine results</span></span>
<span><span class="va">all_means</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">c</span>, <span class="va">results</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Computed means for"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">all_means</span><span class="op">)</span>, <span class="st">"total voxels\n"</span><span class="op">)</span></span></code></pre></div>
<p>The chunking system automatically divides voxels optimally and
provides metadata about which voxels each chunk contains.</p>
</div>
<div class="section level4">
<h4 id="run-wise-processing">Run-wise Processing<a class="anchor" aria-label="anchor" href="#run-wise-processing"></a>
</h4>
<p>Many fMRI analyses need to process runs separately. The chunking
system supports this directly:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create one chunk per run</span></span>
<span><span class="va">run_chunks</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/data_chunks.html">data_chunks</a></span><span class="op">(</span><span class="va">dataset</span>, runwise <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Process runs independently</span></span>
<span><span class="va">run_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">chunk</span> <span class="kw">in</span> <span class="va">run_chunks</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span></span>
<span>    <span class="st">"Processing run"</span>, <span class="va">chunk</span><span class="op">$</span><span class="va">chunk_num</span>,</span>
<span>    <span class="st">"with"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">chunk</span><span class="op">$</span><span class="va">data</span><span class="op">)</span>, <span class="st">"timepoints\n"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Run-specific analysis</span></span>
<span>  <span class="va">run_results</span><span class="op">[[</span><span class="va">chunk</span><span class="op">$</span><span class="va">chunk_num</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/analyze_run.html">analyze_run</a></span><span class="op">(</span><span class="va">chunk</span><span class="op">$</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Run-wise chunking ensures each chunk contains data from exactly one
run, making it perfect for analyses that require run boundaries.</p>
</div>
</div>
<div class="section level3">
<h3 id="working-with-temporal-structure">Working with Temporal Structure<a class="anchor" aria-label="anchor" href="#working-with-temporal-structure"></a>
</h3>
<div class="section level4">
<h4 id="understanding-sampling-frames">Understanding Sampling Frames<a class="anchor" aria-label="anchor" href="#understanding-sampling-frames"></a>
</h4>
<p>Every dataset contains a sampling frame that captures temporal
organization:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Access the sampling frame</span></span>
<span><span class="va">sf</span> <span class="op">&lt;-</span> <span class="va">dataset</span><span class="op">$</span><span class="va">sampling_frame</span></span>
<span><span class="fu"><a href="../reference/print.html">print</a></span><span class="op">(</span><span class="va">sf</span><span class="op">)</span></span>
<span><span class="co">#&gt; Sampling Frame</span></span>
<span><span class="co">#&gt; ==============</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Structure:</span></span>
<span><span class="co">#&gt;   1 block</span></span>
<span><span class="co">#&gt;   Total scans: 100</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Timing:</span></span>
<span><span class="co">#&gt;   TR: 2 s</span></span>
<span><span class="co">#&gt;   Precision: 0.1 s</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Duration:</span></span>
<span><span class="co">#&gt;   Total time: 200.0 s</span></span>
<span></span>
<span><span class="co"># Query temporal properties</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"TR:"</span>, <span class="fu"><a href="../reference/get_TR.html">get_TR</a></span><span class="op">(</span><span class="va">sf</span><span class="op">)</span>, <span class="st">"seconds\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; TR: 2 seconds</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Number of runs:"</span>, <span class="fu"><a href="../reference/n_runs.html">n_runs</a></span><span class="op">(</span><span class="va">sf</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Number of runs: 1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Run lengths:"</span>, <span class="fu"><a href="../reference/get_run_lengths.html">get_run_lengths</a></span><span class="op">(</span><span class="va">sf</span><span class="op">)</span>, <span class="st">"timepoints\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Run lengths: 100 timepoints</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Total duration:"</span>, <span class="fu"><a href="../reference/get_total_duration.html">get_total_duration</a></span><span class="op">(</span><span class="va">sf</span><span class="op">)</span>, <span class="st">"seconds\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Total duration: 200 seconds</span></span>
<span></span>
<span><span class="co"># Get timing information</span></span>
<span><span class="va">run_durations</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_run_duration.html">get_run_duration</a></span><span class="op">(</span><span class="va">sf</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Run durations:"</span>, <span class="va">run_durations</span>, <span class="st">"seconds\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Run durations: 200 seconds</span></span>
<span></span>
<span><span class="co"># Access sample indices for each run</span></span>
<span><span class="va">run_samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/samples.html">samples</a></span><span class="op">(</span><span class="va">sf</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Run 1 samples:"</span>, <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">run_samples</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, <span class="st">"...\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Run 1 samples: 1 ...</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Run 2 samples:"</span>, <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">run_samples</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, <span class="st">"...\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Run 2 samples: 2 ...</span></span></code></pre></div>
<p>The sampling frame provides all the temporal metadata needed for
sophisticated time series analyses.</p>
</div>
<div class="section level4">
<h4 id="converting-between-time-and-samples">Converting Between Time and Samples<a class="anchor" aria-label="anchor" href="#converting-between-time-and-samples"></a>
</h4>
<p>Sampling frames enable easy conversion between time units and sample
indices:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Convert event times to sample indices</span></span>
<span><span class="va">event_onsets</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">75</span>, <span class="fl">130</span>, <span class="fl">175</span><span class="op">)</span> <span class="co"># seconds</span></span>
<span><span class="va">TR</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_TR.html">get_TR</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">$</span><span class="va">sampling_frame</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Manual conversion</span></span>
<span><span class="va">sample_indices</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">event_onsets</span> <span class="op">/</span> <span class="va">TR</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Event onsets at samples:"</span>, <span class="va">sample_indices</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Event onsets at samples: 16 39 66 89</span></span>
<span></span>
<span><span class="co"># Use sampling frame for run-aware conversions</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">run_idx</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="../reference/n_runs.html">n_runs</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">$</span><span class="va">sampling_frame</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">run_start</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/samples.html">samples</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">$</span><span class="va">sampling_frame</span><span class="op">)</span><span class="op">[[</span><span class="va">run_idx</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Run"</span>, <span class="va">run_idx</span>, <span class="st">"starts at global sample"</span>, <span class="va">run_start</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Run 1 starts at global sample 1</span></span></code></pre></div>
<p>This timing awareness is crucial for proper event-related analyses
and temporal alignment.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="advanced-topics">Advanced Topics<a class="anchor" aria-label="anchor" href="#advanced-topics"></a>
</h2>
<p>Once you’re comfortable with basic dataset creation and access, these
advanced techniques help you handle complex scenarios and optimize
performance.</p>
<div class="section level3">
<h3 id="memory-management-strategies">Memory Management Strategies<a class="anchor" aria-label="anchor" href="#memory-management-strategies"></a>
</h3>
<p>Understanding when data is loaded helps you optimize memory usage for
large datasets:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># File datasets: creation is cheap, access triggers loading</span></span>
<span><span class="va">file_dataset</span> <span class="op">&lt;-</span> <span class="fu">fmri_file_dataset</span><span class="op">(</span><span class="va">file_paths</span>, <span class="va">mask_path</span>, TR <span class="op">=</span> <span class="fl">2.0</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Created file dataset (no data loaded yet)\n"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># First access loads data</span></span>
<span><span class="va">first_access</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_data_matrix.html">get_data_matrix</a></span><span class="op">(</span><span class="va">file_dataset</span>, run_id <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Loaded run 1:"</span>, <span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">first_access</span><span class="op">)</span>, <span class="st">"bytes\n"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Subsequent accesses use cached data</span></span>
<span><span class="va">second_access</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_data_matrix.html">get_data_matrix</a></span><span class="op">(</span><span class="va">file_dataset</span>, run_id <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Second access (cached)\n"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Convert to matrix dataset to keep everything in memory</span></span>
<span><span class="va">matrix_version</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/as.matrix_dataset.html">as.matrix_dataset</a></span><span class="op">(</span><span class="va">file_dataset</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Converted to matrix dataset\n"</span><span class="op">)</span></span></code></pre></div>
<p>Use file datasets for exploration and convert to matrix datasets when
you need repeated fast access to the same data.</p>
</div>
<div class="section level3">
<h3 id="custom-event-integration">Custom Event Integration<a class="anchor" aria-label="anchor" href="#custom-event-integration"></a>
</h3>
<p>Experimental design information integrates seamlessly with temporal
structure:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create detailed event table</span></span>
<span><span class="va">events</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  onset <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">30</span>, <span class="fl">50</span>, <span class="fl">70</span>, <span class="fl">110</span>, <span class="fl">130</span>, <span class="fl">150</span>, <span class="fl">170</span><span class="op">)</span>,</span>
<span>  duration <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  trial_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"faces"</span>, <span class="st">"houses"</span><span class="op">)</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>  amplitude <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  run <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add to dataset</span></span>
<span><span class="va">dataset</span><span class="op">$</span><span class="va">event_table</span> <span class="op">&lt;-</span> <span class="va">events</span></span>
<span></span>
<span><span class="co"># Analyze events in context of temporal structure</span></span>
<span><span class="va">TR</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_TR.html">get_TR</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">$</span><span class="va">sampling_frame</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">events</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">onset_sample</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">events</span><span class="op">$</span><span class="va">onset</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">/</span> <span class="va">TR</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>  <span class="va">run_id</span> <span class="op">&lt;-</span> <span class="va">events</span><span class="op">$</span><span class="va">run</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span></span>
<span>    <span class="st">"Event"</span>, <span class="va">i</span>, <span class="st">":"</span>, <span class="va">events</span><span class="op">$</span><span class="va">trial_type</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>    <span class="st">"at sample"</span>, <span class="va">onset_sample</span>, <span class="st">"in run"</span>, <span class="va">run_id</span>, <span class="st">"\n"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Event 1 : faces at sample 6 in run 1 </span></span>
<span><span class="co">#&gt; Event 2 : houses at sample 16 in run 1 </span></span>
<span><span class="co">#&gt; Event 3 : faces at sample 26 in run 1 </span></span>
<span><span class="co">#&gt; Event 4 : houses at sample 36 in run 1 </span></span>
<span><span class="co">#&gt; Event 5 : faces at sample 56 in run 2 </span></span>
<span><span class="co">#&gt; Event 6 : houses at sample 66 in run 2 </span></span>
<span><span class="co">#&gt; Event 7 : faces at sample 76 in run 2 </span></span>
<span><span class="co">#&gt; Event 8 : houses at sample 86 in run 2</span></span>
<span></span>
<span><span class="co"># Extract data around events</span></span>
<span><span class="va">extract_event_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dataset</span>, <span class="va">event_row</span>, <span class="va">window</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span>, <span class="fl">8</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">TR</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_TR.html">get_TR</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">$</span><span class="va">sampling_frame</span><span class="op">)</span></span>
<span>  <span class="va">onset_sample</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">event_row</span><span class="op">$</span><span class="va">onset</span> <span class="op">/</span> <span class="va">TR</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>  <span class="va">run_id</span> <span class="op">&lt;-</span> <span class="va">event_row</span><span class="op">$</span><span class="va">run</span></span>
<span></span>
<span>  <span class="co"># Get samples for this window</span></span>
<span>  <span class="va">samples</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">onset_sample</span> <span class="op">+</span> <span class="va">window</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="va">onset_sample</span> <span class="op">+</span> <span class="va">window</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Extract data for this run and time window</span></span>
<span>  <span class="va">run_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_data_matrix.html">get_data_matrix</a></span><span class="op">(</span><span class="va">dataset</span>, run_id <span class="op">=</span> <span class="va">run_id</span><span class="op">)</span></span>
<span>  <span class="va">event_data</span> <span class="op">&lt;-</span> <span class="va">run_data</span><span class="op">[</span><span class="va">samples</span>, , drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">event_data</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Example: extract data around first event</span></span>
<span><span class="va">event1_data</span> <span class="op">&lt;-</span> <span class="fu">extract_event_data</span><span class="op">(</span><span class="va">dataset</span>, <span class="va">events</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Event 1 data shape:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">event1_data</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Event 1 data shape: 11 1000</span></span></code></pre></div>
<p>This integration of experimental design with temporal structure
enables sophisticated event-related analyses.</p>
</div>
<div class="section level3">
<h3 id="performance-optimization">Performance Optimization<a class="anchor" aria-label="anchor" href="#performance-optimization"></a>
</h3>
<p>Several strategies can significantly improve performance for large
datasets:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Strategy 1: Use appropriate chunk sizes</span></span>
<span><span class="va">small_chunks</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/data_chunks.html">data_chunks</a></span><span class="op">(</span><span class="va">dataset</span>, nchunks <span class="op">=</span> <span class="fl">20</span><span class="op">)</span> <span class="co"># Many small chunks</span></span>
<span><span class="va">large_chunks</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/data_chunks.html">data_chunks</a></span><span class="op">(</span><span class="va">dataset</span>, nchunks <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="co"># Fewer large chunks</span></span>
<span></span>
<span><span class="co"># Strategy 2: Process runs separately when appropriate</span></span>
<span><span class="va">run_chunks</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/data_chunks.html">data_chunks</a></span><span class="op">(</span><span class="va">dataset</span>, runwise <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Strategy 3: Use partial loading for file datasets</span></span>
<span><span class="va">partial_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_data_matrix.html">get_data_matrix</a></span><span class="op">(</span><span class="va">dataset</span>, run_id <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="co"># Load only one run</span></span>
<span></span>
<span><span class="co"># Strategy 4: Monitor memory usage</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"pryr"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Memory before loading:"</span>, <span class="fu">pryr</span><span class="fu">::</span><span class="fu">mem_used</span><span class="op">(</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>  <span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_data_matrix.html">get_data_matrix</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Memory after loading:"</span>, <span class="fu">pryr</span><span class="fu">::</span><span class="fu">mem_used</span><span class="op">(</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Choose chunk sizes based on available memory and processing
requirements. More chunks mean less memory usage but more overhead.</p>
</div>
</div>
<div class="section level2">
<h2 id="tips-and-best-practices">Tips and Best Practices<a class="anchor" aria-label="anchor" href="#tips-and-best-practices"></a>
</h2>
<p>Here are practical guidelines learned from real-world usage that will
help you avoid common pitfalls and work more effectively.</p>
<div class="section level3">
<h3 id="memory-management">Memory Management<a class="anchor" aria-label="anchor" href="#memory-management"></a>
</h3>
<p><strong>Important</strong>: For file-based datasets exceeding
available RAM, use partial loading by specifying <code>run_id</code> in
<code><a href="../reference/get_data_matrix.html">get_data_matrix()</a></code>. Loading complete datasets should only
occur when all runs are required simultaneously for analysis.</p>
<p>When working with large datasets, memory management becomes
crucial:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Good: Process in chunks</span></span>
<span><span class="va">analyze_large_dataset</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dataset</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">chunks</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/data_chunks.html">data_chunks</a></span><span class="op">(</span><span class="va">dataset</span>, nchunks <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span>  <span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">chunk</span> <span class="kw">in</span> <span class="va">chunks</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Process chunk</span></span>
<span>    <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">your_analysis</span><span class="op">(</span><span class="va">chunk</span><span class="op">$</span><span class="va">data</span><span class="op">)</span></span>
<span>    <span class="va">results</span><span class="op">[[</span><span class="va">chunk</span><span class="op">$</span><span class="va">chunk_num</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">result</span></span>
<span></span>
<span>    <span class="co"># Optionally force garbage collection</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">chunk</span><span class="op">$</span><span class="va">chunk_num</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span> <span class="fl">5</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/gc.html" class="external-link">gc</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">results</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Bad: Loading everything at once for large datasets</span></span>
<span><span class="co"># big_data &lt;- get_data_matrix(very_large_dataset)  # May exhaust memory</span></span></code></pre></div>
<p>Monitor memory usage and adjust chunk sizes based on your system’s
capabilities.</p>
</div>
<div class="section level3">
<h3 id="data-validation">Data Validation<a class="anchor" aria-label="anchor" href="#data-validation"></a>
</h3>
<p><strong>Required Check</strong>: Validate temporal structure using
<code><a href="../reference/get_run_lengths.html">get_run_lengths()</a></code> to ensure alignment with experimental
design. Run length mismatches indicate data organization errors that
will propagate through subsequent analyses.</p>
</div>
<div class="section level3">
<h3 id="chunking-configuration">Chunking Configuration<a class="anchor" aria-label="anchor" href="#chunking-configuration"></a>
</h3>
<p><strong>Run-Boundary Operations</strong>: Configure
<code>data_chunks(dataset, runwise = TRUE)</code> for analyses requiring
run boundary preservation, including: - Temporal detrending - Motion
parameter regression - Run-level normalization - Temporal filtering</p>
</div>
<div class="section level3">
<h3 id="error-prevention">Error Prevention<a class="anchor" aria-label="anchor" href="#error-prevention"></a>
</h3>
<p>Common validation checks that prevent downstream errors:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">validate_dataset</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dataset</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Check temporal consistency</span></span>
<span>  <span class="va">sf</span> <span class="op">&lt;-</span> <span class="va">dataset</span><span class="op">$</span><span class="va">sampling_frame</span></span>
<span>  <span class="va">expected_timepoints</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/n_timepoints.html">n_timepoints</a></span><span class="op">(</span><span class="va">sf</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">dataset</span>, <span class="st">"matrix_dataset"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">actual_timepoints</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">$</span><span class="va">datamat</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">expected_timepoints</span> <span class="op">!=</span> <span class="va">actual_timepoints</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span></span>
<span>        <span class="st">"Temporal structure mismatch: expected "</span>, <span class="va">expected_timepoints</span>,</span>
<span>        <span class="st">" timepoints, found "</span>, <span class="va">actual_timepoints</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Check event table consistency</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">$</span><span class="va">event_table</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">max_run</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">$</span><span class="va">event_table</span><span class="op">$</span><span class="va">run</span><span class="op">)</span></span>
<span>    <span class="va">n_runs_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/n_runs.html">n_runs</a></span><span class="op">(</span><span class="va">sf</span><span class="op">)</span></span>
<span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">max_run</span> <span class="op">&gt;</span> <span class="va">n_runs_data</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span></span>
<span>        <span class="st">"Events reference run "</span>, <span class="va">max_run</span>,</span>
<span>        <span class="st">" but dataset only has "</span>, <span class="va">n_runs_data</span>, <span class="st">" runs"</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="co"># Check event timing</span></span>
<span>    <span class="va">total_duration</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_total_duration.html">get_total_duration</a></span><span class="op">(</span><span class="va">sf</span><span class="op">)</span></span>
<span>    <span class="va">max_event_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">$</span><span class="va">event_table</span><span class="op">$</span><span class="va">onset</span> <span class="op">+</span> <span class="va">dataset</span><span class="op">$</span><span class="va">event_table</span><span class="op">$</span><span class="va">duration</span><span class="op">)</span></span>
<span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">max_event_time</span> <span class="op">&gt;</span> <span class="va">total_duration</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/warning.html" class="external-link">warning</a></span><span class="op">(</span></span>
<span>        <span class="st">"Events extend beyond scan duration ("</span>,</span>
<span>        <span class="va">max_event_time</span>, <span class="st">" &gt; "</span>, <span class="va">total_duration</span>, <span class="st">" seconds)"</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Dataset validation passed\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># validate_dataset(dataset)</span></span></code></pre></div>
<p>Early validation catches problems before they affect your
analysis.</p>
</div>
<div class="section level3">
<h3 id="reproducibility">Reproducibility<a class="anchor" aria-label="anchor" href="#reproducibility"></a>
</h3>
<p>Document dataset creation for reproducible research:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create metadata record</span></span>
<span><span class="va">create_dataset_record</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dataset</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    timestamp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    r_version <span class="op">=</span> <span class="va">R.version.string</span>,</span>
<span>    fmridataset_version <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html" class="external-link">packageVersion</a></span><span class="op">(</span><span class="st">"fmridataset"</span><span class="op">)</span>,</span>
<span>    dataset_class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>    temporal_structure <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      n_runs <span class="op">=</span> <span class="fu"><a href="../reference/n_runs.html">n_runs</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">$</span><span class="va">sampling_frame</span><span class="op">)</span>,</span>
<span>      run_lengths <span class="op">=</span> <span class="fu"><a href="../reference/get_run_lengths.html">get_run_lengths</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">$</span><span class="va">sampling_frame</span><span class="op">)</span>,</span>
<span>      TR <span class="op">=</span> <span class="fu"><a href="../reference/get_TR.html">get_TR</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">$</span><span class="va">sampling_frame</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    spatial_structure <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      n_voxels <span class="op">=</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">inherits</a></span><span class="op">(</span><span class="va">dataset</span>, <span class="st">"matrix_dataset"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">$</span><span class="va">datamat</span><span class="op">)</span></span>
<span>      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>        <span class="st">"unknown"</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">)</span>,</span>
<span>    events <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      n_events <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">$</span><span class="va">event_table</span><span class="op">)</span>,</span>
<span>      event_types <span class="op">=</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">$</span><span class="va">event_table</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">$</span><span class="va">event_table</span><span class="op">$</span><span class="va">trial_type</span><span class="op">)</span></span>
<span>      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Store metadata</span></span>
<span><span class="co"># metadata &lt;- create_dataset_record(dataset)</span></span>
<span><span class="co"># saveRDS(metadata, "analysis_dataset_metadata.rds")</span></span></code></pre></div>
<p>Good metadata practices make your analyses reproducible and help
collaborators understand your data structure.</p>
</div>
</div>
<div class="section level2">
<h2 id="troubleshooting">Troubleshooting<a class="anchor" aria-label="anchor" href="#troubleshooting"></a>
</h2>
<p>When things don’t work as expected, these solutions address the most
common issues encountered in real usage.</p>
<div class="section level3">
<h3 id="common-error-messages">Common Error Messages<a class="anchor" aria-label="anchor" href="#common-error-messages"></a>
</h3>
<dl>
<dt><strong>“Error: Run lengths do not sum to number of
timepoints”</strong></dt>
<dd>
This occurs when the <code>run_length</code> parameter doesn’t match
your actual data dimensions. Check that <code>sum(run_length)</code>
equals the number of timepoints in your data matrix or files.
</dd>
<dt><strong>“Error: Cannot read file: [filename]”</strong></dt>
<dd>
File path issues are common. Use <code><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists()</a></code> to verify
paths and ensure you’re using absolute paths or correct relative paths
from your working directory.
</dd>
<dt><strong>“Warning: Events extend beyond scan duration”</strong></dt>
<dd>
Your event table contains onsets or durations that exceed the total scan
time. Verify event timing and units (seconds vs. TRs).
</dd>
<dt><strong>“Error: Mask dimensions do not match data
dimensions”</strong></dt>
<dd>
The spatial dimensions of your mask don’t match your data. For matrix
datasets, the mask should have one element per column. For file
datasets, mask spatial dimensions must match the data files.
</dd>
</dl>
</div>
<div class="section level3">
<h3 id="performance-issues">Performance Issues<a class="anchor" aria-label="anchor" href="#performance-issues"></a>
</h3>
<p>If dataset operations are slow:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Check file paths</strong>: Network drives or compressed
files can be slow to read</li>
<li>
<strong>Monitor memory</strong>: Use <code><a href="https://rdrr.io/r/base/gc.html" class="external-link">gc()</a></code> and consider
smaller chunk sizes</li>
<li>
<strong>Use run-specific access</strong>: Load only needed runs with
<code>run_id</code> parameter</li>
<li>
<strong>Consider format conversion</strong>: Convert
frequently-accessed file datasets to matrix datasets</li>
</ol>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Benchmark different access patterns</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"microbenchmark"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Compare full vs. partial loading</span></span>
<span>  <span class="va">mb</span> <span class="op">&lt;-</span> <span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu">microbenchmark</span><span class="op">(</span></span>
<span>    full_data <span class="op">=</span> <span class="fu"><a href="../reference/get_data_matrix.html">get_data_matrix</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">)</span>,</span>
<span>    run1_only <span class="op">=</span> <span class="fu"><a href="../reference/get_data_matrix.html">get_data_matrix</a></span><span class="op">(</span><span class="va">dataset</span>, run_id <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>    times <span class="op">=</span> <span class="fl">5</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/print.html">print</a></span><span class="op">(</span><span class="va">mb</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="memory-issues">Memory Issues<a class="anchor" aria-label="anchor" href="#memory-issues"></a>
</h3>
<p>When you encounter memory problems:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Monitor memory usage during operations</span></span>
<span><span class="va">memory_profile</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dataset</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"pryr"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">start_mem</span> <span class="op">&lt;-</span> <span class="fu">pryr</span><span class="fu">::</span><span class="fu">mem_used</span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Starting memory:"</span>, <span class="va">start_mem</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Try loading data</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span></span>
<span>      <span class="op">{</span></span>
<span>        <span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_data_matrix.html">get_data_matrix</a></span><span class="op">(</span><span class="va">dataset</span>, run_id <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>        <span class="va">loaded_mem</span> <span class="op">&lt;-</span> <span class="fu">pryr</span><span class="fu">::</span><span class="fu">mem_used</span><span class="op">(</span><span class="op">)</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"After loading run 1:"</span>, <span class="va">loaded_mem</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Data size:"</span>, <span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/gc.html" class="external-link">gc</a></span><span class="op">(</span><span class="op">)</span></span>
<span>        <span class="va">final_mem</span> <span class="op">&lt;-</span> <span class="fu">pryr</span><span class="fu">::</span><span class="fu">mem_used</span><span class="op">(</span><span class="op">)</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"After cleanup:"</span>, <span class="va">final_mem</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>      <span class="op">}</span>,</span>
<span>      error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Memory error:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">conditionMessage</a></span><span class="op">(</span><span class="va">e</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># memory_profile(dataset)</span></span></code></pre></div>
<p>Use chunking for datasets that exceed available memory, and consider
processing runs separately.</p>
</div>
</div>
<div class="section level2">
<h2 id="integration-with-other-vignettes">Integration with Other Vignettes<a class="anchor" aria-label="anchor" href="#integration-with-other-vignettes"></a>
</h2>
<p>This introduction connects to several other topics in the fmridataset
ecosystem:</p>
<p><strong>Next Steps</strong>: - <a href="architecture-overview.html">Architecture Overview</a> - Understand
the design principles and extensibility model - <a href="study-level-analysis.html">Study-Level Analysis</a> - Scale from
single subjects to multi-subject studies - <a href="h5-backend-usage.html">H5 Backend Usage</a> - Use HDF5 for
efficient storage of large datasets</p>
<p><strong>Advanced Topics</strong>: - <a href="backend-registry.html">Backend Registry</a> - Create custom
backends for new data formats<br>
- <a href="extending-backends.html">Extending Backends</a> - Deep dive
into backend development</p>
<p><strong>Related Packages</strong>: fmridataset integrates seamlessly
with the broader neuroimaging ecosystem: - <strong>neuroim2</strong>:
Use NeuroVec objects directly with memory datasets -
<strong>fmrireg</strong>: Leverage temporal structure for regression
modeling - <strong>DelayedArray</strong>: Advanced array operations with
lazy evaluation</p>
</div>
<div class="section level2">
<h2 id="session-information">Session Information<a class="anchor" aria-label="anchor" href="#session-information"></a>
</h2>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; R version 4.5.2 (2025-10-31)</span></span>
<span><span class="co">#&gt; Platform: x86_64-pc-linux-gnu</span></span>
<span><span class="co">#&gt; Running under: Ubuntu 24.04.3 LTS</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Matrix products: default</span></span>
<span><span class="co">#&gt; BLAS:   /usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3 </span></span>
<span><span class="co">#&gt; LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.26.so;  LAPACK version 3.12.0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; locale:</span></span>
<span><span class="co">#&gt;  [1] LC_CTYPE=C.UTF-8       LC_NUMERIC=C           LC_TIME=C.UTF-8       </span></span>
<span><span class="co">#&gt;  [4] LC_COLLATE=C.UTF-8     LC_MONETARY=C.UTF-8    LC_MESSAGES=C.UTF-8   </span></span>
<span><span class="co">#&gt;  [7] LC_PAPER=C.UTF-8       LC_NAME=C              LC_ADDRESS=C          </span></span>
<span><span class="co">#&gt; [10] LC_TELEPHONE=C         LC_MEASUREMENT=C.UTF-8 LC_IDENTIFICATION=C   </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; time zone: UTC</span></span>
<span><span class="co">#&gt; tzcode source: system (glibc)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; attached base packages:</span></span>
<span><span class="co">#&gt; [1] stats     graphics  grDevices utils     datasets  methods   base     </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; other attached packages:</span></span>
<span><span class="co">#&gt; [1] fmridataset_0.8.9</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; loaded via a namespace (and not attached):</span></span>
<span><span class="co">#&gt;  [1] gtable_0.3.6          xfun_0.56             bslib_0.9.0          </span></span>
<span><span class="co">#&gt;  [4] ggplot2_4.0.1         lattice_0.22-7        bigassertr_0.1.7     </span></span>
<span><span class="co">#&gt;  [7] numDeriv_2016.8-1.1   vctrs_0.7.0           tools_4.5.2          </span></span>
<span><span class="co">#&gt; [10] generics_0.1.4        stats4_4.5.2          parallel_4.5.2       </span></span>
<span><span class="co">#&gt; [13] tibble_3.3.1          pkgconfig_2.0.3       Matrix_1.7-4         </span></span>
<span><span class="co">#&gt; [16] RColorBrewer_1.1-3    bigstatsr_1.6.2       S4Vectors_0.48.0     </span></span>
<span><span class="co">#&gt; [19] S7_0.2.1              desc_1.4.3            RcppParallel_5.1.11-1</span></span>
<span><span class="co">#&gt; [22] assertthat_0.2.1      lifecycle_1.0.5       compiler_4.5.2       </span></span>
<span><span class="co">#&gt; [25] neuroim2_0.8.3        farver_2.1.2          stringr_1.6.0        </span></span>
<span><span class="co">#&gt; [28] textshaping_1.0.4     RNifti_1.9.0          bigparallelr_0.3.2   </span></span>
<span><span class="co">#&gt; [31] codetools_0.2-20      htmltools_0.5.9       sass_0.4.10          </span></span>
<span><span class="co">#&gt; [34] yaml_2.3.12           deflist_0.2.0         pillar_1.11.1        </span></span>
<span><span class="co">#&gt; [37] pkgdown_2.2.0         crayon_1.5.3          jquerylib_0.1.4      </span></span>
<span><span class="co">#&gt; [40] RNiftyReg_2.8.4       cachem_1.1.0          DelayedArray_0.36.0  </span></span>
<span><span class="co">#&gt; [43] dbscan_1.2.4          iterators_1.0.14      abind_1.4-8          </span></span>
<span><span class="co">#&gt; [46] foreach_1.5.2         tidyselect_1.2.1      digest_0.6.39        </span></span>
<span><span class="co">#&gt; [49] stringi_1.8.7         dplyr_1.1.4           purrr_1.2.1          </span></span>
<span><span class="co">#&gt; [52] splines_4.5.2         cowplot_1.2.0         fastmap_1.2.0        </span></span>
<span><span class="co">#&gt; [55] grid_4.5.2            mmap_0.6-23           SparseArray_1.10.8   </span></span>
<span><span class="co">#&gt; [58] cli_3.6.5             magrittr_2.0.4        S4Arrays_1.10.1      </span></span>
<span><span class="co">#&gt; [61] fmrihrf_0.1.0.9000    scales_1.4.0          XVector_0.50.0       </span></span>
<span><span class="co">#&gt; [64] rmarkdown_2.30        matrixStats_1.5.0     rmio_0.4.0           </span></span>
<span><span class="co">#&gt; [67] ragg_1.5.0            memoise_2.0.1         evaluate_1.0.5       </span></span>
<span><span class="co">#&gt; [70] knitr_1.51            IRanges_2.44.0        doParallel_1.0.17    </span></span>
<span><span class="co">#&gt; [73] rlang_1.1.7           Rcpp_1.1.1            glue_1.8.0           </span></span>
<span><span class="co">#&gt; [76] BiocGenerics_0.56.0   jsonlite_2.0.0        R6_2.6.1             </span></span>
<span><span class="co">#&gt; [79] MatrixGenerics_1.22.0 systemfonts_1.3.1     fs_1.6.6             </span></span>
<span><span class="co">#&gt; [82] flock_0.7</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Bradley Buchsbaum.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
