<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Architecture Deep Dive: Design Principles and Extensibility • fmridataset</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Architecture Deep Dive: Design Principles and Extensibility">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">fmridataset</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.8.9</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/architecture-overview.html">Architecture Deep Dive: Design Principles and Extensibility</a></li>
    <li><a class="dropdown-item" href="../articles/backend-development-basics.html">Backend Development Basics: Creating Custom Storage Backends</a></li>
    <li><a class="dropdown-item" href="../articles/backend-registry.html">Backend Registry: Extending Data Format Support</a></li>
    <li><a class="dropdown-item" href="../articles/extending-backends.html">Advanced Backend Development: Storage Extensions</a></li>
    <li><a class="dropdown-item" href="../articles/fmridataset-intro.html">Getting Started with fmridataset</a></li>
    <li><a class="dropdown-item" href="../articles/h5-backend-usage.html">HDF5 Storage: High-Performance Data Management for Large-Scale fMRI Studies</a></li>
    <li><a class="dropdown-item" href="../articles/study-level-analysis.html">Scaling to Study-Level Analysis: From Single Subjects to Group Studies</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/bbuchsbaum/fmridataset/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Architecture Deep Dive: Design Principles and Extensibility</h1>
                        <h4 data-toc-skip class="author">fmridataset
Team</h4>
            
            <h4 data-toc-skip class="date">2026-01-22</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/bbuchsbaum/fmridataset/blob/main/vignettes/architecture-overview.Rmd" class="external-link"><code>vignettes/architecture-overview.Rmd</code></a></small>
      <div class="d-none name"><code>architecture-overview.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="motivation-why-architecture-matters-for-neuroimaging">Motivation: Why Architecture Matters for Neuroimaging<a class="anchor" aria-label="anchor" href="#motivation-why-architecture-matters-for-neuroimaging"></a>
</h2>
</div>
<div class="section level2">
<h2 id="motivation-architectural-design-for-neuroimaging-data">Motivation: Architectural Design for Neuroimaging Data<a class="anchor" aria-label="anchor" href="#motivation-architectural-design-for-neuroimaging-data"></a>
</h2>
<p>Neuroimaging analyses frequently involve data from multiple sources
with different storage formats: NIfTI files, HDF5 archives, preprocessed
matrices, and BIDS-organized datasets. Each format typically requires
format-specific loading code, memory management strategies, and temporal
organization schemes.</p>
<p>The fmridataset architecture addresses these challenges through an
abstraction layer that separates analysis operations from storage
implementations. This design pattern provides:</p>
<ul>
<li>
<strong>Format independence</strong>: Analysis code works uniformly
across all supported formats</li>
<li>
<strong>Memory efficiency</strong>: Backend-specific optimizations
without changing analysis code</li>
<li>
<strong>Extensibility</strong>: New formats can be added without
modifying existing code</li>
<li>
<strong>Performance optimization</strong>: Each backend implements
format-specific optimizations</li>
</ul>
<p>This document describes the architectural principles, design
patterns, and extension mechanisms that enable these capabilities.</p>
</div>
<div class="section level2">
<h2 id="a-real-example-architecture-in-action">A Real Example: Architecture in Action<a class="anchor" aria-label="anchor" href="#a-real-example-architecture-in-action"></a>
</h2>
<p>Let’s see how the architectural principles work in practice by
creating datasets from different sources and demonstrating their unified
behavior:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bbuchsbaum/fmridataset" class="external-link">fmridataset</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Example 1: Matrix backend for in-memory data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">matrix_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1000</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">100</span>, ncol <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="va">matrix_ds</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/matrix_dataset.html">matrix_dataset</a></span><span class="op">(</span></span>
<span>  datamat <span class="op">=</span> <span class="va">matrix_data</span>,</span>
<span>  TR <span class="op">=</span> <span class="fl">2.0</span>,</span>
<span>  run_length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fl">50</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Example 2: File backend for NIfTI data (simulated paths)</span></span>
<span><span class="va">file_paths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"run1.nii.gz"</span>, <span class="st">"run2.nii.gz"</span><span class="op">)</span> <span class="co"># Would be real paths</span></span>
<span><span class="co"># file_ds &lt;- fmri_file_dataset(</span></span>
<span><span class="co">#   scans = file_paths,</span></span>
<span><span class="co">#   mask = "mask.nii.gz",</span></span>
<span><span class="co">#   TR = 2.0,</span></span>
<span><span class="co">#   run_length = c(50, 50)</span></span>
<span><span class="co"># )</span></span>
<span></span>
<span><span class="co"># Example 3: Study backend for multi-subject data</span></span>
<span><span class="va">subject_datasets</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">matrix_ds</span><span class="op">)</span> <span class="co"># In practice, multiple datasets</span></span>
<span><span class="va">study_ds</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fmri_study_dataset.html">fmri_study_dataset</a></span><span class="op">(</span></span>
<span>  datasets <span class="op">=</span> <span class="va">subject_datasets</span>,</span>
<span>  subject_ids <span class="op">=</span> <span class="st">"sub-001"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Demonstrate unified interface</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Matrix dataset class:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">matrix_ds</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Study dataset class:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">study_ds</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Same methods work on all dataset types</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Matrix dataset TR:"</span>, <span class="fu"><a href="../reference/get_TR.html">get_TR</a></span><span class="op">(</span><span class="va">matrix_ds</span><span class="op">)</span>, <span class="st">"seconds\n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Study dataset TR:"</span>, <span class="fu"><a href="../reference/get_TR.html">get_TR</a></span><span class="op">(</span><span class="va">study_ds</span><span class="op">)</span>, <span class="st">"seconds\n"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Same chunking interface</span></span>
<span><span class="va">matrix_chunks</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/data_chunks.html">data_chunks</a></span><span class="op">(</span><span class="va">matrix_ds</span>, nchunks <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="va">study_chunks</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/data_chunks.html">data_chunks</a></span><span class="op">(</span><span class="va">study_ds</span>, nchunks <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Matrix chunks created:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">matrix_chunks</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Study chunks created:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">study_chunks</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span></code></pre></div>
<p><strong>Note</strong>: The unified interface works identically across
different storage mechanisms (in-memory matrices, file-based storage,
multi-subject containers). This abstraction enables code reuse across
diverse data sources.</p>
</div>
<div class="section level2">
<h2 id="understanding-the-architectural-layers">Understanding the Architectural Layers<a class="anchor" aria-label="anchor" href="#understanding-the-architectural-layers"></a>
</h2>
<p>The fmridataset architecture consists of three primary layers that
work together to provide flexibility while maintaining simplicity. Each
layer has distinct responsibilities and clean interfaces that enable
independent evolution and extension.</p>
<div class="section level3">
<h3 id="the-dataset-layer-user-facing-interface">The Dataset Layer: User-Facing Interface<a class="anchor" aria-label="anchor" href="#the-dataset-layer-user-facing-interface"></a>
</h3>
<p>The dataset layer provides the primary interface that users interact
with. This layer defines what operations are possible and ensures
consistent behavior regardless of the underlying data source. When you
call <code><a href="../reference/get_data_matrix.html">get_data_matrix()</a></code> or <code><a href="../reference/n_timepoints.html">n_timepoints()</a></code>,
you’re working with the dataset layer.</p>
<p>This layer implements the “facade” pattern, presenting a simplified
interface that hides the complexity of different storage formats and
temporal organizations. The dataset layer also handles cross-cutting
concerns like event table management, chunking coordination, and
temporal structure validation. By standardizing these operations at the
dataset level, we ensure that all data sources behave consistently for
end users.</p>
<p>The dataset layer is also where format-specific optimizations can be
implemented transparently. For example, matrix datasets can provide
immediate data access, while file datasets can implement sophisticated
caching strategies. Users don’t need to know these implementation
details; they just experience different performance characteristics.</p>
</div>
<div class="section level3">
<h3 id="the-backend-layer-storage-abstraction">The Backend Layer: Storage Abstraction<a class="anchor" aria-label="anchor" href="#the-backend-layer-storage-abstraction"></a>
</h3>
<p>Below the dataset layer lies the backend layer, which handles all
storage-specific operations. This layer implements the “strategy”
pattern, where different backends provide alternative implementations
for the same set of operations. Each backend knows how to efficiently
read its specific data format while presenting a uniform interface to
the dataset layer.</p>
<p>Backends are responsible for resource management, including opening
and closing files, managing memory allocations, and handling
format-specific error conditions. They also provide metadata extraction
capabilities, enabling datasets to query dimensions, spatial
information, and acquisition parameters without loading actual data.</p>
<p>The backend contract is carefully designed to support both eager and
lazy loading strategies. Backends can choose to load data immediately
for fast access or defer loading until explicitly requested for memory
efficiency. This flexibility enables optimal performance across
different usage patterns and dataset sizes.</p>
</div>
<div class="section level3">
<h3 id="the-temporal-layer-time-structure-modeling">The Temporal Layer: Time Structure Modeling<a class="anchor" aria-label="anchor" href="#the-temporal-layer-time-structure-modeling"></a>
</h3>
<p>The temporal layer captures the rich time structure of fMRI data
through the sampling frame abstraction. Unlike simple time series, fMRI
data has complex temporal organization with multiple runs, variable run
lengths, and specific timing relationships that must be preserved for
proper analysis.</p>
<p>Sampling frames provide a unified model for temporal structure that
works across all dataset types. They handle conversions between
different time representations (seconds, TRs, sample indices), maintain
run boundary information, and enable sophisticated temporal queries.
This abstraction allows the same temporal analysis code to work whether
your data comes from a single long session or multiple shorter runs.</p>
<p>The temporal layer also integrates with experimental design through
event table management. By understanding both acquisition timing and
experimental events, the system can provide sophisticated event-related
analysis capabilities while maintaining temporal integrity across
different data sources.</p>
</div>
</div>
<div class="section level2">
<h2 id="deep-dive-core-design-patterns">Deep Dive: Core Design Patterns<a class="anchor" aria-label="anchor" href="#deep-dive-core-design-patterns"></a>
</h2>
<p>The architecture leverages several key design patterns that provide
flexibility and maintainability. Understanding these patterns helps you
use the package more effectively and provides a foundation for
extensions.</p>
<div class="section level3">
<h3 id="delegation-pattern-distributed-responsibility">Delegation Pattern: Distributed Responsibility<a class="anchor" aria-label="anchor" href="#delegation-pattern-distributed-responsibility"></a>
</h3>
<p>The delegation pattern is central to how fmridataset manages
complexity. Rather than implementing all functionality in monolithic
classes, the architecture delegates specific responsibilities to
specialized components:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Datasets delegate temporal queries to sampling frames</span></span>
<span><span class="va">sf</span> <span class="op">&lt;-</span> <span class="va">matrix_ds</span><span class="op">$</span><span class="va">sampling_frame</span></span>
<span><span class="va">direct_tr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_TR.html">get_TR</a></span><span class="op">(</span><span class="va">sf</span><span class="op">)</span></span>
<span><span class="va">delegated_tr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_TR.html">get_TR</a></span><span class="op">(</span><span class="va">matrix_ds</span><span class="op">)</span> <span class="co"># Delegates to sampling frame</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Direct TR query:"</span>, <span class="va">direct_tr</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Delegated TR query:"</span>, <span class="va">delegated_tr</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Datasets delegate storage operations to backends</span></span>
<span><span class="va">backend</span> <span class="op">&lt;-</span> <span class="va">matrix_ds</span><span class="op">$</span><span class="va">backend</span></span>
<span><span class="va">backend_dims</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/backend_get_dims.html">backend_get_dims</a></span><span class="op">(</span><span class="va">backend</span><span class="op">)</span></span>
<span><span class="va">dataset_dims</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_data_matrix.html">get_data_matrix</a></span><span class="op">(</span><span class="va">matrix_ds</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Backend reports dimensions:"</span>, <span class="va">backend_dims</span><span class="op">$</span><span class="va">time</span>, <span class="st">"x"</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">backend_dims</span><span class="op">$</span><span class="va">spatial</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Dataset provides dimensions:"</span>, <span class="va">dataset_dims</span>, <span class="st">"\n"</span><span class="op">)</span></span></code></pre></div>
<p>This delegation enables clean separation of concerns and makes the
system more modular. Each component can evolve independently as long as
it maintains its interface contract.</p>
</div>
<div class="section level3">
<h3 id="factory-pattern-automatic-backend-selection">Factory Pattern: Automatic Backend Selection<a class="anchor" aria-label="anchor" href="#factory-pattern-automatic-backend-selection"></a>
</h3>
<p>The factory pattern enables automatic selection of appropriate
backends based on input types. Users don’t need to explicitly choose
backends; the system selects the optimal one based on data
characteristics:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Matrix input automatically creates matrix backend</span></span>
<span><span class="va">matrix_input</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">500</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">50</span>, ncol <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">auto_dataset1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fmri_dataset.html">fmri_dataset</a></span><span class="op">(</span>scans <span class="op">=</span> <span class="va">matrix_input</span>, TR <span class="op">=</span> <span class="fl">2.0</span>, run_length <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Matrix input created:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">auto_dataset1</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># File paths would automatically create file backend</span></span>
<span><span class="co"># file_input &lt;- c("scan1.nii", "scan2.nii")</span></span>
<span><span class="co"># auto_dataset2 &lt;- fmri_dataset(scans = file_input, TR = 2.0, run_length = c(100, 100))</span></span>
<span><span class="co"># cat("File input created:", class(auto_dataset2)[1], "\n")</span></span>
<span></span>
<span><span class="co"># The factory hides complexity while providing optimal performance</span></span></code></pre></div>
<p>This automatic selection reduces cognitive load for users while
ensuring optimal performance for each data type.</p>
</div>
<div class="section level3">
<h3 id="observer-pattern-event-integration">Observer Pattern: Event Integration<a class="anchor" aria-label="anchor" href="#observer-pattern-event-integration"></a>
</h3>
<p>The observer pattern enables loose coupling between temporal
structure and experimental events. Event tables can be updated
independently while maintaining consistency with the underlying temporal
organization:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create dataset with temporal structure</span></span>
<span><span class="va">ds</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/matrix_dataset.html">matrix_dataset</a></span><span class="op">(</span></span>
<span>  datamat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">800</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">80</span>, ncol <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>  TR <span class="op">=</span> <span class="fl">2.0</span>,</span>
<span>  run_length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">40</span>, <span class="fl">40</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add events that automatically align with temporal structure</span></span>
<span><span class="va">events</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  onset <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">30</span>, <span class="fl">90</span>, <span class="fl">110</span><span class="op">)</span>, <span class="co"># seconds</span></span>
<span>  duration <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>  trial_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"A"</span>, <span class="st">"B"</span><span class="op">)</span>,</span>
<span>  run <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">ds</span><span class="op">$</span><span class="va">event_table</span> <span class="op">&lt;-</span> <span class="va">events</span></span>
<span></span>
<span><span class="co"># Events automatically validate against temporal structure</span></span>
<span><span class="va">sf</span> <span class="op">&lt;-</span> <span class="va">ds</span><span class="op">$</span><span class="va">sampling_frame</span></span>
<span><span class="va">total_duration</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_total_duration.html">get_total_duration</a></span><span class="op">(</span><span class="va">sf</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Total scan duration:"</span>, <span class="va">total_duration</span>, <span class="st">"seconds\n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Last event ends at:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">events</span><span class="op">$</span><span class="va">onset</span> <span class="op">+</span> <span class="va">events</span><span class="op">$</span><span class="va">duration</span><span class="op">)</span>, <span class="st">"seconds\n"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># System can detect temporal inconsistencies</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">events</span><span class="op">$</span><span class="va">onset</span> <span class="op">+</span> <span class="va">events</span><span class="op">$</span><span class="va">duration</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">total_duration</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/warning.html" class="external-link">warning</a></span><span class="op">(</span><span class="st">"Events extend beyond scan duration"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>This pattern ensures that experimental design information remains
consistent with acquisition timing across different operations.</p>
</div>
<div class="section level3">
<h3 id="strategy-pattern-flexible-chunking">Strategy Pattern: Flexible Chunking<a class="anchor" aria-label="anchor" href="#strategy-pattern-flexible-chunking"></a>
</h3>
<p>The strategy pattern enables different chunking strategies based on
analysis requirements. The same interface supports multiple approaches
to data subdivision:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Strategy 1: Voxel-based chunking (default)</span></span>
<span><span class="va">voxel_chunks</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/data_chunks.html">data_chunks</a></span><span class="op">(</span><span class="va">matrix_ds</span>, nchunks <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Voxel chunking: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">voxel_chunks</span><span class="op">)</span>, <span class="st">"chunks\n"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Strategy 2: Run-based chunking</span></span>
<span><span class="va">run_chunks</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/data_chunks.html">data_chunks</a></span><span class="op">(</span><span class="va">matrix_ds</span>, runwise <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Run chunking: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">run_chunks</span><span class="op">)</span>, <span class="st">"chunks\n"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Strategy 3: Single chunk (no subdivision)</span></span>
<span><span class="va">single_chunk</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/data_chunks.html">data_chunks</a></span><span class="op">(</span><span class="va">matrix_ds</span>, nchunks <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Single chunking: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">single_chunk</span><span class="op">)</span>, <span class="st">"chunks\n"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Each strategy optimizes for different use cases</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">voxel_chunks</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">chunk</span> <span class="op">&lt;-</span> <span class="va">voxel_chunks</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Voxel chunk"</span>, <span class="va">i</span>, <span class="st">":"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">chunk</span><span class="op">$</span><span class="va">data</span><span class="op">)</span>, <span class="st">"voxels\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">run_chunks</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">chunk</span> <span class="op">&lt;-</span> <span class="va">run_chunks</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Run chunk"</span>, <span class="va">i</span>, <span class="st">":"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">chunk</span><span class="op">$</span><span class="va">data</span><span class="op">)</span>, <span class="st">"timepoints\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Different strategies optimize for different analysis patterns while
maintaining the same programming interface.</p>
</div>
</div>
<div class="section level2">
<h2 id="extension-points-customizing-the-architecture">Extension Points: Customizing the Architecture<a class="anchor" aria-label="anchor" href="#extension-points-customizing-the-architecture"></a>
</h2>
<p>The architecture provides several well-defined extension points that
allow you to customize behavior or add new capabilities without
modifying core code.</p>
<div class="section level3">
<h3 id="custom-dataset-types">Custom Dataset Types<a class="anchor" aria-label="anchor" href="#custom-dataset-types"></a>
</h3>
<p>Creating new dataset types allows you to support specialized data
sources or add domain-specific functionality:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Example: Create a dataset type for ROI (Region of Interest) time series</span></span>
<span><span class="va">roi_dataset</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">roi_timeseries</span>, <span class="va">roi_labels</span>, <span class="va">roi_coordinates</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">TR</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Validate inputs</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">is.matrix</a></span><span class="op">(</span><span class="va">roi_timeseries</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"roi_timeseries must be a matrix"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">roi_timeseries</span><span class="op">)</span> <span class="op">!=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">roi_labels</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"Number of ROIs must match label length"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Create underlying matrix dataset with actual time series data</span></span>
<span>  <span class="va">base_dataset</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/matrix_dataset.html">matrix_dataset</a></span><span class="op">(</span></span>
<span>    datamat <span class="op">=</span> <span class="va">roi_timeseries</span>, <span class="co"># timepoints × regions matrix</span></span>
<span>    TR <span class="op">=</span> <span class="va">TR</span>,</span>
<span>    <span class="va">...</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Add ROI-specific metadata</span></span>
<span>  <span class="va">base_dataset</span><span class="op">$</span><span class="va">roi_labels</span> <span class="op">&lt;-</span> <span class="va">roi_labels</span></span>
<span>  <span class="va">base_dataset</span><span class="op">$</span><span class="va">roi_coordinates</span> <span class="op">&lt;-</span> <span class="va">roi_coordinates</span></span>
<span>  <span class="va">base_dataset</span><span class="op">$</span><span class="va">data_type</span> <span class="op">&lt;-</span> <span class="st">"roi_timeseries"</span></span>
<span></span>
<span>  <span class="co"># Set class for method dispatch</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">base_dataset</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"roi_dataset"</span>, <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">base_dataset</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">base_dataset</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Create ROI-specific methods</span></span>
<span><span class="va">get_roi_labels</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dataset</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/UseMethod.html" class="external-link">UseMethod</a></span><span class="op">(</span><span class="st">"get_roi_labels"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">get_roi_labels.roi_dataset</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dataset</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">dataset</span><span class="op">$</span><span class="va">roi_labels</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">get_roi_coordinates</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dataset</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/UseMethod.html" class="external-link">UseMethod</a></span><span class="op">(</span><span class="st">"get_roi_coordinates"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">get_roi_coordinates.roi_dataset</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dataset</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">dataset</span><span class="op">$</span><span class="va">roi_coordinates</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Usage: Create ROI time series data (100 timepoints × 8 brain regions)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span><span class="va">roi_timeseries</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">800</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">100</span>, ncol <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span>
<span><span class="va">roi_coords</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="op">-</span><span class="fl">45</span>, <span class="op">-</span><span class="fl">65</span>, <span class="fl">30</span>, <span class="co"># Left angular gyrus</span></span>
<span>  <span class="fl">45</span>, <span class="op">-</span><span class="fl">65</span>, <span class="fl">30</span>, <span class="co"># Right angular gyrus</span></span>
<span>  <span class="op">-</span><span class="fl">40</span>, <span class="op">-</span><span class="fl">85</span>, <span class="fl">15</span>, <span class="co"># Left middle occipital</span></span>
<span>  <span class="fl">40</span>, <span class="op">-</span><span class="fl">85</span>, <span class="fl">15</span>, <span class="co"># Right middle occipital</span></span>
<span>  <span class="op">-</span><span class="fl">50</span>, <span class="op">-</span><span class="fl">25</span>, <span class="fl">45</span>, <span class="co"># Left supramarginal</span></span>
<span>  <span class="fl">50</span>, <span class="op">-</span><span class="fl">25</span>, <span class="fl">45</span>, <span class="co"># Right supramarginal</span></span>
<span>  <span class="fl">0</span>, <span class="fl">10</span>, <span class="fl">50</span>, <span class="co"># Medial frontal</span></span>
<span>  <span class="fl">0</span>, <span class="op">-</span><span class="fl">50</span>, <span class="fl">25</span> <span class="co"># Posterior cingulate</span></span>
<span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">8</span>, ncol <span class="op">=</span> <span class="fl">3</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">roi_ds</span> <span class="op">&lt;-</span> <span class="fu">roi_dataset</span><span class="op">(</span></span>
<span>  roi_timeseries <span class="op">=</span> <span class="va">roi_timeseries</span>,</span>
<span>  roi_labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"L_Angular"</span>, <span class="st">"R_Angular"</span>, <span class="st">"L_MOG"</span>, <span class="st">"R_MOG"</span>,</span>
<span>    <span class="st">"L_Supramarginal"</span>, <span class="st">"R_Supramarginal"</span>, <span class="st">"Med_Frontal"</span>, <span class="st">"PCC"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  roi_coordinates <span class="op">=</span> <span class="va">roi_coords</span>,</span>
<span>  TR <span class="op">=</span> <span class="fl">2.0</span>,</span>
<span>  run_length <span class="op">=</span> <span class="fl">100</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Created ROI dataset with"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu">get_roi_labels</span><span class="op">(</span><span class="va">roi_ds</span><span class="op">)</span><span class="op">)</span>, <span class="st">"regions\n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"First ROI:"</span>, <span class="fu">get_roi_labels</span><span class="op">(</span><span class="va">roi_ds</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">"at coordinates"</span>, <span class="fu">get_roi_coordinates</span><span class="op">(</span><span class="va">roi_ds</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span>, <span class="st">"\n"</span><span class="op">)</span></span></code></pre></div>
<p>Custom dataset types inherit all standard functionality while adding
specialized capabilities.</p>
</div>
<div class="section level3">
<h3 id="custom-backend-implementation">Custom Backend Implementation<a class="anchor" aria-label="anchor" href="#custom-backend-implementation"></a>
</h3>
<p>New backends enable support for additional data formats or storage
systems:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Example: Simple CSV backend implementation</span></span>
<span><span class="va">csv_backend</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">csv_file</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Validate file exists</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">csv_file</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"CSV file not found: "</span>, <span class="va">csv_file</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Create backend object</span></span>
<span>  <span class="va">backend</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    csv_file <span class="op">=</span> <span class="va">csv_file</span>,</span>
<span>    data_cache <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    is_open <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">backend</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"csv_backend"</span>, <span class="st">"storage_backend"</span><span class="op">)</span></span>
<span>  <span class="va">backend</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Implement required backend methods</span></span>
<span><span class="va">backend_open.csv_backend</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">backend</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">backend</span><span class="op">$</span><span class="va">is_open</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Load data when opened</span></span>
<span>    <span class="va">backend</span><span class="op">$</span><span class="va">data_cache</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="va">backend</span><span class="op">$</span><span class="va">csv_file</span>, header <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">backend</span><span class="op">$</span><span class="va">is_open</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">backend</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">backend_close.csv_backend</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">backend</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">backend</span><span class="op">$</span><span class="va">data_cache</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>  <span class="va">backend</span><span class="op">$</span><span class="va">is_open</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">backend_get_dims.csv_backend</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">backend</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">backend</span><span class="op">$</span><span class="va">is_open</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"Backend must be opened before querying dimensions"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    spatial <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">backend</span><span class="op">$</span><span class="va">data_cache</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>    time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">backend</span><span class="op">$</span><span class="va">data_cache</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">backend_get_data.csv_backend</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">backend</span>, <span class="va">rows</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">cols</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">backend</span><span class="op">$</span><span class="va">is_open</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"Backend must be opened before accessing data"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">data</span> <span class="op">&lt;-</span> <span class="va">backend</span><span class="op">$</span><span class="va">data_cache</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">rows</span><span class="op">)</span><span class="op">)</span> <span class="va">data</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="va">rows</span>, , drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">cols</span><span class="op">)</span><span class="op">)</span> <span class="va">data</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span>, <span class="va">cols</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span></span>
<span></span>
<span>  <span class="va">data</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>This backend could then be registered and used throughout the
fmridataset ecosystem.</p>
</div>
<div class="section level3">
<h3 id="custom-temporal-abstractions">Custom Temporal Abstractions<a class="anchor" aria-label="anchor" href="#custom-temporal-abstractions"></a>
</h3>
<p>The sampling frame system can be extended to support specialized
temporal organizations:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Example: Variable TR sampling frame for multi-echo data</span></span>
<span><span class="va">variable_tr_sampling_frame</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">tr_sequence</span>, <span class="va">run_boundaries</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Validate inputs</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">tr_sequence</span><span class="op">)</span> <span class="op">!=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">run_boundaries</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"TR sequence length must match total timepoints"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Create base sampling frame</span></span>
<span>  <span class="va">base_sf</span> <span class="op">&lt;-</span> <span class="fu">sampling_frame</span><span class="op">(</span></span>
<span>    run_lengths <span class="op">=</span> <span class="va">run_boundaries</span>,</span>
<span>    TR <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">tr_sequence</span><span class="op">)</span>, <span class="co"># Use mean TR for compatibility</span></span>
<span>    <span class="va">...</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Add variable TR information</span></span>
<span>  <span class="va">base_sf</span><span class="op">$</span><span class="va">tr_sequence</span> <span class="op">&lt;-</span> <span class="va">tr_sequence</span></span>
<span>  <span class="va">base_sf</span><span class="op">$</span><span class="va">run_boundaries</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">run_boundaries</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">base_sf</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"variable_tr_sampling_frame"</span>, <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">base_sf</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">base_sf</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Add specialized methods</span></span>
<span><span class="va">get_tr_at_timepoint</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sf</span>, <span class="va">timepoint</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/UseMethod.html" class="external-link">UseMethod</a></span><span class="op">(</span><span class="st">"get_tr_at_timepoint"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">get_tr_at_timepoint.variable_tr_sampling_frame</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sf</span>, <span class="va">timepoint</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">timepoint</span> <span class="op">&lt;</span> <span class="fl">1</span> <span class="op">||</span> <span class="va">timepoint</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sf</span><span class="op">$</span><span class="va">tr_sequence</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"Timepoint out of range"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">sf</span><span class="op">$</span><span class="va">tr_sequence</span><span class="op">[</span><span class="va">timepoint</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Example usage</span></span>
<span><span class="va">tr_seq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2.0</span>, <span class="fl">2.5</span>, <span class="fl">1.5</span><span class="op">)</span>, times <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">20</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span> <span class="co"># Variable TRs</span></span>
<span><span class="va">var_sf</span> <span class="op">&lt;-</span> <span class="fu">variable_tr_sampling_frame</span><span class="op">(</span></span>
<span>  tr_sequence <span class="op">=</span> <span class="va">tr_seq</span>,</span>
<span>  run_boundaries <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">30</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"TR at timepoint 10:"</span>, <span class="fu">get_tr_at_timepoint</span><span class="op">(</span><span class="va">var_sf</span>, <span class="fl">10</span><span class="op">)</span>, <span class="st">"seconds\n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"TR at timepoint 25:"</span>, <span class="fu">get_tr_at_timepoint</span><span class="op">(</span><span class="va">var_sf</span>, <span class="fl">25</span><span class="op">)</span>, <span class="st">"seconds\n"</span><span class="op">)</span></span></code></pre></div>
<p>Custom temporal abstractions enable support for specialized
acquisition protocols.</p>
</div>
</div>
<div class="section level2">
<h2 id="advanced-topics">Advanced Topics<a class="anchor" aria-label="anchor" href="#advanced-topics"></a>
</h2>
<p>Once you understand the basic architectural patterns, these advanced
concepts help you leverage the full power of the system and optimize for
complex use cases.</p>
<div class="section level3">
<h3 id="performance-architecture">Performance Architecture<a class="anchor" aria-label="anchor" href="#performance-architecture"></a>
</h3>
<p>The architecture is designed with performance as a primary
consideration. Understanding the performance implications of different
architectural choices helps you optimize your analyses:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Benchmark different backend types</span></span>
<span><span class="va">benchmark_backends</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n_timepoints</span> <span class="op">=</span> <span class="fl">100</span>, <span class="va">n_voxels</span> <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Generate test data</span></span>
<span>  <span class="va">test_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_example_fmri_data.html">generate_example_fmri_data</a></span><span class="op">(</span><span class="va">n_timepoints</span>, <span class="va">n_voxels</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Benchmark matrix backend</span></span>
<span>  <span class="va">start_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">matrix_ds</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/matrix_dataset.html">matrix_dataset</a></span><span class="op">(</span></span>
<span>    datamat <span class="op">=</span> <span class="va">test_data</span>,</span>
<span>    TR <span class="op">=</span> <span class="fl">2.0</span>,</span>
<span>    run_length <span class="op">=</span> <span class="va">n_timepoints</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">matrix_create_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/difftime.html" class="external-link">difftime</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">start_time</span>, units <span class="op">=</span> <span class="st">"secs"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">start_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">matrix_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_data_matrix.html">get_data_matrix</a></span><span class="op">(</span><span class="va">matrix_ds</span><span class="op">)</span></span>
<span>  <span class="va">matrix_access_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/difftime.html" class="external-link">difftime</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">start_time</span>, units <span class="op">=</span> <span class="st">"secs"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Performance Comparison:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"====================\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Dataset size: %d timepoints × %d voxels\n"</span>, <span class="va">n_timepoints</span>, <span class="va">n_voxels</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Memory size: %.1f MB\n\n"</span>, <span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">test_data</span><span class="op">)</span> <span class="op">/</span> <span class="fl">1024</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Matrix Backend:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  Creation time: %.3f seconds\n"</span>, <span class="va">matrix_create_time</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"  Data access time: %.3f seconds\n"</span>, <span class="va">matrix_access_time</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Memory model: All data in RAM\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Best for: Small datasets, repeated access\n\n"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Simulate file backend performance</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"File Backend (simulated):\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Creation time: ~0.001 seconds (lazy)\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  First access time: ~1-5 seconds (disk I/O)\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Memory model: Load on demand\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Best for: Large datasets, sequential access\n\n"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Simulate study backend performance</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Study Backend (simulated):\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Creation time: ~0.01 seconds (metadata only)\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Access time: Varies by subject\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Memory model: Per-subject lazy loading\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Best for: Multi-subject analyses\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Run benchmark</span></span>
<span><span class="fu">benchmark_backends</span><span class="op">(</span>n_timepoints <span class="op">=</span> <span class="fl">200</span>, n_voxels <span class="op">=</span> <span class="fl">5000</span><span class="op">)</span></span></code></pre></div>
<p>The performance characteristics guide backend selection based on your
specific use case.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Benchmark chunking strategies</span></span>
<span><span class="va">benchmark_chunking</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dataset</span>, <span class="va">chunk_sizes</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">5</span>, <span class="fl">10</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nChunking Performance Analysis:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"============================\n"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    chunks <span class="op">=</span> <span class="va">chunk_sizes</span>,</span>
<span>    time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">chunk_sizes</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    memory_peak <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">chunk_sizes</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">chunk_sizes</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">n_chunks</span> <span class="op">&lt;-</span> <span class="va">chunk_sizes</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span></span>
<span>    <span class="va">start_time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">chunks</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/data_chunks.html">data_chunks</a></span><span class="op">(</span><span class="va">dataset</span>, nchunks <span class="op">=</span> <span class="va">n_chunks</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Simulate processing</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">chunk</span> <span class="kw">in</span> <span class="va">chunks</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># Simple operation on each chunk</span></span>
<span>      <span class="va">chunk_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">chunk</span><span class="op">$</span><span class="va">data</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="va">results</span><span class="op">$</span><span class="va">time</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/difftime.html" class="external-link">difftime</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">start_time</span>, units <span class="op">=</span> <span class="st">"secs"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">results</span><span class="op">$</span><span class="va">memory_peak</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/n_timepoints.html">n_timepoints</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">$</span><span class="va">datamat</span><span class="op">)</span> <span class="op">/</span> <span class="va">n_chunks</span> <span class="op">*</span> <span class="fl">8</span> <span class="op">/</span> <span class="fl">1024</span><span class="op">^</span><span class="fl">2</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="fu"><a href="../reference/print.html">print</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nRecommendations:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"- More chunks = Lower memory usage\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"- Fewer chunks = Better performance (less overhead)\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"- Optimal chunk size depends on available RAM\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Create test dataset and benchmark</span></span>
<span><span class="va">test_ds</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/matrix_dataset.html">matrix_dataset</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/generate_example_fmri_data.html">generate_example_fmri_data</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">1000</span><span class="op">)</span>,</span>
<span>  TR <span class="op">=</span> <span class="fl">2.0</span>,</span>
<span>  run_length <span class="op">=</span> <span class="fl">100</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">benchmark_chunking</span><span class="op">(</span><span class="va">test_ds</span><span class="op">)</span></span></code></pre></div>
<p>The lazy evaluation architecture enables working with datasets larger
than memory by deferring expensive operations until absolutely
necessary.</p>
</div>
<div class="section level3">
<h3 id="memory-management-architecture">Memory Management Architecture<a class="anchor" aria-label="anchor" href="#memory-management-architecture"></a>
</h3>
<p>The architecture provides sophisticated memory management through
backend-specific strategies:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Memory usage patterns for different backends</span></span>
<span><span class="va">analyze_memory_patterns</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Matrix backend: immediate memory allocation</span></span>
<span>  <span class="va">matrix_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">10000</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">100</span>, ncol <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span>  <span class="va">matrix_size</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">matrix_data</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Matrix backend:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Data size:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">matrix_size</span>, units <span class="op">=</span> <span class="st">"Mb"</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Memory allocation: immediate\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Access pattern: O(1) random access\n\n"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># File backend simulation</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"File backend:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Data size: 0 bytes (until accessed)\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Memory allocation: on-demand\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Access pattern: O(n) sequential preferred\n\n"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Study backend simulation</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Study backend:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Data size: per-subject allocation\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Memory allocation: lazy per subject\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  Access pattern: optimized for chunking\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">analyze_memory_patterns</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Different backends implement different memory strategies optimized
for their use cases.</p>
</div>
<div class="section level3">
<h3 id="extensibility-architecture">Extensibility Architecture<a class="anchor" aria-label="anchor" href="#extensibility-architecture"></a>
</h3>
<p>The architecture’s extensibility comes from its layered design and
well-defined interfaces:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Demonstrate interface consistency across extensions</span></span>
<span><span class="va">demonstrate_interface_consistency</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># All datasets implement the same core interface</span></span>
<span>  <span class="va">core_methods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"get_data_matrix"</span>, <span class="st">"get_TR"</span>, <span class="st">"n_runs"</span>, <span class="st">"n_timepoints"</span>, <span class="st">"data_chunks"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Core interface methods:\n"</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">method</span> <span class="kw">in</span> <span class="va">core_methods</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  -"</span>, <span class="va">method</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nInterface guarantees:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  - Same method signatures across all dataset types\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  - Consistent return value formats\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  - Predictable error handling\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  - Backward compatibility preservation\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">demonstrate_interface_consistency</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extensions can add new methods without breaking existing code</span></span>
<span><span class="va">add_custom_methods</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nExtension pattern:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  1. Inherit from base classes\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  2. Implement required interface methods\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  3. Add specialized functionality\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  4. Register with appropriate systems\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">add_custom_methods</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>This extensibility architecture enables the ecosystem to grow while
maintaining stability.</p>
</div>
</div>
<div class="section level2">
<h2 id="tips-and-best-practices">Tips and Best Practices<a class="anchor" aria-label="anchor" href="#tips-and-best-practices"></a>
</h2>
<p>Here are architectural insights that will help you use fmridataset
more effectively and build robust extensions.</p>
<div class="section level3">
<h3 id="performance-considerations">Performance Considerations<a class="anchor" aria-label="anchor" href="#performance-considerations"></a>
</h3>
<p><strong>Backend Selection Guidelines</strong>: - <strong>Matrix
backends</strong>: Suitable for datasets under 8GB with frequent random
access patterns - <strong>File backends</strong>: Optimal for large
datasets (&gt;8GB) with sequential access patterns - <strong>Study
backends</strong>: Required for multi-subject analyses with
subject-level lazy loading</p>
</div>
<div class="section level3">
<h3 id="implementation-requirements">Implementation Requirements<a class="anchor" aria-label="anchor" href="#implementation-requirements"></a>
</h3>
<p><strong>Backend Interface Compliance</strong>: Custom backends must
implement all six required methods of the backend contract. Partial
implementations will cause failures in chunking operations, study-level
analyses, and other advanced features that depend on the complete
interface.</p>
</div>
<div class="section level3">
<h3 id="extension-patterns">Extension Patterns<a class="anchor" aria-label="anchor" href="#extension-patterns"></a>
</h3>
<p><strong>Delegation Strategy</strong>: When extending functionality,
delegate to existing components rather than reimplementing core
features. This approach maintains consistency, reduces code duplication,
and ensures compatibility with future updates.</p>
</div>
<div class="section level3">
<h3 id="architectural-decision-guidelines">Architectural Decision Guidelines<a class="anchor" aria-label="anchor" href="#architectural-decision-guidelines"></a>
</h3>
<p>When designing extensions or choosing between implementation
approaches:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Decision framework for extensions</span></span>
<span><span class="va">evaluate_extension_approach</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">requirement</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Extension decision framework:\n\n"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"1. Data source extension:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"   - New file format? → Custom backend\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"   - New data organization? → Custom dataset\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"   - New temporal structure? → Custom sampling frame\n\n"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"2. Analysis extension:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"   - New processing pattern? → Custom chunking strategy\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"   - New metadata needs? → Dataset subclass\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"   - New access pattern? → Custom methods\n\n"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"3. Performance extension:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"   - Memory optimization? → Backend specialization\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"   - I/O optimization? → Custom caching\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"   - Parallel processing? → Chunking extensions\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">evaluate_extension_approach</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="interface-design-principles">Interface Design Principles<a class="anchor" aria-label="anchor" href="#interface-design-principles"></a>
</h3>
<p>When extending the architecture, follow these interface design
principles:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">demonstrate_interface_principles</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Interface design principles:\n\n"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"1. Consistency:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"   - Same method names across similar components\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"   - Predictable parameter patterns\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"   - Uniform error handling\n\n"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"2. Composability:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"   - Components work together seamlessly\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"   - Clear separation of concerns\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"   - Minimal coupling between layers\n\n"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"3. Extensibility:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"   - Well-defined extension points\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"   - Backward compatibility guarantees\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"   - Future-proof interface design\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">demonstrate_interface_principles</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>These principles ensure that extensions integrate smoothly with the
existing ecosystem.</p>
</div>
</div>
<div class="section level2">
<h2 id="troubleshooting-architecture-issues">Troubleshooting Architecture Issues<a class="anchor" aria-label="anchor" href="#troubleshooting-architecture-issues"></a>
</h2>
<p>Understanding the architecture helps diagnose and resolve complex
issues that span multiple components.</p>
<div class="section level3">
<h3 id="layer-specific-debugging">Layer-Specific Debugging<a class="anchor" aria-label="anchor" href="#layer-specific-debugging"></a>
</h3>
<p>Different types of issues typically originate in specific
architectural layers:</p>
<dl>
<dt><strong>Dataset Layer Issues</strong></dt>
<dd>
Method dispatch problems, interface inconsistencies, temporal validation
errors
</dd>
<dt><strong>Backend Layer Issues</strong></dt>
<dd>
File I/O problems, memory allocation failures, format-specific errors
</dd>
<dt><strong>Temporal Layer Issues</strong></dt>
<dd>
Run boundary mismatches, timing calculation errors, event alignment
problems
</dd>
</dl>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Debugging strategy by architectural layer</span></span>
<span><span class="va">debug_by_layer</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">error_type</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Debugging strategy by layer:\n\n"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Dataset layer debugging:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  - Check class hierarchy: class(dataset)\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  - Verify method dispatch: methods(class = class(dataset)[1])\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  - Validate temporal structure: dataset$sampling_frame\n\n"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Backend layer debugging:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  - Check backend status: dataset$backend\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  - Test direct backend calls: backend_get_dims(backend)\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  - Verify resource state: backend state variables\n\n"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Temporal layer debugging:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  - Check sampling frame: get_run_lengths(dataset)\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  - Verify timing: get_TR(dataset) * n_timepoints(dataset)\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  - Test event alignment: validate event onsets\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">debug_by_layer</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="performance-troubleshooting">Performance Troubleshooting<a class="anchor" aria-label="anchor" href="#performance-troubleshooting"></a>
</h3>
<p>Architecture-aware performance debugging:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">diagnose_performance_issues</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Performance diagnosis by component:\n\n"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Slow data access:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  - Backend type: file vs. matrix vs. study\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  - Chunking strategy: voxel vs. run vs. custom\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  - Memory pressure: check available RAM\n\n"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"High memory usage:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  - Lazy loading: ensure file backends stay lazy\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  - Chunk sizing: reduce chunk size for large datasets\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  - Garbage collection: explicit gc() calls\n\n"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Interface inconsistencies:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  - Method dispatch: verify S3 method registration\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  - Class hierarchy: check inheritance patterns\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  - Extension conflicts: check for method overrides\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">diagnose_performance_issues</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Understanding architecture helps identify the root cause of
performance issues.</p>
</div>
</div>
<div class="section level2">
<h2 id="integration-with-other-vignettes">Integration with Other Vignettes<a class="anchor" aria-label="anchor" href="#integration-with-other-vignettes"></a>
</h2>
<p>This architectural overview connects to several other aspects of the
fmridataset ecosystem:</p>
<p><strong>Prerequisites</strong>: Start with <a href="fmridataset-intro.html">Getting Started</a> to understand basic
usage patterns before diving into architectural details.</p>
<p><strong>Implementation Guides</strong>: - <a href="backend-registry.html">Backend Registry</a> - Practical guide to
creating and registering custom backends - <a href="extending-backends.html">Extending Backends</a> - Deep dive into
backend development patterns - <a href="study-level-analysis.html">Study-Level Analysis</a> - Understand
how the architecture scales to multi-subject studies</p>
<p><strong>Applied Examples</strong>: - <a href="h5-backend-usage.html">H5 Backend Usage</a> - See advanced backend
features in practice</p>
<p><strong>Design Philosophy</strong>: The architecture reflects broader
principles of modular design, separation of concerns, and extensibility
that are common in scientific computing frameworks. Understanding these
patterns will help you work effectively with other packages in the
neuroimaging ecosystem.</p>
</div>
<div class="section level2">
<h2 id="session-information">Session Information<a class="anchor" aria-label="anchor" href="#session-information"></a>
</h2>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Bradley Buchsbaum.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
