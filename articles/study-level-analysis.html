<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Scaling to Study-Level Analysis: From Single Subjects to Group Studies • fmridataset</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Scaling to Study-Level Analysis: From Single Subjects to Group Studies">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">fmridataset</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.8.9</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/architecture-overview.html">Architecture Deep Dive: Design Principles and Extensibility</a></li>
    <li><a class="dropdown-item" href="../articles/backend-development-basics.html">Backend Development Basics: Creating Custom Storage Backends</a></li>
    <li><a class="dropdown-item" href="../articles/backend-registry.html">Backend Registry: Extending Data Format Support</a></li>
    <li><a class="dropdown-item" href="../articles/extending-backends.html">Advanced Backend Development: Storage Extensions</a></li>
    <li><a class="dropdown-item" href="../articles/fmridataset-intro.html">Getting Started with fmridataset</a></li>
    <li><a class="dropdown-item" href="../articles/h5-backend-usage.html">HDF5 Storage: High-Performance Data Management for Large-Scale fMRI Studies</a></li>
    <li><a class="dropdown-item" href="../articles/study-level-analysis.html">Scaling to Study-Level Analysis: From Single Subjects to Group Studies</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/bbuchsbaum/fmridataset/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Scaling to Study-Level Analysis: From Single Subjects to Group Studies</h1>
                        <h4 data-toc-skip class="author">fmridataset
Team</h4>
            
            <h4 data-toc-skip class="date">2026-01-22</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/bbuchsbaum/fmridataset/blob/main/vignettes/study-level-analysis.Rmd" class="external-link"><code>vignettes/study-level-analysis.Rmd</code></a></small>
      <div class="d-none name"><code>study-level-analysis.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="motivation-the-multi-subject-challenge">Motivation: The Multi-Subject Challenge<a class="anchor" aria-label="anchor" href="#motivation-the-multi-subject-challenge"></a>
</h2>
<p>Imagine you’ve developed a sophisticated single-subject fMRI analysis
pipeline that works beautifully for individual participants. You can
load their data, extract time series from regions of interest, perform
connectivity analyses, and generate comprehensive reports. Now your PI
asks you to scale this to a 50-subject study with data from three
different sites, each using slightly different acquisition protocols.
Some subjects have missing runs, others have different numbers of
sessions, and the file organization varies between sites.</p>
<p>Traditional approaches require complex loops, inconsistent data
structure management, missing data handling, and careful memory
orchestration to avoid loading all subjects simultaneously. The
fmridataset study-level analysis provides a unified interface scaling
from single subjects to multi-site studies while maintaining memory
efficiency and chunking capabilities.</p>
</div>
<div class="section level2">
<h2 id="quick-start-building-a-study-dataset">Quick Start: Building a Study Dataset<a class="anchor" aria-label="anchor" href="#quick-start-building-a-study-dataset"></a>
</h2>
<p>This example demonstrates single-subject to study-level analysis
transition through unified interface scaling:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bbuchsbaum/fmridataset" class="external-link">fmridataset</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Step 1: Create individual subject datasets (simulating realistic scenarios)</span></span>
<span><span class="va">create_subject_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">subject_id</span>, <span class="va">n_runs</span> <span class="op">=</span> <span class="fl">2</span>, <span class="va">n_timepoints_per_run</span> <span class="op">=</span> <span class="fl">100</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"sub-"</span>, <span class="st">""</span>, <span class="va">subject_id</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co"># Reproducible per subject</span></span>
<span></span>
<span>  <span class="co"># Simulate subject-specific characteristics</span></span>
<span>  <span class="va">n_voxels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">800</span><span class="op">:</span><span class="fl">1200</span>, <span class="fl">1</span><span class="op">)</span> <span class="co"># Different brain sizes</span></span>
<span></span>
<span>  <span class="co"># Create realistic fMRI data with some subject-specific signal</span></span>
<span>  <span class="va">data_matrices</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">run</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_runs</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">run_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_timepoints_per_run</span> <span class="op">*</span> <span class="va">n_voxels</span>,</span>
<span>        mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">1</span></span>
<span>      <span class="op">)</span>,</span>
<span>      nrow <span class="op">=</span> <span class="va">n_timepoints_per_run</span>, ncol <span class="op">=</span> <span class="va">n_voxels</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Add subject-specific activation pattern</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">subject_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sub-001"</span>, <span class="st">"sub-003"</span>, <span class="st">"sub-005"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># "High responders" - stronger activation in first 100 voxels</span></span>
<span>      <span class="va">activation_timepoints</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n_timepoints_per_run</span>, <span class="fl">20</span><span class="op">)</span></span>
<span>      <span class="va">run_data</span><span class="op">[</span><span class="va">activation_timepoints</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">100</span><span class="op">]</span> <span class="op">&lt;-</span></span>
<span>        <span class="va">run_data</span><span class="op">[</span><span class="va">activation_timepoints</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">100</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1.5</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="va">data_matrices</span><span class="op">[[</span><span class="va">run</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">run_data</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Combine runs into single matrix</span></span>
<span>  <span class="va">combined_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">data_matrices</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Create subject dataset</span></span>
<span>  <span class="va">dataset</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/matrix_dataset.html">matrix_dataset</a></span><span class="op">(</span></span>
<span>    datamat <span class="op">=</span> <span class="va">combined_data</span>,</span>
<span>    TR <span class="op">=</span> <span class="fl">2.0</span>,</span>
<span>    run_length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">n_timepoints_per_run</span>, <span class="va">n_runs</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">dataset</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Create multiple subject datasets</span></span>
<span><span class="va">subject_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sub-001"</span>, <span class="st">"sub-002"</span>, <span class="st">"sub-003"</span>, <span class="st">"sub-004"</span>, <span class="st">"sub-005"</span><span class="op">)</span></span>
<span><span class="va">subject_datasets</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">subject_id</span> <span class="kw">in</span> <span class="va">subject_ids</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">subject_datasets</span><span class="op">[[</span><span class="va">subject_id</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">create_subject_data</span><span class="op">(</span><span class="va">subject_id</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Created dataset for"</span>, <span class="va">subject_id</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Step 2: Combine into study-level dataset</span></span>
<span><span class="va">study_dataset</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fmri_study_dataset.html">fmri_study_dataset</a></span><span class="op">(</span></span>
<span>  datasets <span class="op">=</span> <span class="va">subject_datasets</span>,</span>
<span>  subject_ids <span class="op">=</span> <span class="va">subject_ids</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Study dataset created with"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">subject_ids</span><span class="op">)</span>, <span class="st">"subjects\n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/print.html">print</a></span><span class="op">(</span><span class="va">study_dataset</span><span class="op">)</span></span></code></pre></div>
<p>Now let’s see the unified interface in action:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Same methods work at study level</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Study TR:"</span>, <span class="fu"><a href="../reference/get_TR.html">get_TR</a></span><span class="op">(</span><span class="va">study_dataset</span><span class="op">)</span>, <span class="st">"seconds\n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Study runs per subject:"</span>, <span class="fu"><a href="../reference/n_runs.html">n_runs</a></span><span class="op">(</span><span class="va">study_dataset</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Study timepoints per subject:"</span>, <span class="fu"><a href="../reference/n_timepoints.html">n_timepoints</a></span><span class="op">(</span><span class="va">study_dataset</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Access subject-specific information</span></span>
<span><span class="va">subject_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/subject_ids.html">subject_ids</a></span><span class="op">(</span><span class="va">study_dataset</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Subject IDs:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">subject_list</span>, collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Demonstrate memory-efficient subject iteration</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">subject_list</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">subject_id</span> <span class="op">&lt;-</span> <span class="va">subject_list</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Subject"</span>, <span class="va">subject_id</span>, <span class="st">"available for analysis\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><strong>Technical Design</strong>: Study datasets implement the same
interface as single-subject datasets through hierarchical abstraction.
This design enables single-subject analysis code to scale to
multi-subject studies without modification.</p>
</div>
<div class="section level2">
<h2 id="understanding-study-level-architecture">Understanding Study-Level Architecture<a class="anchor" aria-label="anchor" href="#understanding-study-level-architecture"></a>
</h2>
<p>The study-level analysis capabilities in fmridataset are built on
sophisticated architectural principles that enable efficient scaling
while preserving all the capabilities you rely on for single-subject
analyses.</p>
<div class="section level3">
<h3 id="lazy-evaluation-memory-efficiency-at-scale">Lazy Evaluation: Memory Efficiency at Scale<a class="anchor" aria-label="anchor" href="#lazy-evaluation-memory-efficiency-at-scale"></a>
</h3>
<p>The most important concept for study-level analysis is lazy
evaluation, which ensures that subject data is loaded only when actually
needed. This architectural choice enables analysis of arbitrarily large
studies without exhausting system memory. When you create a study
dataset, you’re creating a smart container that knows about all your
subjects but doesn’t immediately load their data.</p>
<p>This lazy approach means you can work with studies containing
hundreds of subjects on modest hardware. The system maintains metadata
about each subject’s temporal structure, spatial organization, and
experimental design while keeping the actual neuroimaging data on disk
until specific analyses require it. This design pattern is essential for
modern neuroimaging research where studies routinely exceed the memory
capacity of individual workstations.</p>
</div>
<div class="section level3">
<h3 id="unified-interface-scaling">Unified Interface Scaling<a class="anchor" aria-label="anchor" href="#unified-interface-scaling"></a>
</h3>
<p>The study dataset implements the same interface as individual
datasets, enabling seamless scaling of analysis code. When you call
<code><a href="../reference/get_TR.html">get_TR()</a></code> on a study dataset, it returns the common TR
across all subjects. When you request data chunks, the system
automatically coordinates chunking across subjects while maintaining the
same programming interface you use for single subjects.</p>
<p>This unified scaling means you can develop and test analysis
pipelines on single subjects, then deploy them unchanged to full
studies. The system handles the complexity of coordinating operations
across multiple subjects while preserving the simple, intuitive
interface you’re already familiar with. This design significantly
reduces the cognitive load of scaling analyses and eliminates many
sources of bugs that arise when translating between single-subject and
group-level code.</p>
</div>
<div class="section level3">
<h3 id="subject-aware-chunking">Subject-Aware Chunking<a class="anchor" aria-label="anchor" href="#subject-aware-chunking"></a>
</h3>
<p>The chunking system extends naturally to study-level datasets by
becoming subject-aware. Rather than just dividing voxels across chunks,
the system can create chunks that respect subject boundaries, enabling
parallel processing strategies that work efficiently with multi-subject
data. This subject-aware chunking is crucial for analyses that need to
maintain subject identity throughout processing.</p>
<p>The chunking system also enables sophisticated memory management
strategies for large studies. You can choose to process subjects
individually to minimize memory usage, or group multiple subjects per
chunk when your analysis benefits from cross-subject operations. This
flexibility enables optimal performance for different analysis patterns
while maintaining the same simple chunking interface.</p>
</div>
</div>
<div class="section level2">
<h2 id="deep-dive-study-level-operations">Deep Dive: Study-Level Operations<a class="anchor" aria-label="anchor" href="#deep-dive-study-level-operations"></a>
</h2>
<p>With the architectural foundations clear, let’s explore the full
range of capabilities available for study-level analysis and see how to
use them effectively.</p>
<div class="section level3">
<h3 id="creating-study-datasets-from-different-sources">Creating Study Datasets from Different Sources<a class="anchor" aria-label="anchor" href="#creating-study-datasets-from-different-sources"></a>
</h3>
<div class="section level4">
<h4 id="from-individual-dataset-objects">From Individual Dataset Objects<a class="anchor" aria-label="anchor" href="#from-individual-dataset-objects"></a>
</h4>
<p>The most straightforward approach is combining existing dataset
objects:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create individual datasets with realistic variation</span></span>
<span><span class="va">subject_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Subject 1: Standard 2-run acquisition</span></span>
<span><span class="va">subject_data</span><span class="op">[[</span><span class="st">"sub-001"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/matrix_dataset.html">matrix_dataset</a></span><span class="op">(</span></span>
<span>  datamat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">20000</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">200</span>, ncol <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>,</span>
<span>  TR <span class="op">=</span> <span class="fl">2.0</span>,</span>
<span>  run_length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">100</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Subject 2: Different number of runs (3 runs)</span></span>
<span><span class="va">subject_data</span><span class="op">[[</span><span class="st">"sub-002"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/matrix_dataset.html">matrix_dataset</a></span><span class="op">(</span></span>
<span>  datamat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">21000</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">210</span>, ncol <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>,</span>
<span>  TR <span class="op">=</span> <span class="fl">2.0</span>,</span>
<span>  run_length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">70</span>, <span class="fl">70</span>, <span class="fl">70</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Subject 3: Different voxel count (different preprocessing)</span></span>
<span><span class="va">subject_data</span><span class="op">[[</span><span class="st">"sub-003"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/matrix_dataset.html">matrix_dataset</a></span><span class="op">(</span></span>
<span>  datamat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">24000</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">200</span>, ncol <span class="op">=</span> <span class="fl">120</span><span class="op">)</span>,</span>
<span>  TR <span class="op">=</span> <span class="fl">2.0</span>,</span>
<span>  run_length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">100</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Combine into study dataset</span></span>
<span><span class="va">study_ds</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fmri_study_dataset.html">fmri_study_dataset</a></span><span class="op">(</span></span>
<span>  datasets <span class="op">=</span> <span class="va">subject_data</span>,</span>
<span>  subject_ids <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">subject_data</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Created study with"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">subject_data</span><span class="op">)</span>, <span class="st">"subjects\n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Run structure varies across subjects\n"</span><span class="op">)</span></span></code></pre></div>
<p>This approach provides maximum flexibility for handling heterogeneous
study designs.</p>
</div>
<div class="section level4">
<h4 id="from-file-paths-with-bids-like-organization">From File Paths with BIDS-like Organization<a class="anchor" aria-label="anchor" href="#from-file-paths-with-bids-like-organization"></a>
</h4>
<p>For studies organized with consistent file structures:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Simulate BIDS-like file organization</span></span>
<span><span class="va">study_root</span> <span class="op">&lt;-</span> <span class="st">"/path/to/study"</span></span>
<span><span class="va">subject_files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate file paths for each subject</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">subj</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"001"</span>, <span class="st">"002"</span>, <span class="st">"003"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">subject_files</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"sub-"</span>, <span class="va">subj</span><span class="op">)</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    scans <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">study_root</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"sub-"</span>, <span class="va">subj</span><span class="op">)</span>, <span class="st">"func"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"sub-"</span>, <span class="va">subj</span>, <span class="st">"_task-rest_run-1_bold.nii.gz"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">study_root</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"sub-"</span>, <span class="va">subj</span><span class="op">)</span>, <span class="st">"func"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"sub-"</span>, <span class="va">subj</span>, <span class="st">"_task-rest_run-2_bold.nii.gz"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    mask <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">study_root</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"sub-"</span>, <span class="va">subj</span><span class="op">)</span>, <span class="st">"func"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"sub-"</span>, <span class="va">subj</span>, <span class="st">"_space-MNI152_desc-brain_mask.nii.gz"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Create study dataset from file structure (would work with real files)</span></span>
<span><span class="co"># study_from_files &lt;- fmri_study_dataset_from_files(</span></span>
<span><span class="co">#   subject_files = subject_files,</span></span>
<span><span class="co">#   TR = 2.0,</span></span>
<span><span class="co">#   run_length = c(180, 180)  # Common across subjects</span></span>
<span><span class="co"># )</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"File-based study dataset structure prepared\n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Supports heterogeneous file organization patterns\n"</span><span class="op">)</span></span></code></pre></div>
<p>This approach works well for studies with consistent organization
schemes.</p>
</div>
</div>
<div class="section level3">
<h3 id="memory-efficient-data-access-patterns">Memory-Efficient Data Access Patterns<a class="anchor" aria-label="anchor" href="#memory-efficient-data-access-patterns"></a>
</h3>
<div class="section level4">
<h4 id="subject-by-subject-processing">Subject-by-Subject Processing<a class="anchor" aria-label="anchor" href="#subject-by-subject-processing"></a>
</h4>
<p>The most memory-efficient approach processes one subject at a
time:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Process subjects individually to minimize memory usage</span></span>
<span><span class="va">analyze_subject_individually</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">study_dataset</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">subject_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/subject_ids.html">subject_ids</a></span><span class="op">(</span><span class="va">study_dataset</span><span class="op">)</span></span>
<span>  <span class="va">subject_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">subj_id</span> <span class="kw">in</span> <span class="va">subject_list</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Processing subject"</span>, <span class="va">subj_id</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Extract data for this subject only</span></span>
<span>    <span class="va">subj_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_data_matrix.html">get_data_matrix</a></span><span class="op">(</span><span class="va">study_dataset</span>, subject_id <span class="op">=</span> <span class="va">subj_id</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Perform subject-specific analysis</span></span>
<span>    <span class="va">subj_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      subject_id <span class="op">=</span> <span class="va">subj_id</span>,</span>
<span>      n_timepoints <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">subj_data</span><span class="op">)</span>,</span>
<span>      n_voxels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">subj_data</span><span class="op">)</span>,</span>
<span>      mean_signal <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">subj_data</span><span class="op">)</span>,</span>
<span>      signal_variance <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">subj_data</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="va">subject_results</span><span class="op">[[</span><span class="va">subj_id</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">subj_result</span></span>
<span></span>
<span>    <span class="co"># Explicit memory cleanup</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">subj_data</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/gc.html" class="external-link">gc</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">subject_results</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Apply individual processing</span></span>
<span><span class="va">individual_results</span> <span class="op">&lt;-</span> <span class="fu">analyze_subject_individually</span><span class="op">(</span><span class="va">study_dataset</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Summarize results</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">result</span> <span class="kw">in</span> <span class="va">individual_results</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span></span>
<span>    <span class="st">"Subject"</span>, <span class="va">result</span><span class="op">$</span><span class="va">subject_id</span>, <span class="st">":"</span>,</span>
<span>    <span class="va">result</span><span class="op">$</span><span class="va">n_timepoints</span>, <span class="st">"timepoints,"</span>,</span>
<span>    <span class="va">result</span><span class="op">$</span><span class="va">n_voxels</span>, <span class="st">"voxels,"</span>,</span>
<span>    <span class="st">"mean signal ="</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">mean_signal</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"\n"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>This pattern minimizes memory usage and enables processing of
arbitrarily large studies.</p>
</div>
<div class="section level4">
<h4 id="chunked-cross-subject-processing">Chunked Cross-Subject Processing<a class="anchor" aria-label="anchor" href="#chunked-cross-subject-processing"></a>
</h4>
<p>For analyses that benefit from cross-subject operations:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Process data in chunks that span subjects</span></span>
<span><span class="va">analyze_cross_subject_chunks</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">study_dataset</span>, <span class="va">nchunks</span> <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Create study-level chunks</span></span>
<span>  <span class="va">study_chunks</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/data_chunks.html">data_chunks</a></span><span class="op">(</span><span class="va">study_dataset</span>, nchunks <span class="op">=</span> <span class="va">nchunks</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">chunk_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">chunk</span> <span class="kw">in</span> <span class="va">study_chunks</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span></span>
<span>      <span class="st">"Processing chunk"</span>, <span class="va">chunk</span><span class="op">$</span><span class="va">chunk_num</span>,</span>
<span>      <span class="st">"with"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">chunk</span><span class="op">$</span><span class="va">data</span><span class="op">)</span>, <span class="st">"voxels across subjects\n"</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Chunk data includes information about which subjects contributed</span></span>
<span>    <span class="va">chunk_analysis</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      chunk_id <span class="op">=</span> <span class="va">chunk</span><span class="op">$</span><span class="va">chunk_num</span>,</span>
<span>      total_voxels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">chunk</span><span class="op">$</span><span class="va">data</span><span class="op">)</span>,</span>
<span>      total_timepoints <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">chunk</span><span class="op">$</span><span class="va">data</span><span class="op">)</span>,</span>
<span>      cross_subject_correlation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">chunk</span><span class="op">$</span><span class="va">data</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      voxel_indices <span class="op">=</span> <span class="va">chunk</span><span class="op">$</span><span class="va">voxel_indices</span> <span class="co"># Which voxels this chunk contains</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="va">chunk_results</span><span class="op">[[</span><span class="va">chunk</span><span class="op">$</span><span class="va">chunk_num</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">chunk_analysis</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">chunk_results</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Apply cross-subject chunked processing</span></span>
<span><span class="va">chunk_results</span> <span class="op">&lt;-</span> <span class="fu">analyze_cross_subject_chunks</span><span class="op">(</span><span class="va">study_dataset</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Summarize chunk-based results</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">result</span> <span class="kw">in</span> <span class="va">chunk_results</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span></span>
<span>    <span class="st">"Chunk"</span>, <span class="va">result</span><span class="op">$</span><span class="va">chunk_id</span>, <span class="st">":"</span>,</span>
<span>    <span class="va">result</span><span class="op">$</span><span class="va">total_voxels</span>, <span class="st">"voxels,"</span>,</span>
<span>    <span class="st">"mean correlation ="</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">cross_subject_correlation</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"\n"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>This approach enables efficient cross-subject analyses while
maintaining memory control.</p>
</div>
</div>
<div class="section level3">
<h3 id="advanced-study-level-features">Advanced Study-Level Features<a class="anchor" aria-label="anchor" href="#advanced-study-level-features"></a>
</h3>
<div class="section level4">
<h4 id="fmri_series-flexible-subject-and-voxel-selection">fmri_series: Flexible Subject and Voxel Selection<a class="anchor" aria-label="anchor" href="#fmri_series-flexible-subject-and-voxel-selection"></a>
</h4>
<p>The <code>fmri_series</code> function provides sophisticated access
to study data with flexible selection criteria:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Extract time series from specific voxels and subjects</span></span>
<span><span class="va">series_subset</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fmri_series.html">fmri_series</a></span><span class="op">(</span></span>
<span>  <span class="va">study_dataset</span>,</span>
<span>  selector <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="co"># First 10 voxels</span></span>
<span>  subject_ids <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sub-001"</span>, <span class="st">"sub-003"</span><span class="op">)</span>, <span class="co"># Specific subjects</span></span>
<span>  timepoints <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">50</span> <span class="co"># First 50 timepoints</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Extracted series from"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">series_subset</span><span class="op">)</span>, <span class="st">"voxels\n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Time series length:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">series_subset</span><span class="op">)</span>, <span class="st">"timepoints\n"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Convert to tibble for advanced analysis</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"dplyr"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">series_tibble</span> <span class="op">&lt;-</span> <span class="fu">as_tibble</span><span class="op">(</span><span class="va">series_subset</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Group by subject for subject-specific analysis</span></span>
<span>  <span class="va">subject_summary</span> <span class="op">&lt;-</span> <span class="va">series_tibble</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">subject_id</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>      mean_signal <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">signal</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>      signal_sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">signal</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>      n_observations <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      .groups <span class="op">=</span> <span class="st">"drop"</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="../reference/print.html">print</a></span><span class="op">(</span><span class="va">subject_summary</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The <code>fmri_series</code> approach provides maximum flexibility
for exploratory analyses.</p>
</div>
<div class="section level4">
<h4 id="handling-heterogeneous-study-designs">Handling Heterogeneous Study Designs<a class="anchor" aria-label="anchor" href="#handling-heterogeneous-study-designs"></a>
</h4>
<p>Study datasets can accommodate subjects with different run structures
and temporal organizations:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create subjects with different temporal structures</span></span>
<span><span class="va">heterogeneous_subjects</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Subject A: 2 runs, 100 timepoints each</span></span>
<span><span class="va">heterogeneous_subjects</span><span class="op">[[</span><span class="st">"sub-A"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/matrix_dataset.html">matrix_dataset</a></span><span class="op">(</span></span>
<span>  datamat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">20000</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">200</span>, ncol <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>,</span>
<span>  TR <span class="op">=</span> <span class="fl">2.0</span>,</span>
<span>  run_length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">100</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Subject B: 3 runs, 80 timepoints each</span></span>
<span><span class="va">heterogeneous_subjects</span><span class="op">[[</span><span class="st">"sub-B"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/matrix_dataset.html">matrix_dataset</a></span><span class="op">(</span></span>
<span>  datamat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">24000</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">240</span>, ncol <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>,</span>
<span>  TR <span class="op">=</span> <span class="fl">2.0</span>,</span>
<span>  run_length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">80</span>, <span class="fl">80</span>, <span class="fl">80</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Subject C: 1 long run, 200 timepoints</span></span>
<span><span class="va">heterogeneous_subjects</span><span class="op">[[</span><span class="st">"sub-C"</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/matrix_dataset.html">matrix_dataset</a></span><span class="op">(</span></span>
<span>  datamat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">20000</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">200</span>, ncol <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>,</span>
<span>  TR <span class="op">=</span> <span class="fl">2.0</span>,</span>
<span>  run_length <span class="op">=</span> <span class="fl">200</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Combine into heterogeneous study</span></span>
<span><span class="va">hetero_study</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fmri_study_dataset.html">fmri_study_dataset</a></span><span class="op">(</span></span>
<span>  datasets <span class="op">=</span> <span class="va">heterogeneous_subjects</span>,</span>
<span>  subject_ids <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">heterogeneous_subjects</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Study-level operations work despite heterogeneity</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Heterogeneous study TR:"</span>, <span class="fu"><a href="../reference/get_TR.html">get_TR</a></span><span class="op">(</span><span class="va">hetero_study</span><span class="op">)</span>, <span class="st">"seconds\n"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Subject-specific operations preserve individual structure</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">subj_id</span> <span class="kw">in</span> <span class="fu"><a href="../reference/subject_ids.html">subject_ids</a></span><span class="op">(</span><span class="va">hetero_study</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">subj_runs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/n_runs.html">n_runs</a></span><span class="op">(</span><span class="va">hetero_study</span>, subject_id <span class="op">=</span> <span class="va">subj_id</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Subject"</span>, <span class="va">subj_id</span>, <span class="st">"has"</span>, <span class="va">subj_runs</span>, <span class="st">"runs\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>This flexibility enables analysis of real-world studies with complex
designs.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="advanced-topics">Advanced Topics<a class="anchor" aria-label="anchor" href="#advanced-topics"></a>
</h2>
<p>Once you’re comfortable with basic study-level operations, these
advanced techniques help you handle complex scenarios and optimize
performance for large studies.</p>
<div class="section level3">
<h3 id="performance-optimization-for-large-studies">Performance Optimization for Large Studies<a class="anchor" aria-label="anchor" href="#performance-optimization-for-large-studies"></a>
</h3>
<div class="section level4">
<h4 id="memory-monitoring-and-management">Memory Monitoring and Management<a class="anchor" aria-label="anchor" href="#memory-monitoring-and-management"></a>
</h4>
<p>Understanding memory usage patterns helps optimize large study
analyses:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Monitor memory usage during study operations</span></span>
<span><span class="va">monitor_study_memory</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">study_dataset</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"pryr"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">start_memory</span> <span class="op">&lt;-</span> <span class="fu">pryr</span><span class="fu">::</span><span class="fu">mem_used</span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Starting memory usage:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">start_memory</span>, units <span class="op">=</span> <span class="st">"Mb"</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Simulate loading one subject</span></span>
<span>    <span class="va">subj_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_data_matrix.html">get_data_matrix</a></span><span class="op">(</span><span class="va">study_dataset</span>, subject_id <span class="op">=</span> <span class="fu"><a href="../reference/subject_ids.html">subject_ids</a></span><span class="op">(</span><span class="va">study_dataset</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">single_subj_memory</span> <span class="op">&lt;-</span> <span class="fu">pryr</span><span class="fu">::</span><span class="fu">mem_used</span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"After loading one subject:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">single_subj_memory</span>, units <span class="op">=</span> <span class="st">"Mb"</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Calculate memory per subject</span></span>
<span>    <span class="va">memory_per_subject</span> <span class="op">&lt;-</span> <span class="va">single_subj_memory</span> <span class="op">-</span> <span class="va">start_memory</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Memory per subject:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">memory_per_subject</span>, units <span class="op">=</span> <span class="st">"Mb"</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Estimate memory for full study</span></span>
<span>    <span class="va">n_subjects</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="../reference/subject_ids.html">subject_ids</a></span><span class="op">(</span><span class="va">study_dataset</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">estimated_full_memory</span> <span class="op">&lt;-</span> <span class="va">start_memory</span> <span class="op">+</span> <span class="op">(</span><span class="va">memory_per_subject</span> <span class="op">*</span> <span class="va">n_subjects</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span></span>
<span>      <span class="st">"Estimated memory for"</span>, <span class="va">n_subjects</span>, <span class="st">"subjects:"</span>,</span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">estimated_full_memory</span>, units <span class="op">=</span> <span class="st">"Mb"</span><span class="op">)</span>, <span class="st">"\n"</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Cleanup</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">subj_data</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/gc.html" class="external-link">gc</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      memory_per_subject <span class="op">=</span> <span class="va">memory_per_subject</span>,</span>
<span>      estimated_full_study <span class="op">=</span> <span class="va">estimated_full_memory</span></span>
<span>    <span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># memory_stats &lt;- monitor_study_memory(study_dataset)</span></span></code></pre></div>
<p>This monitoring helps you choose appropriate chunking strategies.</p>
</div>
<div class="section level4">
<h4 id="parallel-processing-strategies">Parallel Processing Strategies<a class="anchor" aria-label="anchor" href="#parallel-processing-strategies"></a>
</h4>
<p>Study datasets enable sophisticated parallel processing
approaches:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Parallel subject processing</span></span>
<span><span class="va">process_subjects_parallel</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">study_dataset</span>, <span class="va">analysis_func</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"parallel"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Detect cores</span></span>
<span>    <span class="va">n_cores</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="../reference/subject_ids.html">subject_ids</a></span><span class="op">(</span><span class="va">study_dataset</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Using"</span>, <span class="va">n_cores</span>, <span class="st">"cores for parallel processing\n"</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Create cluster</span></span>
<span>    <span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeCluster</a></span><span class="op">(</span><span class="va">n_cores</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Export necessary objects</span></span>
<span>    <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">clusterEvalQ</a></span><span class="op">(</span><span class="va">cl</span>, <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bbuchsbaum/fmridataset" class="external-link">fmridataset</a></span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">clusterExport</a></span><span class="op">(</span><span class="va">cl</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"study_dataset"</span>, <span class="st">"analysis_func"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Process subjects in parallel</span></span>
<span>    <span class="va">subject_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/subject_ids.html">subject_ids</a></span><span class="op">(</span><span class="va">study_dataset</span><span class="op">)</span></span>
<span>    <span class="va">results</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html" class="external-link">parLapply</a></span><span class="op">(</span><span class="va">cl</span>, <span class="va">subject_list</span>, <span class="kw">function</span><span class="op">(</span><span class="va">subj_id</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># Extract data for this subject</span></span>
<span>      <span class="va">subj_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_data_matrix.html">get_data_matrix</a></span><span class="op">(</span><span class="va">study_dataset</span>, subject_id <span class="op">=</span> <span class="va">subj_id</span><span class="op">)</span></span>
<span></span>
<span>      <span class="co"># Apply analysis function</span></span>
<span>      <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">analysis_func</span><span class="op">(</span><span class="va">subj_data</span><span class="op">)</span></span>
<span>      <span class="va">result</span><span class="op">$</span><span class="va">subject_id</span> <span class="op">&lt;-</span> <span class="va">subj_id</span></span>
<span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Cleanup</span></span>
<span>    <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span>
<span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"parallel package not available, using sequential processing\n"</span><span class="op">)</span></span>
<span>    <span class="co"># Fallback to sequential processing</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu">process_subjects_sequential</span><span class="op">(</span><span class="va">study_dataset</span>, <span class="va">analysis_func</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Example analysis function</span></span>
<span><span class="va">simple_analysis</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data_matrix</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    mean_signal <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">data_matrix</span><span class="op">)</span>,</span>
<span>    n_timepoints <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data_matrix</span><span class="op">)</span>,</span>
<span>    n_voxels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">data_matrix</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Apply parallel processing (commented out for vignette)</span></span>
<span><span class="co"># parallel_results &lt;- process_subjects_parallel(study_dataset, simple_analysis)</span></span></code></pre></div>
<p>Parallel processing can significantly accelerate large study
analyses.</p>
</div>
</div>
<div class="section level3">
<h3 id="quality-control-and-validation">Quality Control and Validation<a class="anchor" aria-label="anchor" href="#quality-control-and-validation"></a>
</h3>
<div class="section level4">
<h4 id="study-level-quality-metrics">Study-Level Quality Metrics<a class="anchor" aria-label="anchor" href="#study-level-quality-metrics"></a>
</h4>
<p>Implement comprehensive quality control across the entire study:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Comprehensive study quality assessment</span></span>
<span><span class="va">assess_study_quality</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">study_dataset</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">subject_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/subject_ids.html">subject_ids</a></span><span class="op">(</span><span class="va">study_dataset</span><span class="op">)</span></span>
<span>  <span class="va">quality_metrics</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">subj_id</span> <span class="kw">in</span> <span class="va">subject_list</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Assessing quality for"</span>, <span class="va">subj_id</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Get subject data</span></span>
<span>    <span class="va">subj_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_data_matrix.html">get_data_matrix</a></span><span class="op">(</span><span class="va">study_dataset</span>, subject_id <span class="op">=</span> <span class="va">subj_id</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Calculate quality metrics</span></span>
<span>    <span class="va">metrics</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      subject_id <span class="op">=</span> <span class="va">subj_id</span>,</span>
<span>      n_timepoints <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">subj_data</span><span class="op">)</span>,</span>
<span>      n_voxels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">subj_data</span><span class="op">)</span>,</span>
<span>      mean_signal <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">subj_data</span><span class="op">)</span>,</span>
<span>      signal_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">subj_data</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      zero_voxels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">subj_data</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">subj_data</span><span class="op">)</span><span class="op">)</span>,</span>
<span>      outlier_timepoints <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">subj_data</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">3</span><span class="op">)</span>,</span>
<span>      temporal_snr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">subj_data</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">subj_data</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="va">quality_metrics</span><span class="op">[[</span><span class="va">subj_id</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">metrics</span></span>
<span></span>
<span>    <span class="co"># Memory cleanup</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">subj_data</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">quality_metrics</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Run quality assessment</span></span>
<span><span class="va">quality_results</span> <span class="op">&lt;-</span> <span class="fu">assess_study_quality</span><span class="op">(</span><span class="va">study_dataset</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Summarize quality across study</span></span>
<span><span class="va">quality_summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  subject_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">quality_results</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">subject_id</span><span class="op">)</span>,</span>
<span>  n_timepoints <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">quality_results</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">n_timepoints</span><span class="op">)</span>,</span>
<span>  n_voxels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">quality_results</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">n_voxels</span><span class="op">)</span>,</span>
<span>  temporal_snr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">quality_results</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">temporal_snr</span><span class="op">)</span>,</span>
<span>  outlier_timepoints <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">quality_results</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">outlier_timepoints</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Study Quality Summary:\n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/print.html">print</a></span><span class="op">(</span><span class="va">quality_summary</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Identify potential issues</span></span>
<span><span class="va">problematic_subjects</span> <span class="op">&lt;-</span> <span class="va">quality_summary</span><span class="op">$</span><span class="va">subject_id</span><span class="op">[</span><span class="va">quality_summary</span><span class="op">$</span><span class="va">outlier_timepoints</span> <span class="op">&gt;</span> <span class="fl">5</span><span class="op">]</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">problematic_subjects</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Subjects with potential quality issues:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">problematic_subjects</span>, collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Systematic quality control helps ensure reliable study results.</p>
</div>
<div class="section level4">
<h4 id="data-consistency-validation">Data Consistency Validation<a class="anchor" aria-label="anchor" href="#data-consistency-validation"></a>
</h4>
<p>Verify consistency across subjects in the study:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Validate study consistency</span></span>
<span><span class="va">validate_study_consistency</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">study_dataset</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">subject_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/subject_ids.html">subject_ids</a></span><span class="op">(</span><span class="va">study_dataset</span><span class="op">)</span></span>
<span>  <span class="va">consistency_report</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Check temporal structure consistency</span></span>
<span>  <span class="va">tr_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">subject_list</span>, <span class="kw">function</span><span class="op">(</span><span class="va">subj_id</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="../reference/get_TR.html">get_TR</a></span><span class="op">(</span><span class="va">study_dataset</span>, subject_id <span class="op">=</span> <span class="va">subj_id</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">consistency_report</span><span class="op">$</span><span class="va">tr_consistent</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">tr_values</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span></span>
<span>  <span class="va">consistency_report</span><span class="op">$</span><span class="va">tr_range</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">tr_values</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Check run structure patterns</span></span>
<span>  <span class="va">run_counts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">subject_list</span>, <span class="kw">function</span><span class="op">(</span><span class="va">subj_id</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="../reference/n_runs.html">n_runs</a></span><span class="op">(</span><span class="va">study_dataset</span>, subject_id <span class="op">=</span> <span class="va">subj_id</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">consistency_report</span><span class="op">$</span><span class="va">run_count_consistent</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">run_counts</span><span class="op">)</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="fl">2</span> <span class="co"># Allow some variation</span></span>
<span>  <span class="va">consistency_report</span><span class="op">$</span><span class="va">run_count_distribution</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">run_counts</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Check data dimensions</span></span>
<span>  <span class="va">voxel_counts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">subject_list</span>, <span class="kw">function</span><span class="op">(</span><span class="va">subj_id</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">subj_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_data_matrix.html">get_data_matrix</a></span><span class="op">(</span><span class="va">study_dataset</span>, subject_id <span class="op">=</span> <span class="va">subj_id</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">subj_data</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">consistency_report</span><span class="op">$</span><span class="va">voxel_count_consistent</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">voxel_counts</span><span class="op">)</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="fl">3</span> <span class="co"># Allow preprocessing variation</span></span>
<span>  <span class="va">consistency_report</span><span class="op">$</span><span class="va">voxel_count_range</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">voxel_counts</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">consistency_report</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Run consistency validation</span></span>
<span><span class="va">consistency_results</span> <span class="op">&lt;-</span> <span class="fu">validate_study_consistency</span><span class="op">(</span><span class="va">study_dataset</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Study Consistency Report:\n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"TR consistent:"</span>, <span class="va">consistency_results</span><span class="op">$</span><span class="va">tr_consistent</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Run counts:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">consistency_results</span><span class="op">$</span><span class="va">run_count_distribution</span><span class="op">)</span>,</span>
<span>  <span class="va">consistency_results</span><span class="op">$</span><span class="va">run_count_distribution</span>,</span>
<span>  sep <span class="op">=</span> <span class="st">":"</span>, collapse <span class="op">=</span> <span class="st">", "</span></span>
<span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Voxel count range:"</span>, <span class="va">consistency_results</span><span class="op">$</span><span class="va">voxel_count_range</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Report potential issues</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">consistency_results</span><span class="op">$</span><span class="va">tr_consistent</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/warning.html" class="external-link">warning</a></span><span class="op">(</span><span class="st">"TR values vary across subjects: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">consistency_results</span><span class="op">$</span><span class="va">tr_range</span>, collapse <span class="op">=</span> <span class="st">"-"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">consistency_results</span><span class="op">$</span><span class="va">voxel_count_consistent</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/warning.html" class="external-link">warning</a></span><span class="op">(</span><span class="st">"Voxel counts vary significantly across subjects"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Consistency validation helps identify data preprocessing issues
early.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="tips-and-best-practices">Tips and Best Practices<a class="anchor" aria-label="anchor" href="#tips-and-best-practices"></a>
</h2>
<p>Here are practical guidelines learned from analyzing large
neuroimaging studies that will help you work effectively with
study-level datasets.</p>
<div class="section level3">
<h3 id="memory-management-for-large-studies">Memory Management for Large Studies<a class="anchor" aria-label="anchor" href="#memory-management-for-large-studies"></a>
</h3>
<p><strong>Subject-Level Processing</strong>: Process subjects
individually using
<code>get_data_matrix(study_dataset, subject_id = "sub-001")</code>
rather than loading complete studies. Full study loading is only
appropriate when: - Total data size &lt; 50% of available RAM -
Cross-subject operations require simultaneous access - Computational
efficiency outweighs memory constraints</p>
</div>
<div class="section level3">
<h3 id="quality-control-requirements">Quality Control Requirements<a class="anchor" aria-label="anchor" href="#quality-control-requirements"></a>
</h3>
<p><strong>Pre-Analysis Validation</strong>: 1. Verify temporal
alignment across subjects 2. Check signal-to-noise ratios per subject 3.
Identify motion outliers using framewise displacement 4. Validate mask
coverage across subjects 5. Document exclusion criteria and
thresholds</p>
<p>Implement quality control before group analyses to prevent outlier
contamination of group statistics.</p>
</div>
<div class="section level3">
<h3 id="analysis-strategy-optimization">Analysis Strategy Optimization<a class="anchor" aria-label="anchor" href="#analysis-strategy-optimization"></a>
</h3>
<p><strong>Two-Phase Approach</strong>: 1. <strong>Exploration
Phase</strong>: Use <code><a href="../reference/fmri_series.html">fmri_series()</a></code> with subset selection for
hypothesis generation and parameter tuning 2. <strong>Production
Phase</strong>: Implement chunked processing with
<code><a href="../reference/data_chunks.html">data_chunks()</a></code> for full study analysis</p>
<p>This approach minimizes computational resources during development
while ensuring scalability for final analyses.</p>
</div>
<div class="section level3">
<h3 id="memory-management-strategies">Memory Management Strategies<a class="anchor" aria-label="anchor" href="#memory-management-strategies"></a>
</h3>
<p>Effective memory management is crucial for large study analyses:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Memory-efficient study analysis patterns</span></span>
<span><span class="va">memory_efficient_patterns</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Memory-efficient study analysis patterns:\n\n"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"1. Subject-by-subject processing:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"   - Load one subject at a time\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"   - Explicit cleanup with rm() and gc()\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"   - Monitor memory usage throughout\n\n"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"2. Chunked processing:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"   - Use study-level chunking for cross-subject operations\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"   - Choose chunk sizes based on available RAM\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"   - Consider subject boundaries in chunking strategy\n\n"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"3. Lazy evaluation:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"   - Keep study datasets lazy until analysis needed\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"   - Use metadata queries before loading data\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"   - Avoid unnecessary data conversions\n\n"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"4. Parallel processing:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"   - Process subjects in parallel when possible\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"   - Monitor total memory usage across cores\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"   - Use appropriate chunk sizes for parallel work\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">memory_efficient_patterns</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="study-design-considerations">Study Design Considerations<a class="anchor" aria-label="anchor" href="#study-design-considerations"></a>
</h3>
<p>Design your study analysis workflow to handle real-world
complexities:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Study design best practices</span></span>
<span><span class="va">study_design_guidelines</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Study design considerations:\n\n"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"1. Heterogeneity planning:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"   - Expect different run structures across subjects\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"   - Plan for missing data scenarios\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"   - Design analyses robust to preprocessing differences\n\n"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"2. Quality control integration:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"   - Implement QC at multiple stages\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"   - Use automated outlier detection\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"   - Document exclusion criteria clearly\n\n"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"3. Reproducibility measures:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"   - Document study dataset creation parameters\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"   - Version control analysis scripts\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"   - Save intermediate results for validation\n\n"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"4. Scalability planning:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"   - Test analysis pipelines on subsets first\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"   - Plan for computational resource requirements\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"   - Design modular analysis components\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">study_design_guidelines</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="error-handling-and-robustness">Error Handling and Robustness<a class="anchor" aria-label="anchor" href="#error-handling-and-robustness"></a>
</h3>
<p>Build robust analysis pipelines that handle real-world data
issues:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Robust study analysis with error handling</span></span>
<span><span class="va">robust_subject_analysis</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">study_dataset</span>, <span class="va">analysis_func</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">subject_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/subject_ids.html">subject_ids</a></span><span class="op">(</span><span class="va">study_dataset</span><span class="op">)</span></span>
<span>  <span class="va">successful_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">failed_subjects</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">subj_id</span> <span class="kw">in</span> <span class="va">subject_list</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Processing"</span>, <span class="va">subj_id</span>, <span class="st">"... "</span><span class="op">)</span></span>
<span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span></span>
<span>      <span class="op">{</span></span>
<span>        <span class="co"># Attempt to load and analyze subject data</span></span>
<span>        <span class="va">subj_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_data_matrix.html">get_data_matrix</a></span><span class="op">(</span><span class="va">study_dataset</span>, subject_id <span class="op">=</span> <span class="va">subj_id</span><span class="op">)</span></span>
<span></span>
<span>        <span class="co"># Basic data validation</span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">subj_data</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">subj_data</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"Empty data matrix"</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">subj_data</span><span class="op">)</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">subj_data</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0.1</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="kw"><a href="https://rdrr.io/r/base/warning.html" class="external-link">warning</a></span><span class="op">(</span></span>
<span>            <span class="st">"High proportion of missing values ("</span>,</span>
<span>            <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">subj_data</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>, <span class="fl">1</span><span class="op">)</span>, <span class="st">"%)"</span></span>
<span>          <span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span></span>
<span>        <span class="co"># Apply analysis</span></span>
<span>        <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">analysis_func</span><span class="op">(</span><span class="va">subj_data</span><span class="op">)</span></span>
<span>        <span class="va">result</span><span class="op">$</span><span class="va">subject_id</span> <span class="op">&lt;-</span> <span class="va">subj_id</span></span>
<span>        <span class="va">result</span><span class="op">$</span><span class="va">analysis_successful</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span></span>
<span>        <span class="va">successful_results</span><span class="op">[[</span><span class="va">subj_id</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">result</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"SUCCESS\n"</span><span class="op">)</span></span>
<span></span>
<span>        <span class="co"># Cleanup</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">subj_data</span><span class="op">)</span></span>
<span>      <span class="op">}</span>,</span>
<span>      error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"FAILED -"</span>, <span class="fu"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">conditionMessage</a></span><span class="op">(</span><span class="va">e</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>        <span class="va">failed_subjects</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">failed_subjects</span>, <span class="va">subj_id</span><span class="op">)</span></span>
<span></span>
<span>        <span class="co"># Store failure information</span></span>
<span>        <span class="va">successful_results</span><span class="op">[[</span><span class="va">subj_id</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>          subject_id <span class="op">=</span> <span class="va">subj_id</span>,</span>
<span>          analysis_successful <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>          error_message <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">conditionMessage</a></span><span class="op">(</span><span class="va">e</span><span class="op">)</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Summary report</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nAnalysis Summary:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Successful subjects:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">successful_results</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">failed_subjects</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Failed subjects:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">failed_subjects</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">failed_subjects</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Failed subject IDs:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">failed_subjects</span>, collapse <span class="op">=</span> <span class="st">", "</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">successful_results</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Example usage with error handling</span></span>
<span><span class="va">safe_analysis</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data_matrix</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Simple analysis that might fail on problematic data</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    mean_signal <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">data_matrix</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    signal_stability <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">data_matrix</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    data_quality_score <span class="op">=</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">data_matrix</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># robust_results &lt;- robust_subject_analysis(study_dataset, safe_analysis)</span></span></code></pre></div>
<p>Robust error handling ensures that individual subject issues don’t
derail entire study analyses.</p>
</div>
</div>
<div class="section level2">
<h2 id="troubleshooting-study-level-issues">Troubleshooting Study-Level Issues<a class="anchor" aria-label="anchor" href="#troubleshooting-study-level-issues"></a>
</h2>
<p>When working with study-level datasets, certain issues are common and
can be systematically diagnosed and resolved.</p>
<div class="section level3">
<h3 id="memory-related-problems">Memory-Related Problems<a class="anchor" aria-label="anchor" href="#memory-related-problems"></a>
</h3>
<dl>
<dt><strong>“Error: cannot allocate vector of size X Gb”</strong></dt>
<dd>
This indicates you’re trying to load too much data simultaneously.
Switch to subject-by-subject processing or reduce chunk sizes.
</dd>
<dt><strong>Slow performance with study operations</strong></dt>
<dd>
Check if you’re accidentally triggering full study data loading. Use
subject-specific access patterns and monitor memory usage.
</dd>
</dl>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Diagnose memory issues</span></span>
<span><span class="va">diagnose_memory_issues</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">study_dataset</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Memory diagnostic for study dataset:\n\n"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Check study size</span></span>
<span>  <span class="va">n_subjects</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="../reference/subject_ids.html">subject_ids</a></span><span class="op">(</span><span class="va">study_dataset</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Number of subjects:"</span>, <span class="va">n_subjects</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Estimate memory requirements</span></span>
<span>  <span class="va">first_subject</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/subject_ids.html">subject_ids</a></span><span class="op">(</span><span class="va">study_dataset</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">sample_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_data_matrix.html">get_data_matrix</a></span><span class="op">(</span><span class="va">study_dataset</span>, subject_id <span class="op">=</span> <span class="va">first_subject</span><span class="op">)</span></span>
<span>  <span class="va">sample_size</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/object.size.html" class="external-link">object.size</a></span><span class="op">(</span><span class="va">sample_data</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Sample subject data size:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">sample_size</span>, units <span class="op">=</span> <span class="st">"Mb"</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Estimated full study size:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">sample_size</span> <span class="op">*</span> <span class="va">n_subjects</span>, units <span class="op">=</span> <span class="st">"Gb"</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Memory recommendations</span></span>
<span>  <span class="va">available_ram</span> <span class="op">&lt;-</span> <span class="fl">8</span> <span class="co"># Assume 8GB system</span></span>
<span>  <span class="va">recommended_chunks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="op">(</span><span class="va">sample_size</span> <span class="op">*</span> <span class="va">n_subjects</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">available_ram</span> <span class="op">*</span> <span class="fl">0.5</span> <span class="op">*</span> <span class="fl">1e9</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Recommended processing approach:\n"</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">recommended_chunks</span> <span class="op">&lt;=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  - Full study loading feasible\n"</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">recommended_chunks</span> <span class="op">&lt;=</span> <span class="va">n_subjects</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  - Subject-by-subject processing recommended\n"</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  - Chunked processing within subjects required\n"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">sample_data</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/gc.html" class="external-link">gc</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># diagnose_memory_issues(study_dataset)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="subject-inconsistency-issues">Subject Inconsistency Issues<a class="anchor" aria-label="anchor" href="#subject-inconsistency-issues"></a>
</h3>
<dl>
<dt><strong>Different temporal structures across subjects</strong></dt>
<dd>
This is often normal for real studies. Use subject-specific access
patterns and be explicit about which subjects you’re analyzing.
</dd>
<dt><strong>Varying voxel counts across subjects</strong></dt>
<dd>
Common due to different preprocessing pipelines. Plan analyses to handle
this variation or standardize preprocessing.
</dd>
</dl>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Handle subject inconsistencies</span></span>
<span><span class="va">handle_subject_inconsistencies</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">study_dataset</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">subject_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/subject_ids.html">subject_ids</a></span><span class="op">(</span><span class="va">study_dataset</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Catalog inconsistencies</span></span>
<span>  <span class="va">inconsistencies</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Check temporal structure</span></span>
<span>  <span class="va">temporal_info</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">subject_list</span>, <span class="kw">function</span><span class="op">(</span><span class="va">subj_id</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      TR <span class="op">=</span> <span class="fu"><a href="../reference/get_TR.html">get_TR</a></span><span class="op">(</span><span class="va">study_dataset</span>, subject_id <span class="op">=</span> <span class="va">subj_id</span><span class="op">)</span>,</span>
<span>      n_runs <span class="op">=</span> <span class="fu"><a href="../reference/n_runs.html">n_runs</a></span><span class="op">(</span><span class="va">study_dataset</span>, subject_id <span class="op">=</span> <span class="va">subj_id</span><span class="op">)</span>,</span>
<span>      n_timepoints <span class="op">=</span> <span class="fu"><a href="../reference/n_timepoints.html">n_timepoints</a></span><span class="op">(</span><span class="va">study_dataset</span>, subject_id <span class="op">=</span> <span class="va">subj_id</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span>, simplify <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Identify outliers</span></span>
<span>  <span class="va">tr_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">temporal_info</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">TR</span><span class="op">)</span></span>
<span>  <span class="va">run_counts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">temporal_info</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">n_runs</span><span class="op">)</span></span>
<span>  <span class="va">timepoint_counts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">temporal_info</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">n_timepoints</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Report inconsistencies</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">tr_values</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"TR inconsistency detected:\n"</span><span class="op">)</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">subject_list</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  "</span>, <span class="va">subject_list</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">": TR ="</span>, <span class="va">tr_values</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">run_counts</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Run count inconsistency detected:\n"</span><span class="op">)</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">subject_list</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"  "</span>, <span class="va">subject_list</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">": runs ="</span>, <span class="va">run_counts</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">"\n"</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Suggest handling strategies</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"\nSuggested handling strategies:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"- Use subject-specific processing for inconsistent parameters\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"- Consider subsetting to consistent subjects for group analyses\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"- Implement analysis methods robust to temporal differences\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># handle_subject_inconsistencies(study_dataset)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="integration-with-other-vignettes">Integration with Other Vignettes<a class="anchor" aria-label="anchor" href="#integration-with-other-vignettes"></a>
</h2>
<p>This study-level analysis guide connects to several other aspects of
the fmridataset ecosystem:</p>
<p><strong>Prerequisites</strong>: Start with <a href="fmridataset-intro.html">Getting Started</a> to understand
single-subject dataset operations before scaling to studies.</p>
<p><strong>Architecture Understanding</strong>: The <a href="architecture-overview.html">Architecture Overview</a> explains how
study datasets leverage the same abstractions as single-subject datasets
while enabling efficient scaling.</p>
<p><strong>Advanced Backend Usage</strong>: - <a href="h5-backend-usage.html">H5 Backend Usage</a> - Efficient storage
for large multi-subject studies - <a href="backend-registry.html">Backend Registry</a> - Custom backends for
specialized study organizations</p>
<p><strong>Extension Development</strong>: <a href="extending-backends.html">Extending Backends</a> shows how to
create study-aware custom backends.</p>
<p><strong>Ecosystem Integration</strong>: Study datasets work
seamlessly with other neuroimaging packages: - <strong>fmrireg</strong>:
Study-level regression modeling with temporal structure preservation -
<strong>DelayedArray</strong>: Advanced array operations for
memory-efficient cross-subject analyses - <strong>BiocParallel</strong>:
Sophisticated parallel processing strategies for large studies</p>
</div>
<div class="section level2">
<h2 id="session-information">Session Information<a class="anchor" aria-label="anchor" href="#session-information"></a>
</h2>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Bradley Buchsbaum.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
